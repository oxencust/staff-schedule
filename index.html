<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¡é»-æ’ç­ç®¡ç†ç³»çµ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --white: #ffffff;
            --gray: #808080;
            --green: #7ac19a;
            --green-light: #e8f5e9;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --purple: #a78bfa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #f5f5f5; }

        .navbar {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .navbar h1 { font-size: 20px; }
        .api-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.2);
        }
        .api-status.connected { background: rgba(255,255,255,0.3); }
        .api-status.disconnected { background: #e53e3e; }

        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab:hover { background: #f8f8f8; }
        .tab.active {
            color: var(--green);
            border-bottom-color: var(--green);
        }

        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }

        .container { max-width: 1400px; margin: 0 auto; }

        /* è¨­å®šé¢æ¿ */
        .settings-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .settings-panel h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--green-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-config {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .api-config input {
            flex: 1;
            min-width: 300px;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .api-config input:focus {
            outline: none;
            border-color: var(--green);
        }

        /* ç­åˆ¥è¨­å®š */
        .shift-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        .shift-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .shift-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .shift-item input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .shift-item input.shift-name { width: 100px; }
        .shift-item input.shift-time { width: 140px; }
        .shift-item .delete-btn {
            padding: 6px 12px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        /* å“¡å·¥åˆ—è¡¨ */
        .staff-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .staff-table th, .staff-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .staff-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--green-dark);
        }
        .staff-table tr:hover {
            background: #f8f9fa;
        }
        .staff-link {
            color: var(--green);
            text-decoration: none;
            font-size: 12px;
            word-break: break-all;
        }
        .copy-btn {
            padding: 4px 10px;
            background: var(--green-light);
            color: var(--green-dark);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }
        .availability-text {
            font-size: 12px;
            color: #666;
            max-width: 300px;
            word-break: break-all;
        }

        /* æœˆæ›† */
        .month-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .month-btn {
            padding: 10px 15px;
            border: none;
            background: var(--green);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        .month-display {
            font-size: 22px;
            font-weight: 700;
            min-width: 180px;
            text-align: center;
        }

        .calendar-wrapper {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            min-width: 700px;
        }
        .calendar-header {
            padding: 10px;
            text-align: center;
            font-weight: 700;
            background: var(--green-light);
            border-radius: 6px;
        }
        .calendar-header.weekend { background: var(--blue-light); }

        .day-cell {
            min-height: 100px;
            padding: 8px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .day-cell:hover {
            border-color: var(--green);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .day-cell.weekend { background: var(--blue-light); border-color: var(--blue); }
        .day-cell.holiday { background: var(--yellow-light); border-color: var(--yellow); }
        .day-cell.other-month { opacity: 0.4; }

        .day-number {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .holiday-name {
            font-size: 10px;
            color: #b45309;
            margin-bottom: 4px;
        }
        
        .staff-availability {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 4px;
        }
        .staff-avail-item {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .staff-avail-item.available {
            background: var(--green-light);
            color: var(--green-dark);
        }
        .staff-avail-item .shifts-info {
            font-size: 9px;
            opacity: 0.8;
        }

        /* æŒ‰éˆ• */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-primary {
            background: var(--green);
            color: white;
        }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-add {
            background: var(--green-light);
            color: var(--green-dark);
            border: 2px dashed var(--green);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--green-dark);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--green);
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-buttons .btn { flex: 1; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 2000;
            transition: transform 0.3s;
            font-weight: 500;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--gray);
        }
        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e0e0e0;
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .navbar h1 { font-size: 16px; }
            .tab { padding: 10px 15px; font-size: 14px; }
            .settings-panel { padding: 15px; }
            .api-config input { min-width: 200px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>ğŸ“‹ è¡¡é»-æ’ç­ç®¡ç†ç³»çµ±</h1>
        <span class="api-status" id="apiStatus">æœªé€£ç·š</span>
    </nav>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('settings')">âš™ï¸ ç³»çµ±è¨­å®š</div>
        <div class="tab" onclick="switchTab('staff')">ğŸ‘¥ å“¡å·¥ç®¡ç†</div>
        <div class="tab" onclick="switchTab('shifts')">ğŸ• ç­åˆ¥è¨­å®š</div>
        <div class="tab" onclick="switchTab('calendar')">ğŸ“… æ’ç­æ—¥æ›†</div>
    </div>

    <!-- ç³»çµ±è¨­å®š -->
    <div class="tab-content active" id="tab-settings">
        <div class="container">
            <div class="settings-panel">
                <h3>ğŸ”— API è¨­å®š</h3>
                <div class="api-config">
                    <input type="text" id="apiUrl" placeholder="è²¼ä¸Š Apps Script éƒ¨ç½²ç¶²å€">
                    <button class="btn btn-primary" onclick="saveApiUrl()">å„²å­˜ä¸¦é€£ç·š</button>
                    <button class="btn btn-secondary" onclick="testApi()">æ¸¬è©¦é€£ç·š</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    æ ¼å¼ï¼šhttps://script.google.com/macros/s/xxxxx/exec
                </p>
            </div>

            <div class="settings-panel">
                <h3>ğŸ“– ä½¿ç”¨èªªæ˜</h3>
                <ol style="padding-left: 20px; line-height: 2;">
                    <li>å…ˆè¨­å®š API ç¶²å€ä¸¦æ¸¬è©¦é€£ç·š</li>
                    <li>åœ¨ã€Œç­åˆ¥è¨­å®šã€æ–°å¢ç­åˆ¥ï¼ˆåˆç­ã€æ™šç­ç­‰ï¼‰</li>
                    <li>åœ¨ã€Œå“¡å·¥ç®¡ç†ã€æ–°å¢å“¡å·¥ï¼Œç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿé€£çµ</li>
                    <li>æŠŠé€£çµå‚³çµ¦å“¡å·¥ï¼Œè®“ä»–å€‘å¡«å¯«å¯ä¸Šç­æ™‚é–“</li>
                    <li>åœ¨ã€Œæ’ç­æ—¥æ›†ã€æŸ¥çœ‹å“¡å·¥å¯ä¸Šç­ç‹€æ³ä¸¦æ’ç­</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- å“¡å·¥ç®¡ç† -->
    <div class="tab-content" id="tab-staff">
        <div class="container">
            <div class="settings-panel">
                <h3>ğŸ‘¥ å“¡å·¥åˆ—è¡¨</h3>
                <button class="btn btn-add" onclick="showAddStaffModal()" style="margin-bottom: 15px;">
                    â• æ–°å¢å“¡å·¥
                </button>
                <div id="staffListContainer">
                    <div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­åˆ¥è¨­å®š -->
    <div class="tab-content" id="tab-shifts">
        <div class="container">
            <div class="settings-panel">
                <h3>ğŸ• ç­åˆ¥è¨­å®š</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                    è¨­å®šçš„ç­åˆ¥æœƒåŒæ­¥åˆ°å“¡å·¥çš„å€‹äººç«¯
                </p>
                <div class="shift-list" id="shiftList">
                    <div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div>
                </div>
                <button class="btn btn-add" onclick="addNewShift()">â• æ–°å¢ç­åˆ¥</button>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="saveShifts()">ğŸ’¾ å„²å­˜ç­åˆ¥è¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ’ç­æ—¥æ›† -->
    <div class="tab-content" id="tab-calendar">
        <div class="container">
            <div class="month-selector">
                <button class="month-btn" onclick="prevMonth()">â—€</button>
                <div class="month-display" id="monthDisplay">2025 å¹´ 1 æœˆ</div>
                <button class="month-btn" onclick="nextMonth()">â–¶</button>
                <button class="btn btn-secondary" onclick="refreshData()">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
            <div class="calendar-wrapper">
                <div class="calendar" id="calendarGrid">
                    <!-- ç”± JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢å“¡å·¥ Modal -->
    <div class="modal-overlay" id="addStaffModal">
        <div class="modal">
            <h3>â• æ–°å¢å“¡å·¥</h3>
            <div class="form-group">
                <label>å“¡å·¥å§“å</label>
                <input type="text" id="newStaffName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('addStaffModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addStaff()">æ–°å¢</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============ å…¨åŸŸè®Šæ•¸ ============
        let API_URL = '';
        let staffList = [];
        let shifts = [];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let holidays = [];

        // ============ åˆå§‹åŒ– ============
        window.onload = async function() {
            // è¼‰å…¥ API URL
            API_URL = localStorage.getItem('apiUrl') || '';
            document.getElementById('apiUrl').value = API_URL;
            
            if (API_URL) {
                await testApiConnection();
                await loadAllData();
            }
            
            // è¼‰å…¥å‡æ—¥
            holidays = await fetchHolidays(currentYear);
            generateCalendar();
        };

        // ============ Tab åˆ‡æ› ============
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
            
            if (tabId === 'calendar') {
                generateCalendar();
            }
        }

        // ============ API è¨­å®š ============
        function saveApiUrl() {
            API_URL = document.getElementById('apiUrl').value.trim();
            localStorage.setItem('apiUrl', API_URL);
            testApiConnection();
        }

        async function testApi() {
            if (!API_URL) {
                showToast('è«‹å…ˆè¼¸å…¥ API ç¶²å€');
                return;
            }
            await testApiConnection();
        }

        async function testApiConnection() {
            const status = document.getElementById('apiStatus');
            try {
                const res = await fetch(API_URL + '?action=getShifts');
                const data = await res.json();
                if (data.success) {
                    status.textContent = 'âœ“ å·²é€£ç·š';
                    status.classList.add('connected');
                    status.classList.remove('disconnected');
                    showToast('âœ… API é€£ç·šæˆåŠŸ');
                    await loadAllData();
                    return true;
                }
            } catch (e) {
                console.error(e);
            }
            status.textContent = 'âœ— é€£ç·šå¤±æ•—';
            status.classList.add('disconnected');
            status.classList.remove('connected');
            showToast('âŒ API é€£ç·šå¤±æ•—');
            return false;
        }

        async function loadAllData() {
            await loadStaff();
            await loadShifts();
        }

        // ============ å“¡å·¥ç®¡ç† ============
        async function loadStaff() {
            if (!API_URL) return;
            
            try {
                const res = await fetch(API_URL + '?action=getStaff');
                const data = await res.json();
                if (data.success) {
                    staffList = data.staff;
                    renderStaffList();
                }
            } catch (e) {
                console.error('è¼‰å…¥å“¡å·¥å¤±æ•—', e);
            }
        }

        function renderStaffList() {
            const container = document.getElementById('staffListContainer');
            
            if (staffList.length === 0) {
                container.innerHTML = '<p style="color: #666; padding: 20px;">å°šç„¡å“¡å·¥ï¼Œè«‹é»æ“Šã€Œæ–°å¢å“¡å·¥ã€</p>';
                return;
            }
            
            let html = `
                <table class="staff-table">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>æ’ç­é€£çµ</th>
                            <th>å¯ä¸Šç­æ™‚é–“</th>
                            <th>ç¸½å¤©æ•¸</th>
                            <th>é€å‡ºæ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            staffList.forEach(staff => {
                html += `
                    <tr>
                        <td><strong>${staff.name}</strong></td>
                        <td>
                            <a href="${staff.link}" target="_blank" class="staff-link">${staff.link}</a>
                            <button class="copy-btn" onclick="copyLink('${staff.link}')">è¤‡è£½</button>
                        </td>
                        <td class="availability-text">${staff.availability || 'å°šæœªå¡«å¯«'}</td>
                        <td style="text-align: center; font-weight: 600; color: var(--green);">${staff.totalDays || 0}</td>
                        <td style="font-size: 12px; color: #666;">${staff.submitTime || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" 
                                onclick="deleteStaff('${staff.name}')">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showAddStaffModal() {
            document.getElementById('newStaffName').value = '';
            document.getElementById('addStaffModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        async function addStaff() {
            const name = document.getElementById('newStaffName').value.trim();
            if (!name) {
                showToast('è«‹è¼¸å…¥å“¡å·¥å§“å');
                return;
            }
            
            if (!API_URL) {
                showToast('è«‹å…ˆè¨­å®š API');
                return;
            }
            
            try {
                // ä½¿ç”¨ GET + URL åƒæ•¸æ–¹å¼é¿å… CORS å•é¡Œ
                const payload = encodeURIComponent(JSON.stringify({ name: name }));
                const res = await fetch(API_URL + '?action=addStaff&data=' + payload);
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… å“¡å·¥å·²æ–°å¢');
                    closeModal('addStaffModal');
                    await loadStaff();
                } else {
                    showToast('âŒ ' + (data.error || 'æ–°å¢å¤±æ•—'));
                }
            } catch (e) {
                showToast('âŒ æ–°å¢å¤±æ•—');
                console.error(e);
            }
        }

        async function deleteStaff(name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å“¡å·¥ã€Œ${name}ã€å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(API_URL + '?action=deleteStaff&name=' + encodeURIComponent(name));
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… å“¡å·¥å·²åˆªé™¤');
                    await loadStaff();
                } else {
                    showToast('âŒ ' + (data.error || 'åˆªé™¤å¤±æ•—'));
                }
            } catch (e) {
                showToast('âŒ åˆªé™¤å¤±æ•—');
            }
        }

        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                showToast('âœ… å·²è¤‡è£½é€£çµ');
            });
        }

        // ============ ç­åˆ¥è¨­å®š ============
        async function loadShifts() {
            if (!API_URL) return;
            
            try {
                const res = await fetch(API_URL + '?action=getShifts');
                const data = await res.json();
                if (data.success) {
                    shifts = data.shifts;
                    renderShiftList();
                }
            } catch (e) {
                console.error('è¼‰å…¥ç­åˆ¥å¤±æ•—', e);
            }
        }

        function renderShiftList() {
            const container = document.getElementById('shiftList');
            
            if (shifts.length === 0) {
                container.innerHTML = '<p style="color: #666;">å°šç„¡ç­åˆ¥è¨­å®š</p>';
                return;
            }
            
            let html = '';
            shifts.forEach((shift, index) => {
                html += `
                    <div class="shift-item" data-index="${index}">
                        <input type="color" class="shift-color" value="${shift.color}" 
                            onchange="updateShiftColor(${index}, this.value)">
                        <input type="text" class="shift-name" value="${shift.name}" 
                            placeholder="ç­åˆ¥åç¨±" onchange="updateShiftName(${index}, this.value)">
                        <input type="text" class="shift-time" value="${shift.time}" 
                            placeholder="æ™‚æ®µ (å¦‚ 12:00-18:00)" onchange="updateShiftTime(${index}, this.value)">
                        <button class="delete-btn" onclick="deleteShift(${index})">åˆªé™¤</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function addNewShift() {
            const newId = 'shift' + (shifts.length + 1);
            shifts.push({
                id: newId,
                name: 'æ–°ç­åˆ¥',
                time: '00:00-00:00',
                color: '#9fcccc'
            });
            renderShiftList();
        }

        function updateShiftColor(index, value) { shifts[index].color = value; }
        function updateShiftName(index, value) { shifts[index].name = value; }
        function updateShiftTime(index, value) { shifts[index].time = value; }

        function deleteShift(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­åˆ¥å—ï¼Ÿ')) return;
            shifts.splice(index, 1);
            renderShiftList();
        }

        async function saveShifts() {
            if (!API_URL) {
                showToast('è«‹å…ˆè¨­å®š API');
                return;
            }
            
            try {
                // ä½¿ç”¨ GET + URL åƒæ•¸æ–¹å¼é¿å… CORS å•é¡Œ
                const payload = encodeURIComponent(JSON.stringify(shifts));
                const res = await fetch(API_URL + '?action=saveShifts&data=' + payload);
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… ç­åˆ¥è¨­å®šå·²å„²å­˜');
                } else {
                    showToast('âŒ å„²å­˜å¤±æ•—');
                }
            } catch (e) {
                showToast('âŒ å„²å­˜å¤±æ•—');
                console.error(e);
            }
        }

        // ============ æ—¥æ›† ============
        async function fetchHolidays(year) {
            // é€é Apps Script ä»£ç†å–å¾—å‡æ—¥è³‡æ–™ï¼ˆé¿å… CORSï¼‰
            if (API_URL) {
                try {
                    const res = await fetch(API_URL + '?action=getHolidays&year=' + year);
                    const data = await res.json();
                    if (data.success && data.holidays) {
                        return data.holidays;
                    }
                } catch (e) {
                    console.error('é€é API è¼‰å…¥å‡æ—¥å¤±æ•—', e);
                }
            }
            
            // å‚™ç”¨ï¼šä½¿ç”¨é è¨­å‡æ—¥
            return getDefaultHolidays(year);
        }
        
        function getDefaultHolidays(year) {
            // 2025 å¹´é è¨­å‡æ—¥
            if (year === 2025) {
                return [
                    { date: '2025-01-01', name: 'å…ƒæ—¦', isHoliday: true },
                    { date: '2025-01-28', name: 'æ˜¥ç¯€', isHoliday: true },
                    { date: '2025-01-29', name: 'æ˜¥ç¯€', isHoliday: true },
                    { date: '2025-01-30', name: 'æ˜¥ç¯€', isHoliday: true },
                    { date: '2025-01-31', name: 'æ˜¥ç¯€', isHoliday: true },
                    { date: '2025-02-01', name: 'æ˜¥ç¯€', isHoliday: true },
                    { date: '2025-02-28', name: 'å’Œå¹³ç´€å¿µæ—¥', isHoliday: true },
                    { date: '2025-04-04', name: 'æ¸…æ˜ç¯€', isHoliday: true },
                    { date: '2025-05-01', name: 'å‹å‹•ç¯€', isHoliday: true },
                    { date: '2025-05-31', name: 'ç«¯åˆç¯€', isHoliday: true },
                    { date: '2025-10-06', name: 'ä¸­ç§‹ç¯€', isHoliday: true },
                    { date: '2025-10-10', name: 'åœ‹æ…¶æ—¥', isHoliday: true }
                ];
            }
            return [];
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            document.getElementById('monthDisplay').textContent = `${currentYear} å¹´ ${currentMonth + 1} æœˆ`;
            
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let html = dayNames.map((d, i) => 
                `<div class="calendar-header ${i === 0 || i === 6 ? 'weekend' : ''}">${d}</div>`
            ).join('');
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDay = firstDay.getDay();
            
            // ä¸Šå€‹æœˆçš„æ—¥æœŸ
            const prevMonthLast = new Date(currentYear, currentMonth, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthLast.getDate() - i;
                html += `<div class="day-cell other-month"><div class="day-number">${day}</div></div>`;
            }
            
            // æœ¬æœˆæ—¥æœŸ
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const holidayInfo = holidays.find(h => h.date === dateStr);
                
                let classes = 'day-cell';
                if (isWeekend) classes += ' weekend';
                if (holidayInfo) classes += ' holiday';
                
                html += `<div class="${classes}" onclick="showDayDetail('${dateStr}')">`;
                html += `<div class="day-number">${day}</div>`;
                if (holidayInfo) {
                    html += `<div class="holiday-name">${holidayInfo.name}</div>`;
                }
                
                // é¡¯ç¤ºè©²æ—¥å¯ä¸Šç­çš„å“¡å·¥
                html += '<div class="staff-availability">';
                staffList.forEach(staff => {
                    if (staff.availability && staff.availability.includes(dateStr)) {
                        // è§£æè©²æ—¥çš„ç­åˆ¥è³‡è¨Š
                        const match = staff.availability.match(new RegExp(dateStr + '\\(([^)]+)\\)'));
                        const shiftInfo = match ? match[1] : '';
                        html += `<div class="staff-avail-item available">
                            <span>${staff.name}</span>
                            <span class="shifts-info">${shiftInfo}</span>
                        </div>`;
                    }
                });
                html += '</div>';
                
                html += '</div>';
            }
            
            // ä¸‹å€‹æœˆçš„æ—¥æœŸ
            const remainingDays = (7 - (startDay + lastDay.getDate()) % 7) % 7;
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="day-cell other-month"><div class="day-number">${day}</div></div>`;
            }
            
            grid.innerHTML = html;
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
                fetchHolidays(currentYear).then(h => { holidays = h; generateCalendar(); });
            } else {
                generateCalendar();
            }
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
                fetchHolidays(currentYear).then(h => { holidays = h; generateCalendar(); });
            } else {
                generateCalendar();
            }
        }

        async function refreshData() {
            showToast('ğŸ”„ é‡æ–°æ•´ç†ä¸­...');
            await loadAllData();
            generateCalendar();
            showToast('âœ… è³‡æ–™å·²æ›´æ–°');
        }

        function showDayDetail(dateStr) {
            // å¯ä»¥ä¹‹å¾Œæ“´å……ï¼šé»æ—¥æœŸé¡¯ç¤ºè©³ç´°è³‡è¨Šæˆ–ç›´æ¥æ’ç­
            const availableStaff = staffList.filter(s => s.availability && s.availability.includes(dateStr));
            if (availableStaff.length === 0) {
                showToast(`${dateStr} æ²’æœ‰å“¡å·¥å¯ä¸Šç­`);
            } else {
                const names = availableStaff.map(s => s.name).join('ã€');
                showToast(`${dateStr} å¯ä¸Šç­ï¼š${names}`);
            }
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
