<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¡é»-æ’ç­ç®¡ç†ç³»çµ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --white: #ffffff;
            --gray: #808080;
            --green: #7ac19a;
            --green-light: #e8f5e9;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --purple: #a78bfa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #f5f5f5; }

        .navbar {
            background: linear-gradient(135deg, var(--green), var(--green-dark));
            color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .navbar h1 { font-size: 20px; }
        .api-status { font-size: 12px; padding: 4px 10px; border-radius: 12px; background: rgba(255,255,255,0.2); }
        .api-status.connected { background: rgba(255,255,255,0.3); }
        .api-status.disconnected { background: #e53e3e; }

        .tabs { display: flex; background: white; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: var(--gray); border-bottom: 3px solid transparent; white-space: nowrap; }
        .tab:hover { background: #f8f8f8; }
        .tab.active { color: var(--green); border-bottom-color: var(--green); }

        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .container { max-width: 1400px; margin: 0 auto; }

        .settings-panel { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .settings-panel h3 { font-size: 16px; margin-bottom: 15px; color: var(--green-dark); display: flex; align-items: center; gap: 8px; }
        
        .api-config { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .api-config input { flex: 1; min-width: 300px; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .api-config input:focus { outline: none; border-color: var(--green); }

        .shift-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .shift-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid; }
        .shift-color-picker { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #ddd; cursor: pointer; padding: 0; }
        .shift-color-preview { width: 30px; height: 30px; border-radius: 6px; flex-shrink: 0; }
        .shift-item input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .shift-item input.shift-name { width: 100px; }
        .shift-item input.shift-time { width: 140px; }
        .shift-item .delete-btn { padding: 6px 12px; background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }

        .staff-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .staff-table th, .staff-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .staff-table th { background: #f8f9fa; font-weight: 600; color: var(--green-dark); }
        .staff-table tr:hover { background: #f8f9fa; }
        .staff-link { color: var(--green); text-decoration: none; font-size: 12px; word-break: break-all; }
        .copy-btn { padding: 4px 10px; background: var(--green-light); color: var(--green-dark); border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px; }
        .availability-text { font-size: 12px; color: #666; max-width: 250px; word-break: break-all; }

        .calendar-controls { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .month-selector { display: flex; align-items: center; gap: 10px; }
        .month-btn { padding: 10px 15px; border: none; background: var(--green); color: white; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .month-display { font-size: 22px; font-weight: 700; min-width: 180px; text-align: center; }
        .calendar-actions { display: flex; gap: 10px; margin-left: auto; }

        .calendar-wrapper { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-x: auto; }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; min-width: 900px; }
        .calendar-header { padding: 10px; text-align: center; font-weight: 700; background: var(--green-light); border-radius: 6px; }
        .calendar-header.weekend { background: var(--blue-light); }

        .day-cell { min-height: 120px; padding: 8px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .day-cell:hover { border-color: var(--green); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .day-cell.weekend { background: var(--blue-light); border-color: var(--blue); }
        .day-cell.holiday { background: var(--yellow-light); border-color: var(--yellow); }
        .day-cell.other-month { opacity: 0.4; }
        .day-number { font-weight: 700; font-size: 14px; margin-bottom: 6px; }
        .holiday-name { font-size: 10px; color: #b45309; margin-bottom: 4px; }
        
        .staff-availability-list { display: flex; flex-direction: column; gap: 2px; margin-top: 4px; max-height: 40px; overflow-y: auto; }
        .staff-avail-item { font-size: 9px; padding: 2px 6px; border-radius: 3px; background: var(--green-light); color: var(--green-dark); display: flex; align-items: center; gap: 4px; }
        .shift-dot { width: 8px; height: 8px; border-radius: 2px; display: inline-block; }

        .schedule-list { display: flex; flex-direction: column; gap: 2px; margin-top: 4px; }
        .schedule-item { font-size: 10px; padding: 3px 6px; border-radius: 4px; color: white; font-weight: 600; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-add { background: var(--green-light); color: var(--green-dark); border: 2px dashed var(--green); }
        .btn-export { background: var(--blue); color: white; }
        .btn-save { background: var(--pink); color: white; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal h3 { font-size: 18px; margin-bottom: 20px; color: var(--green-dark); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons .btn { flex: 1; }

        .schedule-modal-content { max-width: 600px; }
        .schedule-date-header { font-size: 16px; color: var(--gray); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #e0e0e0; }
        .staff-shift-grid { display: flex; flex-direction: column; gap: 8px; }
        .staff-shift-row { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap; }
        .staff-shift-row .staff-name { font-weight: 600; width: 80px; }
        .staff-shift-row .shift-buttons { display: flex; gap: 6px; flex-wrap: wrap; }
        .shift-toggle-btn { padding: 6px 12px; border: 2px solid; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; background: white; }
        .shift-toggle-btn.selected { color: white; }
        .shift-toggle-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .overtime-input { width: 50px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }

        .legend-bar { display: flex; gap: 15px; padding: 10px 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; }
        .legend-color { width: 16px; height: 16px; border-radius: 4px; }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 2000; transition: transform 0.3s; font-weight: 500; }
        .toast.show { transform: translateX(-50%) translateY(0); }

        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--gray); }
        .spinner { width: 30px; height: 30px; border: 3px solid #e0e0e0; border-top-color: var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>ğŸ“‹ è¡¡é»-æ’ç­ç®¡ç†ç³»çµ±</h1>
        <span class="api-status" id="apiStatus">æœªé€£ç·š</span>
    </nav>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('staff')">ğŸ‘¥ å“¡å·¥ç®¡ç†</div>
        <div class="tab" onclick="switchTab('shifts')">ğŸ• ç­åˆ¥è¨­å®š</div>
        <div class="tab" onclick="switchTab('calendar')">ğŸ“… æ’ç­æ—¥æ›†</div>
    </div>

    <div class="tab-content active" id="tab-staff">
        <div class="container">
            <div class="settings-panel">
                <h3>ğŸ‘¥ å“¡å·¥åˆ—è¡¨</h3>
                <button class="btn btn-add" onclick="showAddStaffModal()" style="margin-bottom: 15px;">â• æ–°å¢å“¡å·¥</button>
                <div id="staffListContainer"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div></div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab-shifts">
        <div class="container">
            <div class="settings-panel">
                <h3>ğŸ• ç­åˆ¥è¨­å®š</h3>
                <p style="font-size: 13px; color: #666; margin-bottom: 15px;">è¨­å®šç­åˆ¥é¡è‰²æœƒé¡¯ç¤ºåœ¨æ—¥æ›†å’Œå€‹äººç«¯</p>
                <div class="shift-list" id="shiftList"><div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­...</div></div>
                <button class="btn btn-add" onclick="addNewShift()">â• æ–°å¢ç­åˆ¥</button>
                <div style="margin-top: 15px;"><button class="btn btn-primary" onclick="saveShifts()">ğŸ’¾ å„²å­˜ç­åˆ¥è¨­å®š</button></div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab-calendar">
        <div class="container">
            <div class="calendar-controls">
                <div class="month-selector">
                    <button class="month-btn" onclick="prevMonth()">â—€</button>
                    <div class="month-display" id="monthDisplay">2025 å¹´ 1 æœˆ</div>
                    <button class="month-btn" onclick="nextMonth()">â–¶</button>
                </div>
                <div class="calendar-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">ğŸ”„ é‡æ–°æ•´ç†</button>
                    <button class="btn btn-save" onclick="saveSchedule()">ğŸ’¾ å„²å­˜æ’ç­</button>
                    <button class="btn btn-export" onclick="exportSchedule()">ğŸ“¤ åŒ¯å‡º</button>
                </div>
            </div>
            <div class="legend-bar" id="legendBar"></div>
            <div class="calendar-wrapper"><div class="calendar" id="calendarGrid"></div></div>
        </div>
    </div>

    <div class="modal-overlay" id="addStaffModal">
        <div class="modal">
            <h3>â• æ–°å¢å“¡å·¥</h3>
            <div class="form-group"><label>å“¡å·¥å§“å</label><input type="text" id="newStaffName" placeholder="è«‹è¼¸å…¥å§“å"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('addStaffModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addStaff()">æ–°å¢</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="scheduleModal">
        <div class="modal schedule-modal-content">
            <h3>ğŸ“… æ’ç­è¨­å®š</h3>
            <div class="schedule-date-header" id="scheduleDateHeader">2025-01-15 (é€±ä¸‰)</div>
            <div class="staff-shift-grid" id="staffShiftGrid"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('scheduleModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmSchedule()">ç¢ºèªæ’ç­</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============ è¨­å®šå€ ============
        const API_URL = 'https://script.google.com/macros/s/AKfycbwYXJ-tlMwjhlWoQEeJvIkU17Cw7fm0FiEXgKvHUc5fYP-fh1rSfDpw4QGH-KUdTJY/exec';
        
        let staffList = [];
        let shifts = [];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let holidays = [];
        let schedule = {};
        let currentEditingDate = null;

        window.onload = async function() {
            loadLocalSchedule();
            await loadAllData();
            holidays = await fetchHolidays(currentYear);
            generateCalendar();
            updateLegend();
            updateApiStatus();
        };
        
        async function updateApiStatus() {
            const status = document.getElementById('apiStatus');
            try {
                const res = await fetch(API_URL + '?action=getShifts');
                const data = await res.json();
                if (data.success) {
                    status.textContent = 'âœ“ å·²é€£ç·š';
                    status.classList.add('connected');
                    status.classList.remove('disconnected');
                    return;
                }
            } catch (e) {}
            status.textContent = 'âœ— é€£ç·šå¤±æ•—';
            status.classList.add('disconnected');
            status.classList.remove('connected');
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
            if (tabId === 'calendar') { generateCalendar(); updateLegend(); }
        }

        async function loadAllData() { await loadStaff(); await loadShifts(); }

        async function loadStaff() {
            if (!API_URL) return;
            try {
                const res = await fetch(API_URL + '?action=getStaff');
                const data = await res.json();
                if (data.success) { staffList = data.staff; renderStaffList(); }
            } catch (e) { console.error('è¼‰å…¥å“¡å·¥å¤±æ•—', e); }
        }

        function renderStaffList() {
            const container = document.getElementById('staffListContainer');
            if (staffList.length === 0) { container.innerHTML = '<p style="color: #666; padding: 20px;">å°šç„¡å“¡å·¥</p>'; return; }
            let html = `<table class="staff-table"><thead><tr><th>å§“å</th><th>æ’ç­é€£çµ</th><th>å¯ä¸Šç­æ™‚é–“</th><th>ç¸½å¤©æ•¸</th><th>é€å‡ºæ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody>`;
            staffList.forEach(staff => {
                html += `<tr><td><strong>${staff.name}</strong></td>
                    <td><a href="${staff.link}" target="_blank" class="staff-link">${staff.link}</a><button class="copy-btn" onclick="copyLink('${staff.link}')">è¤‡è£½</button></td>
                    <td class="availability-text">${staff.availability || 'å°šæœªå¡«å¯«'}</td>
                    <td style="text-align:center;font-weight:600;color:var(--green);">${staff.totalDays || 0}</td>
                    <td style="font-size:12px;color:#666;">${staff.submitTime || '-'}</td>
                    <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px;" onclick="deleteStaff('${staff.name}')">åˆªé™¤</button></td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showAddStaffModal() { document.getElementById('newStaffName').value = ''; document.getElementById('addStaffModal').classList.add('show'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.remove('show'); }

        async function addStaff() {
            const name = document.getElementById('newStaffName').value.trim();
            if (!name) { showToast('è«‹è¼¸å…¥å“¡å·¥å§“å'); return; }
            if (!API_URL) { showToast('è«‹å…ˆè¨­å®š API'); return; }
            try {
                const payload = encodeURIComponent(JSON.stringify({ name }));
                const res = await fetch(API_URL + '?action=addStaff&data=' + payload);
                const data = await res.json();
                if (data.success) { showToast('âœ… å“¡å·¥å·²æ–°å¢'); closeModal('addStaffModal'); await loadStaff(); }
                else { showToast('âŒ ' + (data.error || 'æ–°å¢å¤±æ•—')); }
            } catch (e) { showToast('âŒ æ–°å¢å¤±æ•—'); }
        }

        async function deleteStaff(name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(API_URL + '?action=deleteStaff&name=' + encodeURIComponent(name));
                const data = await res.json();
                if (data.success) { showToast('âœ… å“¡å·¥å·²åˆªé™¤'); await loadStaff(); }
                else { showToast('âŒ ' + (data.error || 'åˆªé™¤å¤±æ•—')); }
            } catch (e) { showToast('âŒ åˆªé™¤å¤±æ•—'); }
        }

        function copyLink(link) { navigator.clipboard.writeText(link).then(() => showToast('âœ… å·²è¤‡è£½é€£çµ')); }

        async function loadShifts() {
            if (!API_URL) return;
            try {
                const res = await fetch(API_URL + '?action=getShifts');
                const data = await res.json();
                if (data.success) { shifts = data.shifts; renderShiftList(); updateLegend(); }
            } catch (e) { console.error('è¼‰å…¥ç­åˆ¥å¤±æ•—', e); }
        }

        function renderShiftList() {
            const container = document.getElementById('shiftList');
            if (shifts.length === 0) { container.innerHTML = '<p style="color: #666;">å°šç„¡ç­åˆ¥è¨­å®š</p>'; return; }
            let html = '';
            shifts.forEach((shift, i) => {
                html += `<div class="shift-item" style="border-left-color: ${shift.color};">
                    <input type="color" class="shift-color-picker" value="${shift.color}" onchange="updateShiftColor(${i}, this.value)">
                    <div class="shift-color-preview" style="background: ${shift.color};"></div>
                    <input type="text" class="shift-name" value="${shift.name}" onchange="updateShiftName(${i}, this.value)">
                    <input type="text" class="shift-time" value="${shift.time}" onchange="updateShiftTime(${i}, this.value)">
                    <button class="delete-btn" onclick="deleteShift(${i})">åˆªé™¤</button>
                </div>`;
            });
            container.innerHTML = html;
        }

        function addNewShift() {
            const colors = ['#9fcccc', '#a78bfa', '#f2ac98', '#7ac19a', '#ffe08b', '#f472b6'];
            shifts.push({ id: 'shift' + (shifts.length + 1), name: 'æ–°ç­åˆ¥', time: '00:00-00:00', color: colors[shifts.length % colors.length] });
            renderShiftList();
        }

        function updateShiftColor(i, v) { shifts[i].color = v; renderShiftList(); }
        function updateShiftName(i, v) { shifts[i].name = v; }
        function updateShiftTime(i, v) { shifts[i].time = v; }
        function deleteShift(i) { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { shifts.splice(i, 1); renderShiftList(); } }

        async function saveShifts() {
            if (!API_URL) { showToast('è«‹å…ˆè¨­å®š API'); return; }
            try {
                const payload = encodeURIComponent(JSON.stringify(shifts));
                const res = await fetch(API_URL + '?action=saveShifts&data=' + payload);
                const data = await res.json();
                if (data.success) { showToast('âœ… ç­åˆ¥å·²å„²å­˜'); updateLegend(); }
                else { showToast('âŒ å„²å­˜å¤±æ•—'); }
            } catch (e) { showToast('âŒ å„²å­˜å¤±æ•—'); }
        }

        function updateLegend() {
            let html = `<div class="legend-item"><div class="legend-color" style="background: var(--green-light); border: 1px solid var(--green);"></div><span>å¯ä¸Šç­</span></div>`;
            shifts.forEach(s => { html += `<div class="legend-item"><div class="legend-color" style="background: ${s.color};"></div><span>${s.name}</span></div>`; });
            document.getElementById('legendBar').innerHTML = html;
        }

        async function fetchHolidays(year) {
            try {
                const res = await fetch(API_URL + '?action=getHolidays&year=' + year);
                const data = await res.json();
                if (data.success && data.holidays) {
                    console.log('å·²è¼‰å…¥ ' + year + ' å¹´å‡æ—¥ï¼š', data.holidays.length + ' ç­†');
                    return data.holidays;
                }
            } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—', e);
            }
            return [];
        }

        function generateCalendar() {
            const grid = document.getElementById('calendarGrid');
            document.getElementById('monthDisplay').textContent = `${currentYear} å¹´ ${currentMonth + 1} æœˆ`;
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            let html = dayNames.map((d, i) => `<div class="calendar-header ${i === 0 || i === 6 ? 'weekend' : ''}">${d}</div>`).join('');
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const startDay = firstDay.getDay();
            const prevMonthLast = new Date(currentYear, currentMonth, 0);
            
            for (let i = startDay - 1; i >= 0; i--) html += `<div class="day-cell other-month"><div class="day-number">${prevMonthLast.getDate() - i}</div></div>`;
            
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const holidayInfo = holidays.find(h => h.date === dateStr);
                
                let classes = 'day-cell';
                if (isWeekend) classes += ' weekend';
                if (holidayInfo) classes += ' holiday';
                
                html += `<div class="${classes}" onclick="openScheduleModal('${dateStr}')">`;
                html += `<div class="day-number">${day}</div>`;
                if (holidayInfo) html += `<div class="holiday-name">${holidayInfo.name}</div>`;
                
                html += '<div class="staff-availability-list">';
                staffList.forEach(staff => {
                    if (staff.availability && staff.availability.includes(dateStr)) {
                        const match = staff.availability.match(new RegExp(dateStr + '\\(([^)]+)\\)'));
                        const shiftInfo = match ? match[1] : 'æ•´å¤©';
                        html += `<div class="staff-avail-item"><span>${staff.name}</span><span>${renderShiftDots(shiftInfo)}</span></div>`;
                    }
                });
                html += '</div>';
                
                if (schedule[dateStr] && schedule[dateStr].length > 0) {
                    html += '<div class="schedule-list">';
                    schedule[dateStr].forEach(item => {
                        const shift = shifts.find(s => s.id === item.shiftId);
                        const color = shift ? shift.color : '#999';
                        const shiftName = shift ? shift.name : item.shiftId;
                        html += `<div class="schedule-item" style="background: ${color};">${item.staffName} - ${shiftName}${item.overtime ? ` +${item.overtime}h` : ''}</div>`;
                    });
                    html += '</div>';
                }
                html += '</div>';
            }
            
            const remainingDays = (7 - (startDay + lastDay.getDate()) % 7) % 7;
            for (let day = 1; day <= remainingDays; day++) html += `<div class="day-cell other-month"><div class="day-number">${day}</div></div>`;
            grid.innerHTML = html;
        }

        function renderShiftDots(shiftInfo) {
            if (shiftInfo === 'æ•´å¤©') return shifts.map(s => `<span class="shift-dot" style="background:${s.color};" title="${s.name}"></span>`).join('');
            return shiftInfo.split('+').map(name => {
                const shift = shifts.find(s => s.name === name);
                return `<span class="shift-dot" style="background:${shift ? shift.color : '#999'};" title="${name}"></span>`;
            }).join('');
        }

        function openScheduleModal(dateStr) {
            currentEditingDate = dateStr;
            const date = new Date(dateStr);
            const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            document.getElementById('scheduleDateHeader').textContent = `${dateStr} (é€±${dayOfWeek})`;
            
            const availableStaff = staffList.filter(s => s.availability && s.availability.includes(dateStr));
            const daySchedule = schedule[dateStr] || [];
            const grid = document.getElementById('staffShiftGrid');
            
            if (availableStaff.length === 0) { grid.innerHTML = '<p style="color:#666;padding:10px;">è©²æ—¥æ²’æœ‰å“¡å·¥å¯ä¸Šç­</p>'; }
            else {
                let html = '';
                availableStaff.forEach(staff => {
                    const match = staff.availability.match(new RegExp(dateStr + '\\(([^)]+)\\)'));
                    const availInfo = match ? match[1] : 'æ•´å¤©';
                    const canAllDay = availInfo === 'æ•´å¤©';
                    const availNames = canAllDay ? shifts.map(s => s.name) : availInfo.split('+');
                    const staffSched = daySchedule.find(s => s.staffName === staff.name);
                    
                    html += `<div class="staff-shift-row" data-staff="${staff.name}"><span class="staff-name">${staff.name}</span><div class="shift-buttons">`;
                    shifts.forEach(shift => {
                        const canWork = canAllDay || availNames.includes(shift.name);
                        const isSelected = staffSched && staffSched.shiftId === shift.id;
                        html += `<button class="shift-toggle-btn ${isSelected ? 'selected' : ''}" 
                            style="border-color:${shift.color};${isSelected ? 'background:' + shift.color : ''}"
                            data-shift-id="${shift.id}" data-staff="${staff.name}" ${canWork ? '' : 'disabled'}
                            onclick="toggleShiftBtn(this,'${shift.color}')">${shift.name}</button>`;
                    });
                    html += `</div><input type="number" class="overtime-input" data-staff="${staff.name}" value="${staffSched ? staffSched.overtime : 0}" min="0" max="8"><span style="font-size:11px;color:#666;">h</span></div>`;
                });
                grid.innerHTML = html;
            }
            document.getElementById('scheduleModal').classList.add('show');
        }

        function toggleShiftBtn(btn, color) {
            const row = btn.closest('.staff-shift-row');
            row.querySelectorAll('.shift-toggle-btn').forEach(b => { b.classList.remove('selected'); b.style.background = 'white'; });
            btn.classList.add('selected');
            btn.style.background = color;
        }

        function confirmSchedule() {
            const rows = document.querySelectorAll('#staffShiftGrid .staff-shift-row');
            const daySchedule = [];
            rows.forEach(row => {
                const staffName = row.dataset.staff;
                const selectedBtn = row.querySelector('.shift-toggle-btn.selected');
                const overtime = parseInt(row.querySelector('.overtime-input').value) || 0;
                if (selectedBtn) daySchedule.push({ staffName, shiftId: selectedBtn.dataset.shiftId, overtime });
            });
            schedule[currentEditingDate] = daySchedule;
            saveLocalSchedule();
            closeModal('scheduleModal');
            generateCalendar();
            showToast('âœ… å·²æ›´æ–°æ’ç­');
        }

        function saveLocalSchedule() { localStorage.setItem('schedule', JSON.stringify(schedule)); }
        function loadLocalSchedule() { const saved = localStorage.getItem('schedule'); if (saved) schedule = JSON.parse(saved); }
        function saveSchedule() { saveLocalSchedule(); showToast('ğŸ’¾ æ’ç­å·²å„²å­˜'); }

        async function exportSchedule() {
            if (!API_URL) { showToast('è«‹å…ˆè¨­å®š API'); return; }
            const exportData = [];
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dateStr = formatDate(date);
                const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
                const holidayInfo = holidays.find(h => h.date === dateStr);
                const daySchedule = schedule[dateStr] || [];
                daySchedule.forEach((item, idx) => {
                    const shift = shifts.find(s => s.id === item.shiftId);
                    exportData.push({ date: dateStr, dayOfWeek, holiday: holidayInfo?.name || '', staffName: item.staffName, shiftName: shift?.name || '', shiftTime: shift?.time || '', overtime: item.overtime || 0, isFirst: idx === 0 });
                });
            }
            if (exportData.length === 0) { showToast('æ²’æœ‰æ’ç­è³‡æ–™'); return; }
            try {
                const payload = encodeURIComponent(JSON.stringify({ year: currentYear, month: currentMonth + 1, data: exportData }));
                const res = await fetch(API_URL + '?action=exportSchedule&data=' + payload);
                const data = await res.json();
                showToast(data.success ? 'âœ… å·²åŒ¯å‡ºåˆ° Sheets' : 'âŒ åŒ¯å‡ºå¤±æ•—');
            } catch (e) { showToast('âŒ åŒ¯å‡ºå¤±æ•—'); }
        }

        function prevMonth() { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; fetchHolidays(currentYear).then(h => { holidays = h; generateCalendar(); }); } else generateCalendar(); }
        function nextMonth() { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; fetchHolidays(currentYear).then(h => { holidays = h; generateCalendar(); }); } else generateCalendar(); }
        async function refreshData() { showToast('ğŸ”„ é‡æ–°æ•´ç†...'); await loadAllData(); holidays = await fetchHolidays(currentYear); generateCalendar(); showToast('âœ… å·²æ›´æ–°'); }

        function formatDate(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
    </script>
</body>
</html>
