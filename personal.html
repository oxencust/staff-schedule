<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡¡é»-å€‹äººæ’ç­ç³»çµ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --white: #ffffff;
            --gray: #808080;
            --green: #7ac19a;
            --green-light: #e2ede6;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --pink-dark: #c67566;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --yellow-dark: #ba9e60;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --blue-dark: #66888e;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #f8f9fa; 
            color: #2d3748; 
            padding-bottom: 20px;
            overflow-x: hidden;
        }
        
        .loading-screen { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: linear-gradient(135deg, var(--pink-light), var(--blue-light)); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
        }
        .loading-screen.hidden { display: none; }
        .loading-spinner { 
            width: 60px; height: 60px; 
            border: 4px solid var(--pink-light); 
            border-top-color: var(--pink); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .navbar { 
            background: linear-gradient(135deg, var(--pink), var(--pink-dark)); 
            padding: 16px 20px; 
            color: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .navbar h1 { font-size: 18px; margin-bottom: 6px; }
        .navbar p { font-size: 14px; opacity: 0.95; line-height: 1.6; }
        .staff-name {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        .info-card { 
            background: white;
            border-radius: 10px; 
            padding: 12px 15px; 
            margin-bottom: 15px; 
            border-left: 3px solid var(--pink);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .info-card h3 { font-size: 13px; color: var(--pink-dark); margin-bottom: 6px; }
        .info-card ul { margin-top: 6px; padding-left: 16px; }
        .info-card li { font-size: 11px; line-height: 1.5; color: #2d3748; margin-bottom: 2px; }

        .control-panel { 
            background: white; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        
        .month-selector { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .month-btn { 
            width: 40px; height: 40px; 
            border-radius: 10px; 
            border: none; 
            background: var(--pink); 
            color: white; 
            font-size: 18px; 
            cursor: pointer; 
        }
        .month-btn:active { transform: scale(0.95); background: var(--pink-dark); }
        .month-display { font-size: 20px; font-weight: 700; text-align: center; min-width: 150px; }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .stat-card { 
            background: white; 
            border-radius: 10px; 
            padding: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            border-left: 3px solid;
            text-align: center;
        }
        .stat-card.pink { border-left-color: var(--pink); }
        .stat-card.yellow { border-left-color: var(--yellow); }
        .stat-card.gray { border-left-color: var(--gray); }
        .stat-label { font-size: 11px; color: var(--gray); margin-bottom: 6px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-card.pink .stat-value { color: var(--pink); }
        .stat-card.yellow .stat-value { color: var(--yellow-dark); }
        .stat-card.gray .stat-value { color: var(--gray); }

        .legend { 
            background: white; 
            border-radius: 8px; 
            padding: 12px 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        .legend h4 { font-size: 12px; margin-bottom: 8px; color: var(--pink-dark); }
        .legend-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minimin(90px, 1fr)); 
            gap: 6px; 
        }
        .legend-item { 
            display: flex; align-items: center; gap: 6px; 
            padding: 6px 8px; background: #f8f9fa; border-radius: 5px; 
        }
        .legend-box { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }
        .legend-box.available { background: var(--pink); }
        .legend-box.not-selected { background: white; border: 2px solid #e9ecef; }
        .legend-box.weekend { background: var(--blue-light); border: 2px solid var(--blue); }
        .legend-box.holiday { background: var(--yellow-light); border: 2px solid var(--yellow); }
        .legend-label { font-size: 10px; font-weight: 600; }

        .calendar-container { 
            background: white; 
            border-radius: 12px; 
            padding: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            overflow-x: auto;
        }
        
        .calendar-header { 
            display: grid; 
            grid-template-columns: 50px repeat(7, 1fr); 
            gap: 2px; 
            margin-bottom: 8px; 
        }
        .calendar-header-cell { 
            text-align: center; 
            padding: 8px 4px; 
            font-weight: 700; 
            font-size: 12px;
            background: var(--pink-light); 
            border-radius: 6px; 
        }
        .calendar-header-cell:first-child { background: transparent; }
        .calendar-header-cell.weekend { background: var(--blue-light); color: var(--blue-dark); }

        .week-row { 
            display: grid; 
            grid-template-columns: 50px repeat(7, 1fr); 
            gap: 2px; 
            margin-bottom: 2px; 
        }
        .week-label { 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 600; font-size: 11px; color: var(--gray); 
            background: #f8f9fa; border-radius: 6px; 
        }

        .day-cell { 
            min-height: 70px; 
            padding: 6px; 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s;
        }
        .day-cell:active { transform: scale(0.98); }
        .day-cell.weekend { background: var(--blue-light); border-color: var(--blue); }
        .day-cell.holiday { background: var(--yellow-light); border-color: var(--yellow); }
        .day-cell.today { border-color: var(--pink); border-width: 3px; box-shadow: 0 0 0 1px var(--pink); }
        
        /* å¯ä¸Šç­æ¨£å¼ */
        .day-cell.available { background: var(--pink); border-color: var(--pink-dark); }
        .day-cell.available .day-number { color: white; }
        .day-cell.available .status-label { color: white; opacity: 0.9; }

        .shift-badges { display: flex; gap: 3px; margin-top: 4px; flex-wrap: wrap; }
        .shift-badge { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600; }
        .day-cell.available .shift-badge { background: rgba(255,255,255,0.3); color: white; }

        .day-header { display: flex; align-items: flex-start; gap: 4px; margin-bottom: 3px; }
        .day-number { font-size: 14px; font-weight: 700; }
        .day-cell.weekend .day-number { color: var(--blue-dark); }
        .day-cell.holiday .day-number { color: var(--yellow-dark); }
        .status-label { font-size: 10px; font-weight: 600; display: block; }
        .holiday-label { color: var(--yellow-dark); }
        .weekend-label { color: var(--blue-dark); }
        .available-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }

        /* Modal */
        .shift-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1500;
            align-items: center; justify-content: center;
        }
        .shift-modal.show { display: flex; }
        .shift-modal-content {
            background: white; border-radius: 16px; padding: 20px;
            max-width: 90%; width: 320px; max-height: 80vh; overflow-y: auto;
        }
        .shift-modal-header { font-size: 16px; font-weight: 700; color: var(--pink-dark); margin-bottom: 8px; }
        .shift-modal-date { font-size: 14px; color: var(--gray); margin-bottom: 16px; }
        .shift-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
        .shift-option {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border: 2px solid #e9ecef; border-radius: 10px; cursor: pointer;
            border-left-width: 5px;
        }
        .shift-option:active { transform: scale(0.98); }
        .shift-option.selected { border-color: var(--pink); background: var(--pink-light); }
        .shift-option-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--gray);
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .shift-option.selected .shift-option-checkbox { background: var(--pink); border-color: var(--pink); }
        .shift-option.selected .shift-option-checkbox::after { content: 'âœ“'; color: white; font-weight: 700; }
        .shift-option-label { flex: 1; }
        .shift-option-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .shift-option-time { font-size: 11px; color: var(--gray); }
        .shift-option-color { width: 20px; height: 20px; border-radius: 4px; flex-shrink: 0; }
        
        /* å…¶ä»–ç­åˆ¥è‡ªè¨‚æ™‚é–“ */
        .custom-shift-inputs { display: none; margin-top: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; }
        .custom-shift-inputs.show { display: block; }
        .custom-time-row { display: flex; align-items: center; gap: 8px; }
        .custom-time-input { flex: 1; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; text-align: center; font-family: monospace; }
        .custom-time-input:focus { outline: none; border-color: var(--pink); }
        .custom-time-separator { font-weight: 600; color: #666; }
        .shift-modal-buttons { display: flex; gap: 8px; }
        .shift-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .shift-modal-btn.cancel { background: #e9ecef; color: #495057; }
        .shift-modal-btn.confirm { background: var(--pink); color: white; }

        .submit-section { display: flex; gap: 10px; margin-top: 15px; }
        .btn { 
            flex: 1; padding: 14px; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--pink); color: white; }
        .btn-secondary { background: var(--green-light); color: var(--green-dark); }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: 700; color: var(--pink-dark); margin-bottom: 16px; }
        .date-list { max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px; }
        .date-item { padding: 8px 12px; margin-bottom: 6px; background: white; border-radius: 6px; border-left: 3px solid var(--pink); font-size: 13px; }
        .modal-summary { font-size: 14px; padding: 12px; background: var(--pink-light); border-radius: 8px; margin-bottom: 16px; color: var(--pink-dark); font-weight: 600; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .modal-btn-confirm { background: var(--pink); color: white; }
        .modal-btn-cancel { background: #e9ecef; color: #495057; }

        .toast { 
            position: fixed; bottom: 20px; left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: #2d3748; color: white; padding: 12px 18px; 
            border-radius: 10px; z-index: 2000; transition: transform 0.3s; 
            font-weight: 500; max-width: 90%;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        .api-setup {
            background: var(--yellow-light); border: 2px solid var(--yellow);
            border-radius: 10px; padding: 15px; margin-bottom: 15px;
        }
        .api-setup h3 { font-size: 14px; color: var(--yellow-dark); margin-bottom: 10px; }
        .api-setup input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .api-setup .btn { width: 100%; }

        /* ========== æ‰‹æ©Ÿç‰ˆå„ªåŒ– ========== */
        @media (min-width: 768px) {
            .navbar h1 { font-size: 20px; }
            .month-display { font-size: 24px; min-width: 200px; }
            .day-cell { min-height: 80px; padding: 8px; }
            .modal { max-width: 500px; }
            .container { padding-bottom: 20px; }
        }

        @media (max-width: 767px) {
            .navbar { padding: 12px 15px; }
            .navbar h1 { font-size: 17px; }
            
            .container { padding: 10px; }
            
            /* æ§åˆ¶é¢æ¿ */
            .control-panel { padding: 12px; border-radius: 10px; margin-bottom: 10px; }
            .staff-name-display { font-size: 14px; }
            .staff-name { font-size: 16px; }
            
            /* æœˆä»½é¸æ“‡å™¨ */
            .month-selector { margin-bottom: 10px; }
            .month-btn { padding: 10px 14px; font-size: 16px; min-width: 44px; }
            .month-display { font-size: 18px; min-width: 140px; }
            
            /* çµ±è¨ˆå€ */
            .stats-bar { padding: 10px; gap: 8px; margin-bottom: 10px; }
            .stat-item { padding: 8px 12px; }
            .stat-value { font-size: 18px; }
            .stat-label { font-size: 10px; }
            
            /* æ—¥æ›† */
            .calendar-wrapper { padding: 8px; border-radius: 10px; }
            .calendar { gap: 3px; }
            .calendar-header { padding: 8px 2px; font-size: 13px; font-weight: 600; }
            .day-cell { 
                min-height: 55px; 
                padding: 4px; 
                border-radius: 6px;
                -webkit-tap-highlight-color: transparent;
            }
            .day-cell:active { transform: scale(0.95); }
            .day-number { font-size: 13px; font-weight: 700; }
            .holiday-name { font-size: 8px; margin-top: 1px; }
            .shift-badges { gap: 2px; margin-top: 2px; }
            .shift-badge { font-size: 8px; padding: 1px 4px; }
            
            /* åº•éƒ¨æŒ‰éˆ• */
            .submit-section {
                background: white;
                padding: 12px 15px;
                margin-top: 15px;
            }
            .btn-submit { 
                padding: 14px 20px; 
                font-size: 16px; 
                border-radius: 12px;
                width: 100%;
            }
            
            /* Modal å„ªåŒ– */
            .modal-overlay { align-items: flex-end; }
            .modal { 
                max-width: 100%; 
                width: 100%; 
                border-radius: 20px 20px 0 0; 
                max-height: 80vh; 
                padding: 20px 15px 30px;
            }
            .modal h3 { font-size: 18px; text-align: center; }
            .modal-date { font-size: 14px; }
            
            /* ç­åˆ¥é¸é … */
            .shift-options-container { gap: 8px; }
            .shift-option { 
                padding: 14px 12px; 
                border-radius: 10px;
                -webkit-tap-highlight-color: transparent;
            }
            .shift-option:active { transform: scale(0.98); }
            .shift-option-checkbox { width: 22px; height: 22px; }
            .shift-option-title { font-size: 15px; }
            .shift-option-time { font-size: 12px; }
            
            .modal-buttons { gap: 10px; margin-top: 15px; }
            .modal-buttons .btn { 
                padding: 14px 20px; 
                font-size: 15px; 
                border-radius: 10px;
                min-height: 48px;
            }
            
            /* ç¢ºèª Modal */
            .confirm-content { padding: 15px; }
            .confirm-content p { font-size: 14px; line-height: 1.6; }
        }

        @media (max-width: 374px) {
            .navbar h1 { font-size: 15px; }
            .month-display { font-size: 16px; min-width: 120px; }
            .month-btn { padding: 8px 12px; font-size: 14px; }
            .day-cell { min-height: 50px; padding: 3px; }
            .day-number { font-size: 12px; }
            .holiday-name { font-size: 7px; }
            .shift-badge { font-size: 7px; padding: 1px 3px; }
            .stat-value { font-size: 16px; }
            .stat-label { font-size: 9px; }
            .shift-option { padding: 12px 10px; }
            .shift-option-title { font-size: 14px; }
        }

        /* è§¸æ§å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            .day-cell:hover { border-color: inherit; box-shadow: none; }
            .day-cell.available:hover { border-color: var(--pink); }
            .month-btn:hover { background: var(--pink); }
            .btn:hover { filter: none; }
        }

        /* ğŸ†• çµ±è¨ˆå€åŸŸæ¨£å¼ */
        .stats-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .stats-panel h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--green-dark);
        }
        .stats-card .stats-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
        }
        .stats-card .stats-label {
            color: #666;
        }
        .stats-card .stats-value {
            font-weight: 600;
            color: #333;
        }
        .stats-card .stats-value.highlight {
            color: var(--green);
            font-size: 15px;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div style="margin-top: 20px; font-weight: 600; font-size: 14px;">æ­£åœ¨è¼‰å…¥...</div>
    </div>

    <div class="main-content" id="mainContent" style="display:none;">
        <nav class="navbar">
            <h1>ğŸ“‹ è¡¡é»-å€‹äººæ’ç­ç³»çµ±</h1>
            <p id="staffNameDisplay">è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ</p>
        </nav>

        <div class="container">
            <!-- å›å¡«æ¨¡å¼æç¤ºæ¢ -->
            <div id="overtimeModeBar" style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                <div style="font-weight: 600; margin-bottom: 5px;">ğŸ“‹ åŠ ç­å›å¡«æ¨¡å¼</div>
                <div style="font-size: 12px; opacity: 0.9;">é»é¸æ—¥æ›†ä¸Šçš„æ—¥æœŸå›å¡«åŠ ç­æ™‚é–“</div>
            </div>
            
            <div class="control-panel">
                <div class="month-selector">
                    <button class="month-btn" onclick="previousMonth()">â—€</button>
                    <div class="month-display" id="monthDisplay">2025 å¹´ 1 æœˆ</div>
                    <button class="month-btn" onclick="nextMonth()">â–¶</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card pink">
                        <div class="stat-label">å¯ä¸Šç­å¤©æ•¸</div>
                        <div class="stat-value" id="availableCount">0</div>
                    </div>
                    <div class="stat-card pink">
                        <div class="stat-label">å¯ä¸Šç­æ™‚æ•¸</div>
                        <div class="stat-value" id="availableHours">0</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-label">åœ‹å®šå‡æ—¥</div>
                        <div class="stat-value" id="holidayCount">0</div>
                    </div>
                    <div class="stat-card gray">
                        <div class="stat-label">æœªæ¨™è¨˜</div>
                        <div class="stat-value" id="unmarkedCount">0</div>
                    </div>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar">
                    <div class="calendar-header">
                        <div class="calendar-header-cell"></div>
                        <div class="calendar-header-cell weekend">æ—¥</div>
                        <div class="calendar-header-cell">ä¸€</div>
                        <div class="calendar-header-cell">äºŒ</div>
                        <div class="calendar-header-cell">ä¸‰</div>
                        <div class="calendar-header-cell">å››</div>
                        <div class="calendar-header-cell">äº”</div>
                        <div class="calendar-header-cell weekend">å…­</div>
                    </div>
                    <div id="calendarBody"></div>
                </div>
            </div>

            <div class="submit-section">
                <!-- å›å¡«åŠ ç­æŒ‰éˆ•ï¼ˆ1-8è™Ÿé¡¯ç¤ºï¼Œéå›å¡«æ¨¡å¼æ™‚ï¼‰ -->
                <div id="overtimeEntryBtn" style="display: none; margin-bottom: 10px;">
                    <button class="btn" onclick="enterOvertimeMode()" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px; font-weight: 600;">
                        ğŸ“‹ å›å¡«ä¸ŠæœˆåŠ ç­æ™‚é–“
                    </button>
                </div>
                <!-- å®Œæˆå›å¡«æŒ‰éˆ•ï¼ˆå›å¡«æ¨¡å¼æ™‚é¡¯ç¤ºï¼‰ -->
                <div id="overtimeExitBtn" style="display: none;">
                    <button class="btn" onclick="exitOvertimeMode()" style="width: 100%; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; font-weight: 600;">
                        âœ“ å®Œæˆå›å¡«ï¼Œè¿”å›æ’ç­
                    </button>
                </div>
                <!-- æ­£å¸¸æ¨¡å¼æŒ‰éˆ• -->
                <div id="normalModeButtons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="clearAll()" style="flex: 1; min-width: 80px;">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <button class="btn btn-secondary" onclick="showLeaveModal()" style="flex: 1; min-width: 100px; background: #f3f4f6; color: #6b7280;">ğŸ“ è«‹å‡</button>
                    <button class="btn btn-primary btn-submit" onclick="showConfirmModal()" style="flex: 2; min-width: 120px;">âœ… é€å‡º</button>
                </div>
            </div>

            <!-- è«‹å‡è¨˜éŒ„å€å¡Š -->
            <div class="info-card" style="margin-top: 15px;" id="leaveRecordsCard">
                <h3>ğŸ“ æˆ‘çš„è«‹å‡è¨˜éŒ„</h3>
                <div id="leaveRecordsContainer" style="margin-top: 10px;">
                    <p style="color: #999; font-size: 13px;">è¼‰å…¥ä¸­...</p>
                </div>
            </div>

            <div class="info-card" style="margin-top: 15px;">
                <h3>ğŸ’¡ ä½¿ç”¨èªªæ˜</h3>
                <ul>
                    <li>é»æ“Šæ—¥æœŸé¸æ“‡ã€Œå¯ä»¥ä¸Šç­ã€çš„æ™‚æ®µ</li>
                    <li>å¦‚æœæ•´å¤©éƒ½å¯ä»¥ä¸Šç­,é¸æ“‡ã€Œæ•´å¤©å¯ä¸Šç­ã€</li>
                    <li>å®Œæˆå¾Œé»æ“Šã€Œé€å‡ºã€æŒ‰éˆ•</li>
                </ul>
            </div>

            <div class="legend" style="margin-top: 10px;">
                <h4>ğŸ¨ ç‹€æ…‹èªªæ˜</h4>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-box available"></div>
                        <span class="legend-label">å¯ä¸Šç­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box not-selected"></div>
                        <span class="legend-label">æœªæ¨™è¨˜</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box weekend"></div>
                        <span class="legend-label">é€±æœ«</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box holiday"></div>
                        <span class="legend-label">å‡æ—¥</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="shift-modal" id="shiftModal">
        <div class="shift-modal-content">
            <div class="shift-modal-header">âœ… é¸æ“‡å¯ä¸Šç­çš„æ™‚æ®µ</div>
            <div class="shift-modal-date" id="shiftModalDate">2025-01-15 (é€±äº”)</div>
            <div class="shift-options" id="shiftOptionsContainer"></div>
            <div class="shift-modal-buttons">
                <button class="shift-modal-btn cancel" onclick="closeShiftModal()">å–æ¶ˆ</button>
                <button class="shift-modal-btn confirm" onclick="confirmShiftSelection()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">ğŸ“‹ ç¢ºèªé€å‡º</div>
            <div class="modal-content">
                <div class="modal-summary" id="modalSummary">å…± 0 å¤©å¯ä»¥ä¸Šç­</div>
                <div class="date-list" id="dateList"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmSubmit()">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <!-- ğŸ†• çµ±è¨ˆå€åŸŸ -->
            <div class="stats-panel" style="margin-top: 20px;">
                <h3>ğŸ“Š æœ¬æœˆçµ±è¨ˆ</h3>
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <!-- çµ±è¨ˆå¡ç‰‡ 1ï¼šæˆ‘çš„å¯ä¸Šç­æ™‚æ®µ -->
                    <div id="myAvailabilityStats" class="stats-card" style="background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 10px; padding: 15px;">
                        <div class="staff-name" style="font-weight: 700; font-size: 16px; color: #1e40af; margin-bottom: 10px;">ğŸ“ æˆ‘å¡«å¯«çš„å¯ä¸Šç­æ™‚æ®µ</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">ï¼ˆæˆ‘å‹¾é¸æƒ³ä¸Šç­çš„æ™‚æ®µçµ±è¨ˆï¼‰</div>
                        <div id="myAvailabilityStatsContent"></div>
                    </div>

                    <!-- çµ±è¨ˆå¡ç‰‡ 2ï¼šç®¡ç†ç«¯å¯¦éš›æ’ç­ -->
                    <div id="actualScheduleStats" class="stats-card" style="background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 10px; padding: 15px;">
                        <div class="staff-name" style="font-weight: 700; font-size: 16px; color: #047857; margin-bottom: 10px;">ğŸ“… ç®¡ç†ç«¯å¯¦éš›æ’ç­</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">ï¼ˆç®¡ç†å“¡å¯¦éš›æ’çµ¦æˆ‘çš„ç­ï¼‰</div>
                        <div id="actualScheduleStatsContent"></div>
                    </div>
                </div>
            </div>

    <!-- è«‹å‡ç”³è«‹ Modal -->
    <div class="modal-overlay" id="leaveModal">
        <div class="modal" style="max-width: 380px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #9ca3af, #6b7280); color: white;">
                ğŸ“ è«‹å‡ç”³è«‹
            </div>
            <div class="modal-content" style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">è«‹å‡æ—¥æœŸ</label>
                    <input type="date" id="leaveDateInput" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                </div>
                <div id="leaveOriginalShift" style="font-size: 13px; color: #666; margin-bottom: 15px; padding: 10px; background: #f3f4f6; border-radius: 8px; display: none;">
                    åŸç­åˆ¥ï¼š<span id="leaveShiftName">-</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">å‡åˆ¥</label>
                    <select id="leaveTypeSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">è«‹å‡æ™‚æ•¸</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="leaveHoursInput" value="8" min="0.5" max="8" step="0.5" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                        <span style="color: #666;">å°æ™‚</span>
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">æ•´å¤©è«‹å‡å¡« 8ï¼ŒåŠå¤©å¡« 4</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 13px; color: #666; margin-bottom: 5px;">è«‹å‡åŸå› ï¼ˆé¸å¡«ï¼‰</label>
                    <textarea id="leaveReasonInput" rows="2" placeholder="ä¾‹å¦‚ï¼šå®¶ä¸­æœ‰äº‹" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: none;"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeLeaveModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="submitLeaveRequest()">é€å‡ºç”³è«‹</button>
            </div>
        </div>
    </div>

    <!-- åŠ ç­å›å¡«æé†’ Modal -->
    <div class="modal-overlay" id="overtimeReminderModal">
        <div class="modal" style="max-width: 380px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                âš ï¸ åŠ ç­å›å¡«æé†’
            </div>
            <div class="modal-content" style="padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                <div style="font-size: 15px; margin-bottom: 15px; line-height: 1.6;">
                    è«‹æ–¼ <strong style="color: #dc2626;">8 è™Ÿå‰</strong>å›å¡«ä¸ŠæœˆåŠ ç­æ™‚é–“<br>
                    <span style="color: #dc2626; font-weight: 600;">é€¾æ™‚ä¸å€™ï¼</span>
                </div>
                <div style="font-size: 13px; color: #666; background: #f3f4f6; padding: 12px; border-radius: 8px;">
                    è«‹åœ¨æ—¥æ›†ä¸Šé»é¸æœ‰åŠ ç­çš„æ—¥æœŸé€²è¡Œå›å¡«<br>
                    ï¼ˆåŒ…å«è‡¨æ™‚ä¸Šç­ï¼‰
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" onclick="confirmOvertimeReminder()" style="width: 100%;">æˆ‘çŸ¥é“äº†ï¼Œé–‹å§‹å›å¡«</button>
            </div>
        </div>
    </div>

    <!-- å–®ç­†åŠ ç­å›å¡« Modal -->
    <div class="modal-overlay" id="overtimeFillModal">
        <div class="modal" style="max-width: 350px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                â° å›å¡«åŠ ç­æ™‚é–“
            </div>
            <div class="modal-content" style="padding: 15px;">
                <div id="overtimeFillDate" style="font-size: 16px; font-weight: 600; margin-bottom: 15px; text-align: center;"></div>
                <div id="overtimeFillShift" style="font-size: 13px; color: #666; margin-bottom: 15px; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;"></div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 8px;">åŠ ç­æ™‚é–“</label>
                    <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                        <select id="overtimeFillStart" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100px;"></select>
                        <span style="color: #666;">è‡³</span>
                        <select id="overtimeFillEnd" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100px;"></select>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 8px;">å‚™è¨»</label>
                    <input type="text" id="overtimeFillNote" placeholder="é¸å¡«ï¼Œå¯å¡«åŠ ç­åŸå› " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeOvertimeFillModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="submitSingleOvertime()">é€å‡ºç”³è«‹</button>
            </div>
        </div>
    </div>

    <!-- èˆŠçš„åŠ ç­å›å¡« Modal ä¿ç•™ä½†éš±è— -->
    <div class="modal-overlay" id="overtimeModal" style="display:none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                â° å›å¡«ä¸ŠæœˆåŠ ç­æ™‚é–“
            </div>
            <div class="modal-content" style="padding: 15px;">
                <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 13px; color: #92400e;">
                    âš ï¸ è«‹æ–¼ <strong>8 è™Ÿå‰</strong>å®Œæˆå›å¡«ï¼Œé€¾æ™‚ä¸å€™ï¼
                </div>
                <div id="overtimeList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeOvertimeModal()">ç¨å¾Œå¡«å¯«</button>
                <button class="modal-btn modal-btn-confirm" onclick="submitOvertime()">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============ å¿«å–å·¥å…·å‡½æ•¸ ============
        
        /**
         * è¨­å®šå¿«å–
         * @param {string} key - å¿«å–éµå
         * @param {any} data - è¦å¿«å–çš„è³‡æ–™
         * @param {number} days - å¿«å–å¤©æ•¸
         */
        function setCache(key, data, days) {
            try {
                const item = {
                    data: data,
                    expiry: Date.now() + (days * 24 * 60 * 60 * 1000)
                };
                localStorage.setItem(key, JSON.stringify(item));
            } catch (e) {
                console.warn('å¿«å–å„²å­˜å¤±æ•—:', e);
            }
        }
        
        /**
         * å–å¾—å¿«å–
         * @param {string} key - å¿«å–éµå
         * @returns {any|null} - å¿«å–è³‡æ–™ï¼ŒéæœŸæˆ–ä¸å­˜åœ¨å‰‡è¿”å› null
         */
        function getCache(key) {
            try {
                const itemStr = localStorage.getItem(key);
                if (!itemStr) return null;
                
                const item = JSON.parse(itemStr);
                
                // æª¢æŸ¥æ˜¯å¦éæœŸ
                if (Date.now() > item.expiry) {
                    localStorage.removeItem(key);
                    return null;
                }
                
                return item.data;
            } catch (e) {
                console.warn('å¿«å–è®€å–å¤±æ•—:', e);
                return null;
            }
        }
        
        /**
         * æ¸…é™¤æŒ‡å®šå¿«å–
         * @param {string} key - å¿«å–éµå
         */
        function clearCache(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.warn('å¿«å–æ¸…é™¤å¤±æ•—:', e);
            }
        }
        
        // ============ è¨­å®šå€ ============
        const API_URL = 'https://script.google.com/macros/s/AKfycbx3xZUad_crhjKLsjp_DOfGrxtxynNCSYVb7lgtbOfB8jlf8mEKbF-6avvwFXTv5LL_HA/exec';
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let holidays = [];
        let availableDates = {};
        let staffName = '';
        let currentEditingDate = null;
        let shifts = [];
        
        // åŠ ç­å›å¡«ç›¸é—œ
        let isOvertimeMode = false;
        let lastMonthSchedules = {};
        let currentOvertimeDate = null;
        let currentMonthSchedules = {};

        // âš¡ ä¸¦è¡Œè¼‰å…¥å„ªåŒ–
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            staffName = urlParams.get('name') || urlParams.get('staff') || '';
            
            if (!staffName) {
                document.getElementById('staffNameDisplay').innerHTML = 'âš ï¸ è«‹å¾ç®¡ç†å“¡æä¾›çš„é€£çµé€²å…¥';
            } else {
                document.getElementById('staffNameDisplay').innerHTML = 
                    `<span class="staff-name">${staffName}</span> è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ`;
            }
            
            // âš¡ ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼ˆé€Ÿåº¦æå‡ 60-70%ï¼‰
            const [shiftsData, holidaysData, savedData] = await Promise.all([
                loadShifts(),
                fetchHolidays(currentYear),
                staffName ? loadSavedAvailability() : Promise.resolve(false)
            ]);
            
            holidays = holidaysData;
            
            if (!savedData) {
                loadLocalData();
            }
            
            // è¼‰å…¥ç•¶æœˆæ’ç­è³‡æ–™
            if (staffName) {
                await loadCurrentMonthSchedule();
            }
            
            generateCalendar();
            updateStats();
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').style.display = 'block';
            
            if (staffName) {
                // é€™å…©å€‹ä¸å½±éŸ¿é¦–å±ï¼Œå¯ä»¥å»¶å¾ŒåŸ·è¡Œ
                checkOvertimeReminder();
                loadMyLeaveRecords();
            }
        };
        
        // ============ è«‹å‡åŠŸèƒ½ ============
        let myLeaveRecords = [];
        let myLeaveQuota = null;
        
        async function loadMyLeaveRecords() {
            if (!API_URL || !staffName) return;
            
            try {
                const year = new Date().getFullYear();
                const res = await fetch(API_URL + '?action=getMyLeaveRecords&staff=' + encodeURIComponent(staffName) + '&year=' + year);
                const data = await res.json();
                
                if (data.success) {
                    myLeaveRecords = data.records || [];
                    renderLeaveRecords();
                }
            } catch (e) {
                console.error('è¼‰å…¥è«‹å‡è¨˜éŒ„å¤±æ•—', e);
            }
        }
        
        function renderLeaveRecords() {
            const container = document.getElementById('leaveRecordsContainer');
            
            if (myLeaveRecords.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 13px; text-align: center;">ç›®å‰æ²’æœ‰è«‹å‡è¨˜éŒ„</p>';
                return;
            }
            
            let html = '';
            myLeaveRecords.forEach(record => {
                let statusColor = '#f59e0b';
                let statusText = record.status;
                if (record.status === 'å·²é€šé') {
                    statusColor = '#10b981';
                } else if (record.status === 'å·²æ‹’çµ•') {
                    statusColor = '#ef4444';
                }
                
                const leaveIcon = getLeaveIcon(record.leaveType);
                
                html += `<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px;">
                    <div>
                        <div style="font-weight: 600; font-size: 14px;">${record.date}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">${leaveIcon} ${record.leaveType} ${record.hours}å°æ™‚</div>
                        ${record.shiftName ? `<div style="font-size: 11px; color: #999; margin-top: 2px;">åŸç­åˆ¥ï¼š${record.shiftName}</div>` : ''}
                    </div>
                    <span style="background: ${statusColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${statusText}</span>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        function showLeaveModal() {
            const today = new Date();
            const dateStr = formatDate(today);
            document.getElementById('leaveDateInput').value = dateStr;
            document.getElementById('leaveHoursInput').value = '8';
            document.getElementById('leaveReasonInput').value = '';
            document.getElementById('leaveOriginalShift').style.display = 'none';
            
            checkLeaveDate(dateStr);
            
            document.getElementById('leaveModal').classList.add('show');
        }
        
        function closeLeaveModal() {
            document.getElementById('leaveModal').classList.remove('show');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('leaveDateInput');
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    checkLeaveDate(this.value);
                });
            }
        });
        
        async function checkLeaveDate(dateStr) {
            const shiftContainer = document.getElementById('leaveOriginalShift');
            const shiftNameSpan = document.getElementById('leaveShiftName');
            
            if (!API_URL || !staffName) {
                shiftContainer.style.display = 'none';
                return;
            }
            
            try {
                const month = dateStr.substring(0, 7);
                const res = await fetch(API_URL + '?action=getSchedules&month=' + month);
                const data = await res.json();
                
                if (data.success && data.schedules) {
                    const daySchedule = data.schedules[dateStr] || [];
                    const mySchedule = daySchedule.find(s => s.staffName === staffName);
                    
                    if (mySchedule && mySchedule.shiftId) {
                        const shiftsRes = await fetch(API_URL + '?action=getShifts');
                        const shiftsData = await shiftsRes.json();
                        const shift = (shiftsData.shifts || []).find(s => s.id === mySchedule.shiftId);
                        
                        if (shift) {
                            shiftNameSpan.textContent = shift.name + (shift.time ? ` (${shift.time})` : '');
                            shiftContainer.style.display = 'block';
                            return;
                        }
                    }
                }
                
                shiftNameSpan.textContent = 'ç„¡æ’ç­';
                shiftContainer.style.display = 'block';
            } catch (e) {
                console.error('æª¢æŸ¥æ’ç­å¤±æ•—', e);
                shiftContainer.style.display = 'none';
            }
        }
        
        async function submitLeaveRequest() {
            const dateStr = document.getElementById('leaveDateInput').value;
            const leaveType = document.getElementById('leaveTypeSelect').value;
            const hours = parseFloat(document.getElementById('leaveHoursInput').value) || 8;
            const reason = document.getElementById('leaveReasonInput').value.trim();
            const shiftName = document.getElementById('leaveShiftName').textContent || '';
            
            if (!dateStr) {
                showToast('è«‹é¸æ“‡è«‹å‡æ—¥æœŸ');
                return;
            }
            
            if (hours <= 0 || hours > 8 || hours % 0.5 !== 0) {
                showToast('è«‹å‡æ™‚æ•¸å¿…é ˆåœ¨ 0.5~8 å°æ™‚ä¹‹é–“ï¼Œä¸”ç‚º0.5çš„å€æ•¸');
                return;
            }
            
            try {
                showToast('ğŸ“¤ é€å‡ºä¸­...');
                
                const payload = {
                    action: 'submitLeave',
                    staff: staffName,
                    submissions: [{
                        date: dateStr,
                        shiftName: shiftName !== 'ç„¡æ’ç­' ? shiftName : '',
                        leaveType: leaveType,
                        hours: hours,
                        reason: reason
                    }]
                };
                
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… è«‹å‡ç”³è«‹å·²é€å‡ºï¼');
                    closeLeaveModal();
                    loadMyLeaveRecords();
                } else {
                    showToast('âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
                }
            } catch (e) {
                console.error('é€å‡ºè«‹å‡ç”³è«‹å¤±æ•—', e);
                showToast('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        }

        // ============ åŠ ç­å›å¡«åŠŸèƒ½ ============
        
        async function checkOvertimeReminder() {
            const today = new Date();
            const dayOfMonth = today.getDate();
            
            if (dayOfMonth > 8) return;
            
            document.getElementById('overtimeEntryBtn').style.display = 'block';
            
            const confirmed = sessionStorage.getItem('overtimeReminderConfirmed');
            if (confirmed) return;
            
            document.getElementById('overtimeReminderModal').classList.add('show');
        }
        
        async function confirmOvertimeReminder() {
            document.getElementById('overtimeReminderModal').classList.remove('show');
            sessionStorage.setItem('overtimeReminderConfirmed', 'true');
            
            await enterOvertimeMode();
        }
        
        async function enterOvertimeMode() {
            isOvertimeMode = true;
            
            const today = new Date();
            let lastMonth = today.getMonth() - 1;
            let lastYear = today.getFullYear();
            if (lastMonth < 0) {
                lastMonth = 11;
                lastYear--;
            }
            
            currentYear = lastYear;
            currentMonth = lastMonth;
            
            await loadLastMonthSchedules();
            
            document.getElementById('overtimeModeBar').style.display = 'block';
            document.getElementById('overtimeEntryBtn').style.display = 'none';
            document.getElementById('overtimeExitBtn').style.display = 'block';
            document.getElementById('normalModeButtons').style.display = 'none';
            document.getElementById('staffNameDisplay').innerHTML = 
                `<span class="staff-name">${staffName}</span> é»é¸æ—¥æœŸå›å¡«<strong style="color:#f59e0b;">åŠ ç­æ™‚é–“</strong>`;
            
            holidays = await fetchHolidays(currentYear);
            generateCalendar();
            await updateStats();
        }
        
        function exitOvertimeMode() {
            isOvertimeMode = false;
            
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            
            document.getElementById('overtimeModeBar').style.display = 'none';
            document.getElementById('overtimeExitBtn').style.display = 'none';
            document.getElementById('overtimeEntryBtn').style.display = 'block';
            document.getElementById('normalModeButtons').style.display = 'flex';
            document.getElementById('staffNameDisplay').innerHTML = 
                `<span class="staff-name">${staffName}</span> è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ`;
            
            fetchHolidays(currentYear).then(async h => {
                holidays = h;
                generateCalendar();
                await updateStats();
            });
        }
        
        async function loadLastMonthSchedules() {
            if (!API_URL) return;
            
            try {
                const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const res = await fetch(API_URL + '?action=getSchedules&month=' + monthStr);
                const data = await res.json();
                
                if (data.success && data.schedules) {
                    lastMonthSchedules = {};
                    for (const dateStr in data.schedules) {
                        const mySchedule = data.schedules[dateStr].find(s => s.staffName === staffName);
                        if (mySchedule) {
                            lastMonthSchedules[dateStr] = mySchedule;
                        }
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥ä¸Šæœˆæ’ç­å¤±æ•—', e);
            }
        }
        
        async function loadCurrentMonthSchedule() {
            if (!API_URL) return;
            
            try {
                const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const res = await fetch(API_URL + '?action=getSchedules&month=' + monthStr);
                const data = await res.json();
                
                if (data.success && data.schedules) {
                    currentMonthSchedules = {};
                    for (const dateStr in data.schedules) {
                        const mySchedule = data.schedules[dateStr].find(s => s.staffName === staffName);
                        if (mySchedule) {
                            currentMonthSchedules[dateStr] = mySchedule;
                        }
                    }
                    console.log('âœ… å·²è¼‰å…¥ç•¶æœˆæ’ç­:', Object.keys(currentMonthSchedules).length, 'å¤©');
                }
            } catch (e) {
                console.error('è¼‰å…¥ç•¶æœˆæ’ç­å¤±æ•—', e);
            }
        }
        
        function openOvertimeFillModal(dateStr) {
            currentOvertimeDate = dateStr;
            const date = new Date(dateStr);
            const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            
            document.getElementById('overtimeFillDate').textContent = `${dateStr} (é€±${dayOfWeek})`;
            
            const schedule = lastMonthSchedules[dateStr];
            if (schedule) {
                const shift = shifts.find(s => s.id === schedule.shiftId);
                const shiftInfo = shift ? `${shift.name} (${shift.time})` : schedule.shiftId;
                document.getElementById('overtimeFillShift').innerHTML = `åŸç­åˆ¥ï¼š<strong>${shiftInfo}</strong>`;
            } else {
                document.getElementById('overtimeFillShift').innerHTML = `<strong style="color:#f59e0b;">è‡¨æ™‚ä¸Šç­</strong>ï¼ˆåŸæœ¬ç„¡æ’ç­ï¼‰`;
            }
            
            const startSelect = document.getElementById('overtimeFillStart');
            const endSelect = document.getElementById('overtimeFillEnd');
            
            let options = '<option value="">è«‹é¸æ“‡</option>';
            for (let h = 6; h <= 23; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    options += `<option value="${time}">${time}</option>`;
                }
            }
            
            startSelect.innerHTML = options;
            endSelect.innerHTML = options;
            
            document.getElementById('overtimeFillModal').classList.add('show');
        }
        
        function closeOvertimeFillModal() {
            document.getElementById('overtimeFillModal').classList.remove('show');
            document.getElementById('overtimeFillNote').value = '';
            currentOvertimeDate = null;
        }
        
        async function submitSingleOvertime() {
            const startTime = document.getElementById('overtimeFillStart').value;
            const endTime = document.getElementById('overtimeFillEnd').value;
            const note = document.getElementById('overtimeFillNote').value.trim();
            
            if (!startTime || !endTime) {
                showToast('è«‹é¸æ“‡åŠ ç­æ™‚é–“');
                return;
            }
            
            if (startTime >= endTime) {
                showToast('çµæŸæ™‚é–“å¿…é ˆå¤§æ–¼é–‹å§‹æ™‚é–“');
                return;
            }
            
            const schedule = lastMonthSchedules[currentOvertimeDate];
            let shiftName = 'è‡¨æ™‚ä¸Šç­';
            if (schedule) {
                const shift = shifts.find(s => s.id === schedule.shiftId);
                shiftName = shift ? shift.name : schedule.shiftId;
            }
            
            showToast('ğŸ“¤ æ­£åœ¨é€å‡º...');
            
            try {
                const payload = {
                    action: 'submitOvertime',
                    staff: staffName,
                    submissions: [{
                        date: currentOvertimeDate,
                        shiftName: shiftName,
                        startTime: startTime,
                        endTime: endTime,
                        note: note
                    }]
                };
                
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… åŠ ç­ç”³è«‹å·²é€å‡ºï¼');
                    closeOvertimeFillModal();
                } else {
                    showToast('âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
                }
            } catch (e) {
                console.error('é€å‡ºå¤±æ•—', e);
                showToast('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        }
        
        let pendingOvertimes = [];
        
        function showOvertimeModal(year, month) {
            const container = document.getElementById('overtimeList');
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            
            let html = `<p style="font-size: 13px; color: #666; margin-bottom: 12px;">æ‚¨åœ¨ ${year}/${month} æœˆæœ‰ <strong>${pendingOvertimes.length}</strong> å¤©åŠ ç­å°šæœªå¡«å¯«æ™‚é–“ï¼š</p>`;
            
            pendingOvertimes.forEach((record, index) => {
                const date = new Date(record.date);
                const dayOfWeek = dayNames[date.getDay()];
                
                html += `<div class="overtime-item" style="background:#f9fafb;border-radius:8px;padding:12px;margin-bottom:10px;border-left:3px solid #f59e0b;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">
                        ${record.date} (${dayOfWeek}) - ${record.shiftName}
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:12px;color:#666;">åŠ ç­æ™‚é–“ï¼š</span>
                        <input type="time" class="overtime-start" data-index="${index}" 
                            value="${record.suggestedStart || ''}" 
                            style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                        <span>åˆ°</span>
                        <input type="time" class="overtime-end" data-index="${index}" 
                            value="${record.suggestedEnd || ''}" 
                            style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                    </div>
                    <div style="margin-top:8px;">
                        <label style="font-size:12px;color:#666;display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" class="no-overtime" data-index="${index}" 
                                onchange="toggleOvertimeInputs(this, ${index})">
                            ç•¶å¤©ç„¡åŠ ç­
                        </label>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            document.getElementById('overtimeModal').classList.add('show');
        }
        
        function toggleOvertimeInputs(checkbox, index) {
            const startInput = document.querySelector(`.overtime-start[data-index="${index}"]`);
            const endInput = document.querySelector(`.overtime-end[data-index="${index}"]`);
            if (startInput && endInput) {
                startInput.disabled = checkbox.checked;
                endInput.disabled = checkbox.checked;
                if (checkbox.checked) {
                    startInput.value = '';
                    endInput.value = '';
                }
            }
        }
        
        function closeOvertimeModal() {
            document.getElementById('overtimeModal').classList.remove('show');
        }
        
        async function submitOvertime() {
            const submissions = [];
            let hasError = false;
            
            pendingOvertimes.forEach((record, index) => {
                const noOvertime = document.querySelector(`.no-overtime[data-index="${index}"]`)?.checked;
                const startTime = document.querySelector(`.overtime-start[data-index="${index}"]`)?.value;
                const endTime = document.querySelector(`.overtime-end[data-index="${index}"]`)?.value;
                
                if (noOvertime) {
                    submissions.push({
                        date: record.date,
                        noOvertime: true
                    });
                } else if (startTime && endTime) {
                    submissions.push({
                        date: record.date,
                        startTime,
                        endTime,
                        noOvertime: false
                    });
                } else {
                    hasError = true;
                }
            });
            
            if (hasError) {
                showToast('è«‹å¡«å¯«æ‰€æœ‰åŠ ç­æ™‚é–“æˆ–å‹¾é¸ã€Œç„¡åŠ ç­ã€');
                return;
            }
            
            try {
                const payload = {
                    action: 'submitOvertime',
                    staff: staffName,
                    submissions
                };
                
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… åŠ ç­æ™‚é–“å·²é€å‡ºï¼Œç­‰å¾…å¯©æ ¸');
                    pendingOvertimes = [];
                    localStorage.removeItem('pendingOvertimes_' + staffName);
                    closeOvertimeModal();
                } else {
                    showToast('âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
                }
            } catch (e) {
                localStorage.setItem('overtimeSubmissions_' + staffName, JSON.stringify(submissions));
                showToast('âš ï¸ ç¶²è·¯ç•°å¸¸ï¼Œå·²æš«å­˜æœ¬åœ°ï¼Œè«‹ç¨å¾Œé‡è©¦');
                closeOvertimeModal();
            }
        }

        async function loadShifts() {
            // ğŸ†• å…ˆæª¢æŸ¥å¿«å–
            const cacheKey = 'shifts_cache';
            const cached = getCache(cacheKey);
            
            if (cached) {
                console.log('âœ… ä½¿ç”¨å¿«å–çš„ç­åˆ¥è³‡æ–™');
                shifts = cached;
                loadLeaveOptions(shifts);
                return shifts;
            }
            
            // å¿«å–æœªå‘½ä¸­ï¼Œå¾ API è¼‰å…¥
            if (!API_URL) {
                shifts = [
                    { id: 'shift1', name: 'åˆç­', time: '12:00-18:00', color: '#9fcccc' },
                    { id: 'shift2', name: 'æ™šç­', time: '18:00-22:00', color: '#a78bfa' }
                ];
                loadLeaveOptions([]);
                return shifts;
            }
            
            try {
                const res = await fetch(API_URL + '?action=getShifts');
                const data = await res.json();
                if (data.success && data.shifts) { 
                    shifts = data.shifts;
                    
                    // ğŸ†• å„²å­˜åˆ°å¿«å–ï¼ˆ7 å¤©ï¼‰
                    setCache(cacheKey, shifts, 7);
                    
                    loadLeaveOptions(data.shifts);
                    return shifts;
                }
            } catch (e) {
                console.error('è¼‰å…¥ç­åˆ¥å¤±æ•—', e);
                shifts = [
                    { id: 'shift1', name: 'åˆç­', time: '12:00-18:00', color: '#9fcccc' },
                    { id: 'shift2', name: 'æ™šç­', time: '18:00-22:00', color: '#a78bfa' }
                ];
                loadLeaveOptions([]);
                return shifts;
            }
        }
        
        function loadLeaveOptions(allShifts) {
            const select = document.getElementById('leaveTypeSelect');
            if (!select) return;
            
            const leaveTypes = allShifts.filter(s => s.isLeave);
            
            if (leaveTypes.length === 0) {
                leaveTypes.push(
                    { leaveType: 'ç‰¹ä¼‘', name: 'ç‰¹ä¼‘' },
                    { leaveType: 'ç—…å‡', name: 'ç—…å‡' },
                    { leaveType: 'äº‹å‡', name: 'äº‹å‡' },
                    { leaveType: 'è£œä¼‘', name: 'è£œä¼‘' }
                );
            }
            
            select.innerHTML = leaveTypes.map(leave => {
                const icon = getLeaveIcon(leave.leaveType || leave.name);
                const typeName = leave.leaveType || leave.name;
                return `<option value="${typeName}">${icon} ${typeName}</option>`;
            }).join('');
        }
        
        function getLeaveIcon(leaveType) {
            const iconMap = {
                'ç‰¹ä¼‘': 'ğŸŒ´',
                'ç—…å‡': 'ğŸ¥',
                'äº‹å‡': 'ğŸ“',
                'è£œä¼‘': 'ğŸ”„',
                'å©šå‡': 'ğŸ’’',
                'å–ªå‡': 'ğŸ•¯ï¸',
                'ç”¢å‡': 'ğŸ‘¶',
                'é™ªç”¢å‡': 'ğŸ‘¨â€ğŸ‘¶',
                'å…¬å‡': 'ğŸ›ï¸'
            };
            return iconMap[leaveType] || 'ğŸ“';
        }

        async function fetchHolidays(year) {
            // ğŸ†• å…ˆæª¢æŸ¥å¿«å–
            const cacheKey = `holidays_${year}`;
            const cached = getCache(cacheKey);
            
            if (cached) {
                console.log(`âœ… ä½¿ç”¨å¿«å–çš„ ${year} å¹´åœ‹å®šå‡æ—¥`);
                return cached;
            }
            
            // å¿«å–æœªå‘½ä¸­ï¼Œå¾ API è¼‰å…¥
            try {
                const res = await fetch('https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/' + year + '.json');
                const data = await res.json();
                if (data && Array.isArray(data)) {
                    const holidays = [];
                    data.forEach(record => {
                        if (record.isHoliday && record.description && record.description.trim() !== '') {
                            const d = record.date;
                            const formattedDate = d.substring(0, 4) + '-' + d.substring(4, 6) + '-' + d.substring(6, 8);
                            holidays.push({ date: formattedDate, name: record.description });
                        }
                    });
                    console.log('âœ… å·²è¼‰å…¥ ' + year + ' å¹´å‡æ—¥ï¼š', holidays.length + ' ç­†');
                    
                    // ğŸ†• å„²å­˜åˆ°å¿«å–ï¼ˆ30 å¤©ï¼‰
                    setCache(cacheKey, holidays, 30);
                    
                    return holidays;
                }
            } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—', e);
            }
            return [];
        }

        function generateCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            document.getElementById('monthDisplay').textContent = `${currentYear} å¹´ ${currentMonth + 1} æœˆ`;
            
            const firstDayOfWeek = firstDay.getDay();
            const totalCells = Math.ceil((firstDayOfWeek + lastDay.getDate()) / 7) * 7;
            const calendarDays = [];
            let dayCounter = 1 - firstDayOfWeek;
            for (let i = 0; i < totalCells; i++) { 
                calendarDays.push(new Date(currentYear, currentMonth, dayCounter++)); 
            }
            
            const body = document.getElementById('calendarBody');
            body.innerHTML = '';
            
            // âš¡ DOM å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment
            const fragment = document.createDocumentFragment();
            
            for (let week = 0; week < calendarDays.length / 7; week++) {
                const row = document.createElement('div');
                row.className = 'week-row';
                row.innerHTML = `<div class="week-label">W${week + 1}</div>`;
                for (let day = 0; day < 7; day++) { 
                    row.appendChild(createDayCell(calendarDays[week * 7 + day])); 
                }
                fragment.appendChild(row);  // â† åªåœ¨è¨˜æ†¶é«”ä¸­æ“ä½œ
            }
            
            body.appendChild(fragment);  // â† åªè§¸ç™¼ 1 æ¬¡ reflow

        }

        function createDayCell(date) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            
            const isCurrentMonth = date.getMonth() === currentMonth;
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const dateStr = formatDate(date);
            const isToday = dateStr === formatDate(new Date());
            const holidayInfo = holidays.find(h => h.date === dateStr);
            
            if (!isCurrentMonth) cell.style.opacity = '0.5';
            if (holidayInfo) cell.classList.add('holiday');
            else if (isWeekend) cell.classList.add('weekend');
            if (isToday) cell.classList.add('today');
            
            if (isOvertimeMode) {
                const mySchedule = lastMonthSchedules[dateStr];
                let html = `<div class="day-header"><div class="day-number">${date.getDate()}</div></div>`;
                
                if (holidayInfo) {
                    html += `<span class="status-label holiday-label">${holidayInfo.name}</span>`;
                } else if (isWeekend && !mySchedule) {
                    html += `<span class="status-label weekend-label">ä¼‘</span>`;
                }
                
                if (mySchedule) {
                    const shift = shifts.find(s => s.id === mySchedule.shiftId);
                    const shiftName = shift ? shift.name : mySchedule.shiftId;
                    cell.style.background = '#fef3c7';
                    cell.style.cursor = 'pointer';
                    html += `<div style="font-size:11px;font-weight:500;color:#92400e;margin-top:2px;">${shiftName}</div>`;
                    html += `<div style="font-size:10px;color:#666;">é»æ“Šå›å¡«åŠ ç­</div>`;
                } else if (isCurrentMonth && !holidayInfo) {
                    cell.style.cursor = 'pointer';
                    html += `<div style="font-size:10px;color:#999;margin-top:4px;">é»æ“Šå¡«è‡¨æ™‚åŠ ç­</div>`;
                }
                
                cell.innerHTML = html;
                if (isCurrentMonth) {
                    cell.onclick = () => openOvertimeFillModal(dateStr);
                }
                return cell;
            }
            
            const availData = availableDates[dateStr];
            const isAvailable = availData && (availData.allDay || (availData.shifts && availData.shifts.length > 0) || availData.customTime);
            if (isAvailable) cell.classList.add('available');

            const mySchedule = currentMonthSchedules[dateStr];

            let html = `<div class="day-header"><div class="day-number">${date.getDate()}</div></div>`;
            if (holidayInfo) html += `<span class="status-label holiday-label">${holidayInfo.name}</span>`;
            else if (isWeekend) html += `<span class="status-label weekend-label">ä¼‘</span>`;

            if (availData) {
                html += '<div style="margin-top: 2px;">';
                html += '<div style="font-size: 9px; color: #666; margin-bottom: 2px;">æˆ‘å¯ä¸Šï¼š</div>';
                html += '<div class="shift-badges">';
                if (availData.allDay) {
                    html += `<span class="shift-badge" style="background: var(--pink); color: white;">æ•´å¤©</span>`;
                } else {
                    if (availData.shifts && availData.shifts.length > 0) {
                        availData.shifts.forEach(shiftId => {
                            const shift = shifts.find(s => s.id === shiftId);
                            if (shift) html += `<span class="shift-badge" style="background: ${shift.color}; color: white;">${shift.name}</span>`;
                        });
                    }
                    if (availData.customTime) {
                        html += `<span class="shift-badge" style="background: #999; color: white;">${availData.customTime}</span>`;
                    }
                }
                html += '</div></div>';
            }

            if (mySchedule && isCurrentMonth) {
                const shift = shifts.find(s => s.id === mySchedule.shiftId);
                
                // ğŸ†• ä¸‰å±¤é™ç´šé‚è¼¯å–å¾—ç­åˆ¥åç¨±å’Œæ™‚é–“
                let shiftName = '';
                let shiftTime = '';
                let shiftColor = '#4b5563';
                
                if (shift) {
                    // 1. ç­åˆ¥å­˜åœ¨ï¼šä½¿ç”¨ç­åˆ¥è¨­å®š
                    shiftName = shift.name;
                    shiftTime = shift.time;
                    shiftColor = shift.color;
                } else if (mySchedule.shiftTime) {
                    // 2. ç­åˆ¥å·²åˆªé™¤ï¼Œä½†æœ‰ shiftTimeï¼šä½¿ç”¨è³‡æ–™åº«çš„æ™‚é–“
                    shiftName = mySchedule.shiftName || mySchedule.shiftId;
                    shiftTime = mySchedule.shiftTime;
                } else if (mySchedule.shiftName) {
                    // 3. å¾ shiftName è§£ææ™‚é–“
                    const timeMatch = mySchedule.shiftName.match(/(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/);
                    if (timeMatch) {
                        shiftTime = timeMatch[0];
                        shiftName = mySchedule.shiftName;
                    } else {
                        shiftName = mySchedule.shiftName;
                    }
                } else {
                    shiftName = mySchedule.shiftId;
                }
                
                // è‡ªè¨‚ç­åˆ¥ç”¨ç´«è‰²
                if (mySchedule.shiftId && mySchedule.shiftId.startsWith('custom_')) {
                    shiftColor = '#a78bfa';
                }
                
                html += '<div style="margin-top: 4px; padding-top: 4px; border-top: 1px dashed #ddd;">';
                html += '<div style="font-size: 9px; color: #666; margin-bottom: 2px;">å·²æ’ç­ï¼š</div>';
                html += `<div class="shift-badges">`;

                // ğŸ†• é¡¯ç¤ºç­åˆ¥åç¨±å’Œæ™‚é–“
                if (shiftTime) {
                    html += `<span class="shift-badge" style="background: ${shiftColor}; color: white;">${shiftName}</span>`;
                    html += `<span class="shift-badge" style="background: #6b7280; color: white;">${shiftTime}</span>`;
                } else {
                    html += `<span class="shift-badge" style="background: ${shiftColor}; color: white;">${shiftName}</span>`;
                }
                
                if (mySchedule.overtimeStart && mySchedule.overtimeEnd) {
                    const otStatus = mySchedule.overtimeStatus === 'å·²å¯©æ ¸' ? 'âœ“' : 'â³';
                    html += `<span class="shift-badge" style="background: #f59e0b; color: white;">+ç­${otStatus}</span>`;
                }
                if (mySchedule.leaveType && mySchedule.leaveHours > 0) {
                    const leaveIcon = getLeaveIcon(mySchedule.leaveType);
                    html += `<span class="shift-badge" style="background: #9ca3af; color: white;">${leaveIcon}${mySchedule.leaveHours}h</span>`;
                }
                
                html += '</div></div>';
            }

            cell.innerHTML = html;
            if (isCurrentMonth) cell.onclick = () => openShiftModal(dateStr);
            return cell;
        }

        function renderShiftOptions() {
            const container = document.getElementById('shiftOptionsContainer');
            
            // âš¡ DOM å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment
            const fragment = document.createDocumentFragment();
            
            // æ•´å¤©å¯ä¸Šç­é¸é …
            const allDayDiv = document.createElement('div');
            allDayDiv.className = 'shift-option';
            allDayDiv.id = 'allDayOption';
            allDayDiv.onclick = () => toggleShiftOption('allDay');
            allDayDiv.innerHTML = `
                <div class="shift-option-checkbox"></div>
                <div class="shift-option-label">
                    <div class="shift-option-title">âœ… æ•´å¤©å¯ä¸Šç­</div>
                    <div class="shift-option-time">å…¨å¤©éƒ½å¯ä»¥æ’ç­</div>
                </div>
            `;
            fragment.appendChild(allDayDiv);
            
            // ç­åˆ¥é¸é …ï¼ˆæ’é™¤å‡åˆ¥å’Œå·²åˆªé™¤çš„ç­åˆ¥ï¼‰
            shifts.filter(shift => !shift.isLeave && !shift.disabled).forEach(shift => {
                const shiftDiv = document.createElement('div');
                shiftDiv.className = 'shift-option';
                shiftDiv.id = `shift_${shift.id}_option`;
                shiftDiv.onclick = () => toggleShiftOption(shift.id);
                shiftDiv.style.borderLeft = `4px solid ${shift.color}`;
                shiftDiv.innerHTML = `
                    <div class="shift-option-checkbox"></div>
                    <div class="shift-option-label">
                        <div class="shift-option-title">${shift.name}</div>
                        <div class="shift-option-time">${shift.time}</div>
                    </div>
                    <div class="shift-option-color" style="background: ${shift.color}; width: 20px; height: 20px; border-radius: 4px;"></div>
                `;
                fragment.appendChild(shiftDiv);
            });
            
            // è‡ªè¨‚æ™‚é–“é¸é …
            const customDiv = document.createElement('div');
            customDiv.className = 'shift-option';
            customDiv.id = 'customShiftOption';
            customDiv.onclick = () => toggleShiftOption('custom');
            customDiv.style.borderLeft = '4px solid #999';
            customDiv.innerHTML = `
                <div class="shift-option-checkbox"></div>
                <div class="shift-option-label">
                    <div class="shift-option-title">ğŸ• å…¶ä»–ç­åˆ¥</div>
                    <div class="shift-option-time">è‡ªè¨‚å¯ä¸Šç­æ™‚é–“</div>
                </div>
            `;
            fragment.appendChild(customDiv);
            
            // è‡ªè¨‚æ™‚é–“è¼¸å…¥
            const customInputDiv = document.createElement('div');
            customInputDiv.className = 'custom-shift-inputs';
            customInputDiv.id = 'customShiftInputs';

            // ç”Ÿæˆæ™‚é–“é¸é …ï¼ˆåªæœ‰æ•´é»å’Œ30åˆ†ï¼‰
            let timeOptions = '<option value="">è«‹é¸æ“‡</option>';
            for (let h = 6; h <= 23; h++) {
                const hour = String(h).padStart(2, '0');
                timeOptions += `<option value="${hour}:00">${hour}:00</option>`;
                timeOptions += `<option value="${hour}:30">${hour}:30</option>`;
            }

            customInputDiv.innerHTML = `
                <div class="custom-time-row">
                    <select class="custom-time-input" id="customStartTime" style="padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; text-align: center;">
                        ${timeOptions}
                    </select>
                    <span class="custom-time-separator">ï½</span>
                    <select class="custom-time-input" id="customEndTime" style="padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; text-align: center;">
                        ${timeOptions}
                    </select>
                </div>
            `;
            fragment.appendChild(customInputDiv);
            
            // âš¡ ä¸€æ¬¡æ€§æ’å…¥
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function openShiftModal(dateStr) {
            currentEditingDate = dateStr;
            const date = new Date(dateStr);
            const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            document.getElementById('shiftModalDate').textContent = `${dateStr} (é€±${dayOfWeek})`;
            renderShiftOptions();
            
            const data = availableDates[dateStr] || { allDay: false, shifts: [], customTime: '' };
            if (data.allDay) document.getElementById('allDayOption').classList.add('selected');
            if (data.shifts) {
                data.shifts.forEach(shiftId => {
                    const el = document.getElementById(`shift_${shiftId}_option`);
                    if (el) el.classList.add('selected');
                });
            }
            if (data.customTime) {
                document.getElementById('customShiftOption').classList.add('selected');
                document.getElementById('customShiftInputs').classList.add('show');
                const [start, end] = data.customTime.split('-');
                if (start) document.getElementById('customStartTime').value = start;
                if (end) document.getElementById('customEndTime').value = end;
            }
            document.getElementById('shiftModal').classList.add('show');
        }

        function closeShiftModal() {
            document.getElementById('shiftModal').classList.remove('show');
            currentEditingDate = null;
        }

        function toggleShiftOption(optionId) {
            if (optionId === 'allDay') {
                const option = document.getElementById('allDayOption');
                if (!option.classList.contains('selected')) {
                    shifts.forEach(shift => {
                        const el = document.getElementById(`shift_${shift.id}_option`);
                        if (el) el.classList.remove('selected');
                    });
                    document.getElementById('customShiftOption').classList.remove('selected');
                    document.getElementById('customShiftInputs').classList.remove('show');
                }
                option.classList.toggle('selected');
            } else if (optionId === 'custom') {
                document.getElementById('allDayOption').classList.remove('selected');
                const option = document.getElementById('customShiftOption');
                const inputs = document.getElementById('customShiftInputs');
                option.classList.toggle('selected');
                if (option.classList.contains('selected')) {
                    inputs.classList.add('show');
                } else {
                    inputs.classList.remove('show');
                }
            } else {
                document.getElementById('allDayOption').classList.remove('selected');
                const option = document.getElementById(`shift_${optionId}_option`);
                if (option) option.classList.toggle('selected');
            }
        }

        function confirmShiftSelection() {
            const allDaySelected = document.getElementById('allDayOption').classList.contains('selected');
            const customSelected = document.getElementById('customShiftOption').classList.contains('selected');
            const selectedShifts = [];
            shifts.forEach(shift => {
                const el = document.getElementById(`shift_${shift.id}_option`);
                if (el && el.classList.contains('selected')) selectedShifts.push(shift.id);
            });
            
            let customTime = '';
            if (customSelected) {
                const startTime = document.getElementById('customStartTime').value;
                const endTime = document.getElementById('customEndTime').value;
                if (startTime && endTime) {
                    if (startTime >= endTime) {
                        showToast('âš ï¸ çµæŸæ™‚é–“å¿…é ˆå¤§æ–¼é–‹å§‹æ™‚é–“');
                        return;
                    }
                    customTime = `${startTime}-${endTime}`;
                }
            }
            
            if (allDaySelected || selectedShifts.length > 0 || customTime) {
                availableDates[currentEditingDate] = { 
                    allDay: allDaySelected, 
                    shifts: selectedShifts,
                    customTime: customTime
                };
                let msg = 'âœ… å·²æ¨™è¨˜å¯ä¸Šç­: ';
                if (allDaySelected) msg += 'æ•´å¤©';
                else {
                    const parts = [];
                    if (selectedShifts.length > 0) {
                        parts.push(selectedShifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+'));
                    }
                    if (customTime) parts.push(customTime);
                    msg += parts.join(', ');
                }
                showToast(msg);
            } else {
                delete availableDates[currentEditingDate];
                showToast('âœ“ å·²å–æ¶ˆæ¨™è¨˜');
            }
            
            closeShiftModal();
            saveLocalData();
            generateCalendar();
            updateStats();
        }

        /**
         * ğŸ†• è¨ˆç®—ç­åˆ¥æ™‚æ•¸çš„è¼”åŠ©å‡½æ•¸
         */
        function calculateShiftHours(timeStr) {
            if (!timeStr || !timeStr.includes('-')) return 0;
            
            const [start, end] = timeStr.split('-');
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            
            return (endMinutes - startMinutes) / 60;
        }

        async function updateStats() {
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            let workDays = 0, holidayCount = 0, availableCount = 0, totalHours = 0;
            
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const date = new Date(currentYear, currentMonth, d);
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const holidayInfo = holidays.find(h => h.date === dateStr);
                
                if (holidayInfo) {
                    holidayCount++;
                } else if (!isWeekend) {
                    workDays++;
                    const data = availableDates[dateStr];
                    if (data && (data.allDay || (data.shifts && data.shifts.length > 0) || data.customTime)) {
                        availableCount++;
                        
                        // ğŸ†• è¨ˆç®—æ™‚æ•¸
                        if (data.allDay) {
                            totalHours += 8; // æ•´å¤©ç®—8å°æ™‚
                        } else {
                            // è¨ˆç®—æ‰€é¸ç­åˆ¥çš„ç¸½æ™‚æ•¸
                            let dayHours = 0;
                            
                            if (data.shifts && data.shifts.length > 0) {
                                data.shifts.forEach(shiftId => {
                                    const shift = shifts.find(s => s.id === shiftId);
                                    if (shift && shift.time) {
                                        const hours = calculateShiftHours(shift.time);
                                        dayHours += hours;
                                    }
                                });
                            }
                            
                            if (data.customTime) {
                                const hours = calculateShiftHours(data.customTime);
                                dayHours += hours;
                            }
                            
                            totalHours += dayHours;
                        }
                    }
                }
            }
            
            document.getElementById('availableCount').textContent = availableCount;
            document.getElementById('availableHours').textContent = totalHours;
            document.getElementById('holidayCount').textContent = holidayCount;
            document.getElementById('unmarkedCount').textContent = workDays - availableCount;
            
                updateMyAvailabilityStats();
                updateActualScheduleStatsAsync();
        }

        async function previousMonth() {
            if (isOvertimeMode) {
                showToast('âš ï¸ å›å¡«æ¨¡å¼åªèƒ½æ“ä½œä¸Šæœˆ');
                return;
            }
            showToast('â³ è¼‰å…¥ä¸­...');
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; holidays = await fetchHolidays(currentYear); }
            
            if (staffName) {
                await loadCurrentMonthSchedule();
            }
            
            generateCalendar();
            await updateStats();
        }

        async function nextMonth() {
            if (isOvertimeMode) {
                showToast('âš ï¸ å›å¡«æ¨¡å¼åªèƒ½æ“ä½œä¸Šæœˆ');
                return;
            }
            showToast('â³ è¼‰å…¥ä¸­...');
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; holidays = await fetchHolidays(currentYear); }
            
            if (staffName) {
                await loadCurrentMonthSchedule();
            }
            
            generateCalendar(); 
            await updateStats();
        }

        function saveLocalData() { localStorage.setItem(`available_${staffName}`, JSON.stringify(availableDates)); }
        function loadLocalData() { const saved = localStorage.getItem(`available_${staffName}`); if (saved) availableDates = JSON.parse(saved); }
        
        async function loadSavedAvailability() {
            if (!API_URL || !staffName) return false;
            
            try {
                const res = await fetch(API_URL + '?action=getStaff');
                const data = await res.json();
                
                if (!data.success || !data.staff) return false;
                
                const myData = data.staff.find(s => s.name === staffName);
                if (!myData || !myData.availability) return false;
                
                const lines = myData.availability.split('\n').filter(line => line.trim());
                if (lines.length === 0) return false;
                
                const shiftNames = shifts.map(s => s.name);
                
                availableDates = {};
                
                lines.forEach(line => {
                    const match = line.match(/^(\d{4}-\d{2}-\d{2})\((.+)\)$/);
                    if (!match) return;
                    
                    const dateStr = match[1];
                    const content = match[2];
                    
                    if (content === 'æ•´å¤©') {
                        availableDates[dateStr] = { allDay: true, shifts: [], customTime: '' };
                    } else {
                        const parts = content.split(', ');
                        
                        let shiftIds = [];
                        let customTime = '';
                        
                        parts.forEach(part => {
                            const possibleShifts = part.split('+');
                            const isShiftPart = possibleShifts.some(name => 
                                shiftNames.includes(name.trim())
                            );
                            
                            if (isShiftPart) {
                                possibleShifts.forEach(name => {
                                    const shift = shifts.find(s => s.name === name.trim());
                                    if (shift) shiftIds.push(shift.id);
                                });
                            } else {
                                customTime = part.trim();
                            }
                        });
                        
                        availableDates[dateStr] = { 
                            allDay: false, 
                            shifts: shiftIds, 
                            customTime: customTime 
                        };
                    }
                });
                
                if (Object.keys(availableDates).length > 0) {
                    showToast(`âœ… å·²è¼‰å…¥å…ˆå‰é€å‡ºçš„è³‡æ–™ï¼ˆ${Object.keys(availableDates).length} å¤©ï¼‰`);
                }
                
                return Object.keys(availableDates).length > 0;
            } catch (e) {
                console.error('è¼‰å…¥å·²å­˜è³‡æ–™å¤±æ•—', e);
                return false;
            }
        }

        function clearAll() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¨™è¨˜å—ï¼Ÿ')) return;
            availableDates = {};
            saveLocalData();
            generateCalendar();
            updateStats();
            showToast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ¨™è¨˜');
        }

        function showConfirmModal() {
            const currentMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            const availableList = Object.keys(availableDates)
                .filter(dateStr => {
                    if (!dateStr.startsWith(currentMonthPrefix)) return false;
                    const data = availableDates[dateStr];
                    return data && (data.allDay || (data.shifts && data.shifts.length > 0) || data.customTime);
                })
                .sort()
                .map(dateStr => {
                    const date = new Date(dateStr);
                    const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
                    const data = availableDates[dateStr];
                    let shiftDisplay = 'æ•´å¤©';
                    if (!data.allDay) {
                        const parts = [];
                        if (data.shifts && data.shifts.length > 0) {
                            parts.push(data.shifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+'));
                        }
                        if (data.customTime) {
                            parts.push(data.customTime);
                        }
                        if (parts.length > 0) shiftDisplay = parts.join(', ');
                    }
                    return { date: dateStr, dayOfWeek, shiftDisplay };
                });
            
            document.getElementById('modalSummary').textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ å…± ${availableList.length} å¤©å¯ä»¥ä¸Šç­`;
            document.getElementById('dateList').innerHTML = availableList.length === 0 
                ? '<div style="text-align: center; padding: 20px; color: #666;">å°šæœªæ¨™è¨˜ä»»ä½•å¯ä¸Šç­çš„æ—¥æœŸ</div>'
                : availableList.map(item => `<div class="date-item">${item.date} (é€±${item.dayOfWeek}) - ${item.shiftDisplay}</div>`).join('');
            
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeConfirmModal() { document.getElementById('modalOverlay').classList.remove('show'); }

        async function confirmSubmit() {
            closeConfirmModal();
            if (!API_URL) { showToast('âŒ API æœªè¨­å®š'); return; }
            if (!staffName) { showToast('âŒ è«‹å¾æ­£ç¢ºçš„é€£çµé€²å…¥'); return; }
            
            const currentMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            let availabilityArr = [];
            Object.keys(availableDates).sort().forEach(dateStr => {
                if (!dateStr.startsWith(currentMonthPrefix)) return;
                
                const data = availableDates[dateStr];
                if (data && (data.allDay || (data.shifts && data.shifts.length > 0) || data.customTime)) {
                    if (data.allDay) {
                        availabilityArr.push(`${dateStr}(æ•´å¤©)`);
                    } else {
                        const parts = [];
                        if (data.shifts && data.shifts.length > 0) {
                            parts.push(data.shifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+'));
                        }
                        if (data.customTime) {
                            parts.push(data.customTime);
                        }
                        availabilityArr.push(`${dateStr}(${parts.join(', ')})`);
                    }
                }
            });
            const availabilityStr = availabilityArr.join('\n');
            
            showToast('ğŸ“¤ æ­£åœ¨é€å‡º...');
            
            try {
                const totalDays = availabilityArr.length;
                const payload = { 
                    action: 'updateAvailability',
                    name: staffName, 
                    availability: availabilityStr,
                    totalDays: totalDays
                };
                
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                showToast(data.success ? 'âœ… å·²é€å‡ºï¼' : 'âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
            } catch (e) {
                console.error('é€å‡ºå¤±æ•—', e);
                showToast('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        // ============ ğŸ†• çµ±è¨ˆåŠŸèƒ½ ============
        
        /**
 * âš¡ å¼‚æ­¥è½½å…¥ç®¡ç†ç«¯æ’ç­ç»Ÿè®¡ï¼ˆå¸¦loadingæç¤ºï¼‰
 */
async function updateActualScheduleStatsAsync() {
    const container = document.getElementById('actualScheduleStatsContent');
    
    // æ˜¾ç¤ºè½½å…¥ä¸­
    container.innerHTML = '<div style="color:#999;font-size:13px;"><div style="display:inline-block;width:12px;height:12px;border:2px solid #e0e0e0;border-top-color:#10b981;border-radius:50%;animation:spin 1s linear infinite;margin-right:6px;"></div>è¼‰å…¥ä¸­...</div>';
    
    // å¼‚æ­¥è½½å…¥å®é™…æ•°æ®
    await updateActualScheduleStats();
}
        /**
 * çµ±è¨ˆ 1ï¼šæˆ‘å¡«å¯«çš„å¯ä¸Šç­æ™‚æ®µ
 */
async function updateMyAvailabilityStats() {
    const container = document.getElementById('myAvailabilityStatsContent');
    
    // ğŸ†• ä¿®æ­£ï¼šä½¿ç”¨ availableDates è€Œä¸æ˜¯ myAvailability
    const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
    
    // å¾ availableDates ç¯©é¸å‡ºæœ¬æœˆçš„è³‡æ–™
    const currentMonthDates = Object.keys(availableDates)
        .filter(dateStr => dateStr.startsWith(monthStr))
        .filter(dateStr => {
            const data = availableDates[dateStr];
            return data && (data.allDay || (data.shifts && data.shifts.length > 0) || data.customTime);
        });
    
    if (currentMonthDates.length === 0) {
        container.innerHTML = '<div style="color:#999;font-size:13px;">å°šæœªå¡«å¯«å¯ä¸Šç­æ™‚æ®µ</div>';
        return;
    }
    
    let totalDays = 0;
    let totalRawHours = 0;
    let totalBreakMinutes = 0;
    let totalNetHours = 0;
    let break30 = 0, break60 = 0;
    const shiftCounts = {};
    
    currentMonthDates.forEach(dateStr => {
        const data = availableDates[dateStr];
        totalDays++;
        
        if (data.allDay) {
            // æ•´å¤©ï¼šå‡è¨­ 8 å°æ™‚å·¥æ™‚
            totalRawHours += 8;
            totalNetHours += 8;
            shiftCounts['æ•´å¤©'] = (shiftCounts['æ•´å¤©'] || 0) + 1;
        } else {
            // è¨ˆç®—æ‰€é¸ç­åˆ¥çš„ç¸½æ™‚æ•¸
            let dayRawHours = 0;
            let dayBreakMinutes = 0;
            
            if (data.shifts && data.shifts.length > 0) {
                data.shifts.forEach(shiftId => {
                    const shift = shifts.find(s => s.id === shiftId);
                    if (shift && shift.time) {
                        const workInfo = calculateWorkHours(shift.time);
                        dayRawHours += workInfo.rawHours;
                        dayBreakMinutes += workInfo.breakMinutes;
                        if (workInfo.breakMinutes === 30) break30++;
                        if (workInfo.breakMinutes === 60) break60++;
                        shiftCounts[shift.name] = (shiftCounts[shift.name] || 0) + 1;
                    }
                });
            }
            
            if (data.customTime) {
                const workInfo = calculateWorkHours(data.customTime);
                dayRawHours += workInfo.rawHours;
                dayBreakMinutes += workInfo.breakMinutes;
                if (workInfo.breakMinutes === 30) break30++;
                if (workInfo.breakMinutes === 60) break60++;
                shiftCounts['è‡ªè¨‚æ™‚æ®µ'] = (shiftCounts['è‡ªè¨‚æ™‚æ®µ'] || 0) + 1;
            }
            
            totalRawHours += dayRawHours;
            totalBreakMinutes += dayBreakMinutes;
            totalNetHours += (dayRawHours - dayBreakMinutes / 60);
        }
    });
    
    const breakHours = totalBreakMinutes / 60;
    const shiftSummary = Object.entries(shiftCounts).map(([k, v]) => `${k}Ã—${v}`).join('ã€');
    
    let breakDetail = '';
    if (break30 > 0 || break60 > 0) {
        const parts = [];
        if (break30 > 0) parts.push(`30åˆ†Ã—${break30}`);
        if (break60 > 0) parts.push(`60åˆ†Ã—${break60}`);
        breakDetail = ` (${parts.join('ã€')})`;
    }
    
    let html = `
        <div class="stats-row">
            <span class="stats-label">å¯ä¸Šç­å¤©æ•¸</span>
            <span class="stats-value highlight">${totalDays} å¤©</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">ç­åˆ¥æ™‚é•·</span>
            <span class="stats-value">${totalRawHours.toFixed(1)} å°æ™‚</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">ä¼‘æ¯æ™‚é–“</span>
            <span class="stats-value" style="color: #f59e0b;">-${breakHours.toFixed(1)} å°æ™‚</span>
        </div>`;
    
    if (breakDetail) {
        html += `<div class="stats-row">
            <span class="stats-label" style="font-size: 11px; color: #999;">ä¼‘æ¯æ˜ç´°</span>
            <span class="stats-value" style="font-size: 11px; color: #f59e0b;">${breakDetail}</span>
        </div>`;
    }
    
    html += `
        <div class="stats-row">
            <span class="stats-label">é è¨ˆå·¥æ™‚</span>
            <span class="stats-value highlight">${totalNetHours.toFixed(1)} å°æ™‚</span>
        </div>
        <div class="stats-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed #ddd;">
            <span class="stats-label" style="font-size: 11px;">æ™‚æ®µæ˜ç´°</span>
            <span class="stats-value" style="font-size: 11px; color: #666;">${shiftSummary || '-'}</span>
        </div>`;
    
    container.innerHTML = html;
}
        
        /**
         * çµ±è¨ˆ 2ï¼šç®¡ç†ç«¯å¯¦éš›æ’ç­
         */
        async function updateActualScheduleStats() {
            const container = document.getElementById('actualScheduleStatsContent');
            
            if (!API_URL) {
                container.innerHTML = '<div style="color:#999;font-size:13px;">API æœªè¨­å®š</div>';
                return;
            }
            
            try {
                // å¾ API ç²å–æœ¬æœˆçµ±è¨ˆ
                const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const res = await fetch(`${API_URL}?action=getMonthStats&month=${monthStr}`);
                const data = await res.json();
                
                if (!data.success || !data.stats || !data.stats[staffName]) {
                    container.innerHTML = '<div style="color:#999;font-size:13px;">æœ¬æœˆå°šç„¡æ’ç­</div>';
                    return;
                }
                
                const stats = data.stats[staffName];
                
                // å¾ API å–å¾—è©³ç´°æ’ç­è³‡æ–™ä¾†è¨ˆç®—çµ±è¨ˆ
                const schedRes = await fetch(`${API_URL}?action=getSchedules&month=${monthStr}`);
                const schedData = await schedRes.json();
                
                if (!schedData.success || !schedData.schedules) {
                    container.innerHTML = '<div style="color:#999;font-size:13px;">ç„¡æ³•è¼‰å…¥æ’ç­è³‡æ–™</div>';
                    return;
                }
                
                const schedules = schedData.schedules;
                
                // è¨ˆç®—è©³ç´°çµ±è¨ˆ
                let days = 0, rawHours = 0, breakMinutes = 0, netHours = 0, overtimeHours = 0, leaveHours = 0;
                let break30 = 0, break60 = 0;
                const shiftCounts = {};
                
                for (const dateStr in schedules) {
                    if (!dateStr.startsWith(monthStr)) continue;
                    
                    const daySchedule = schedules[dateStr];
                    const mySchedule = daySchedule.find(s => s.staffName === staffName);
                    
                    if (mySchedule) {
                        days++;
                        const shift = shifts.find(s => s.id === mySchedule.shiftId);
                        const isLeave = shift ? shift.isLeave : false;
                        
                        if (isLeave) {
                            leaveHours += mySchedule.leaveHours || 8;
                        } else {
                            let workInfo;
                            if (shift && shift.time) {
                                workInfo = calculateWorkHours(shift.time);
                            } else if (mySchedule.shiftTime) {
                                workInfo = calculateWorkHours(mySchedule.shiftTime);
                            } else if (mySchedule.shiftName) {
                                const timeMatch = mySchedule.shiftName.match(/(\d{1,2}:\d{2})-(\d{1,2}:\d{2})/);
                                if (timeMatch) {
                                    workInfo = calculateWorkHours(timeMatch[0]);
                                } else {
                                    workInfo = { rawHours: 0, breakMinutes: 0, netHours: 0 };
                                }
                            } else {
                                workInfo = { rawHours: 0, breakMinutes: 0, netHours: 0 };
                            }
                            
                            // æ‰£é™¤è«‹å‡æ™‚æ•¸
                            let appliedLeaveHours = 0;
                            if (mySchedule.leaveType && mySchedule.leaveHours && mySchedule.leaveHours > 0) {
                                appliedLeaveHours = Number(mySchedule.leaveHours) || 0;
                                leaveHours += appliedLeaveHours;
                            }
                            
                            rawHours += workInfo.rawHours;
                            breakMinutes += workInfo.breakMinutes;
                            netHours += (workInfo.netHours - appliedLeaveHours);
                            
                            if (workInfo.breakMinutes === 30) break30++;
                            if (workInfo.breakMinutes === 60) break60++;
                            
                            // åŠ ç­æ™‚æ•¸
                            if (mySchedule.overtimeStart && mySchedule.overtimeEnd && mySchedule.overtimeStatus === 'å·²å¯©æ ¸') {
                                overtimeHours += calculateOvertimeHours(mySchedule.overtimeStart, mySchedule.overtimeEnd);
                            }
                        }
                        
                        const shiftName = shift ? shift.name : (mySchedule.shiftName || mySchedule.shiftId);
                        shiftCounts[shiftName] = (shiftCounts[shiftName] || 0) + 1;
                    }
                }
                
                const totalHours = netHours + overtimeHours;
                const breakHours = breakMinutes / 60;
                const shiftSummary = Object.entries(shiftCounts).map(([k, v]) => `${k}Ã—${v}`).join('ã€');
                
                let breakDetail = '';
                if (break30 > 0 || break60 > 0) {
                    const parts = [];
                    if (break30 > 0) parts.push(`30åˆ†Ã—${break30}`);
                    if (break60 > 0) parts.push(`60åˆ†Ã—${break60}`);
                    breakDetail = ` (${parts.join('ã€')})`;
                }
                
                // å–å¾—å“¡å·¥é¡å‹å’Œæ‡‰æ’æ™‚æ•¸
                const staffInfo = await getMyStaffInfo();
                const staffType = staffInfo ? staffInfo.staffType : 'PT';
                const workDays = calculateWorkDays(currentYear, currentMonth + 1);
                const requiredHours = getRequiredHours(staffType, workDays);
                
                let html = `
                    <div class="stats-row">
                        <span class="stats-label">å‡ºå‹¤å¤©æ•¸</span>
                        <span class="stats-value highlight">${days} å¤©</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">ç­åˆ¥æ™‚é•·</span>
                        <span class="stats-value">${rawHours.toFixed(1)} å°æ™‚</span>
                    </div>
                    <div class="stats-row">
                        <span class="stats-label">ä¼‘æ¯æ™‚é–“</span>
                        <span class="stats-value" style="color: #f59e0b;">-${breakHours.toFixed(1)} å°æ™‚</span>
                    </div>`;
                
                if (breakDetail) {
                    html += `<div class="stats-row">
                        <span class="stats-label" style="font-size: 11px; color: #999;">ä¼‘æ¯æ˜ç´°</span>
                        <span class="stats-value" style="font-size: 11px; color: #f59e0b;">${breakDetail}</span>
                    </div>`;
                }
                
                html += `
                    <div class="stats-row">
                        <span class="stats-label">å¯¦éš›å·¥æ™‚</span>
                        <span class="stats-value">${netHours.toFixed(1)} å°æ™‚</span>
                    </div>`;
                
                if (overtimeHours > 0) {
                    html += `<div class="stats-row">
                        <span class="stats-label">åŠ ç­æ™‚æ•¸</span>
                        <span class="stats-value" style="color: #10b981;">+${overtimeHours.toFixed(1)} å°æ™‚</span>
                    </div>`;
                }
                
                if (leaveHours > 0) {
                    html += `<div class="stats-row">
                        <span class="stats-label">è«‹å‡æ™‚æ•¸</span>
                        <span class="stats-value" style="color: #9ca3af;">${leaveHours.toFixed(1)} å°æ™‚</span>
                    </div>`;
                }
                
                html += `
                    <div class="stats-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #ddd;">
                        <span class="stats-label">ç¸½è¨ˆæ™‚æ•¸</span>
                        <span class="stats-value highlight">${totalHours.toFixed(1)} å°æ™‚</span>
                    </div>`;
                
                // é¡¯ç¤ºæ‡‰æ’æ™‚æ•¸å’Œå·®ç•°ï¼ˆåªæœ‰æ­£è·/åŠè–ªæ­£è·ï¼‰
                if (requiredHours !== null) {
                    const actualHours = totalHours + leaveHours;
                    const diff = actualHours - requiredHours;
                    const diffColor = diff >= 0 ? '#10b981' : '#ef4444';
                    const diffText = diff >= 0 ? `+${diff.toFixed(1)}ï¼ˆå¯è£œä¼‘ï¼‰` : `${diff.toFixed(1)}ï¼ˆéœ€è£œç­ï¼‰`;
                    
                    html += `
                        <div class="stats-row" style="background: ${diff >= 0 ? '#ecfdf5' : '#fef2f2'}; margin: 6px -10px; padding: 8px 10px; border-radius: 4px;">
                            <span class="stats-label">æ‡‰æ’æ™‚æ•¸</span>
                            <span class="stats-value">${requiredHours} å°æ™‚</span>
                        </div>
                        <div class="stats-row">
                            <span class="stats-label" style="font-weight:600;">æœ¬æœˆå·®ç•°</span>
                            <span class="stats-value" style="color: ${diffColor}; font-weight: 700;">${diffText}</span>
                        </div>`;
                }
                
                html += `
                    <div class="stats-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed #ddd;">
                        <span class="stats-label" style="font-size: 11px;">ç­åˆ¥æ˜ç´°</span>
                        <span class="stats-value" style="font-size: 11px; color: #666;">${shiftSummary || '-'}</span>
                    </div>`;
                
                container.innerHTML = html;
                
            } catch (e) {
                console.error('è¼‰å…¥å¯¦éš›æ’ç­çµ±è¨ˆå¤±æ•—:', e);
                container.innerHTML = '<div style="color:#ef4444;font-size:13px;">è¼‰å…¥å¤±æ•—</div>';
            }
        }
        
        /**
         * è¨ˆç®—å·¥æ™‚
         */
        function calculateWorkHours(timeStr) {
            if (!timeStr || !timeStr.includes('-')) return { rawHours: 0, breakMinutes: 0, netHours: 0 };
            const [start, end] = timeStr.split('-');
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            
            let totalMinutes = (endH * 60 + endM) - (startH * 60 + startM);
            if (totalMinutes < 0) totalMinutes += 24 * 60;
            
            const rawHours = totalMinutes / 60;
            
            let breakMinutes = 0;
            if (rawHours >= 9) {
                breakMinutes = 60;
            } else if (rawHours > 4) {
                breakMinutes = 30;
            }
            
            const netMinutes = totalMinutes - breakMinutes;
            const netHours = Math.max(0, netMinutes / 60);
            
            return { rawHours, breakMinutes, netHours };
        }
        
        /**
         * è¨ˆç®—åŠ ç­æ™‚æ•¸
         */
        function calculateOvertimeHours(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            const diffMinutes = endMinutes - startMinutes;
            return Math.round(diffMinutes / 30) / 2;
        }
        
        /**
         * è¨ˆç®—å·¥ä½œæ—¥
         */
        function calculateWorkDays(year, month) {
            let workDays = 0;
            const lastDay = new Date(year, month, 0).getDate();
            
            for (let d = 1; d <= lastDay; d++) {
                const date = new Date(year, month - 1, d);
                const dayOfWeek = date.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    workDays++;
                }
            }
            return workDays;
        }
        
        /**
         * è¨ˆç®—æ‡‰æ’æ™‚æ•¸
         */
        function getRequiredHours(staffType, workDays) {
            switch (staffType) {
                case 'æ­£è·': return workDays * 8;
                case 'åŠè–ªæ­£è·': return (workDays * 8) / 2;
                case 'PT': return null;
                default: return null;
            }
        }
        
        /**
         * å–å¾—è‡ªå·±çš„å“¡å·¥è³‡è¨Š
         */
        async function getMyStaffInfo() {
            if (!API_URL) return null;
            try {
                const res = await fetch(API_URL + '?action=getStaff');
                const data = await res.json();
                if (data.success && data.staff) {
                    return data.staff.find(s => s.name === staffName);
                }
            } catch (e) {
                console.error('å–å¾—å“¡å·¥è³‡è¨Šå¤±æ•—:', e);
            }
            return null;
        }
    </script>
</body>
</html>
