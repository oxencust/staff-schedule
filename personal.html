<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡¡é»-å€‹äººæ’ç­ç³»çµ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --white: #ffffff;
            --gray: #808080;
            --green: #7ac19a;
            --green-light: #e2ede6;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --pink-dark: #c67566;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --yellow-dark: #ba9e60;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --blue-dark: #66888e;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #f8f9fa; 
            color: #2d3748; 
            padding-bottom: 20px;
            overflow-x: hidden;
        }
        
        .loading-screen { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: linear-gradient(135deg, var(--pink-light), var(--blue-light)); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
        }
        .loading-screen.hidden { display: none; }
        .loading-spinner { 
            width: 60px; height: 60px; 
            border: 4px solid var(--pink-light); 
            border-top-color: var(--pink); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .navbar { 
            background: linear-gradient(135deg, var(--pink), var(--pink-dark)); 
            padding: 16px 20px; 
            color: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar h1 { font-size: 18px; margin-bottom: 6px; }
        .navbar p { font-size: 14px; opacity: 0.95; line-height: 1.6; }
        .staff-name {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        .info-card { 
            background: white;
            border-radius: 10px; 
            padding: 12px 15px; 
            margin-bottom: 15px; 
            border-left: 3px solid var(--pink);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .info-card h3 { font-size: 13px; color: var(--pink-dark); margin-bottom: 6px; }
        .info-card ul { margin-top: 6px; padding-left: 16px; }
        .info-card li { font-size: 11px; line-height: 1.5; color: #2d3748; margin-bottom: 2px; }

        .control-panel { 
            background: white; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        
        .month-selector { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .month-btn { 
            width: 40px; height: 40px; 
            border-radius: 10px; 
            border: none; 
            background: var(--pink); 
            color: white; 
            font-size: 18px; 
            cursor: pointer; 
        }
        .month-btn:active { transform: scale(0.95); background: var(--pink-dark); }
        .month-display { font-size: 20px; font-weight: 700; text-align: center; min-width: 150px; }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .stat-card { 
            background: white; 
            border-radius: 10px; 
            padding: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            border-left: 3px solid;
            text-align: center;
        }
        .stat-card.pink { border-left-color: var(--pink); }
        .stat-card.yellow { border-left-color: var(--yellow); }
        .stat-card.gray { border-left-color: var(--gray); }
        .stat-label { font-size: 11px; color: var(--gray); margin-bottom: 6px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-card.pink .stat-value { color: var(--pink); }
        .stat-card.yellow .stat-value { color: var(--yellow-dark); }
        .stat-card.gray .stat-value { color: var(--gray); }

        .legend { 
            background: white; 
            border-radius: 8px; 
            padding: 12px 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        .legend h4 { font-size: 12px; margin-bottom: 8px; color: var(--pink-dark); }
        .legend-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); 
            gap: 6px; 
        }
        .legend-item { 
            display: flex; align-items: center; gap: 6px; 
            padding: 6px 8px; background: #f8f9fa; border-radius: 5px; 
        }
        .legend-box { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }
        .legend-box.available { background: var(--pink); }
        .legend-box.not-selected { background: white; border: 2px solid #e9ecef; }
        .legend-box.weekend { background: var(--blue-light); border: 2px solid var(--blue); }
        .legend-box.holiday { background: var(--yellow-light); border: 2px solid var(--yellow); }
        .legend-label { font-size: 10px; font-weight: 600; }

        .calendar-container { 
            background: white; 
            border-radius: 12px; 
            padding: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            overflow-x: auto;
        }
        
        .calendar-header { 
            display: grid; 
            grid-template-columns: 50px repeat(7, 1fr); 
            gap: 2px; 
            margin-bottom: 8px; 
        }
        .calendar-header-cell { 
            text-align: center; 
            padding: 8px 4px; 
            font-weight: 700; 
            font-size: 12px;
            background: var(--pink-light); 
            border-radius: 6px; 
        }
        .calendar-header-cell:first-child { background: transparent; }
        .calendar-header-cell.weekend { background: var(--blue-light); color: var(--blue-dark); }

        .week-row { 
            display: grid; 
            grid-template-columns: 50px repeat(7, 1fr); 
            gap: 2px; 
            margin-bottom: 2px; 
        }
        .week-label { 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 600; font-size: 11px; color: var(--gray); 
            background: #f8f9fa; border-radius: 6px; 
        }

        .day-cell { 
            min-height: 70px; 
            padding: 6px; 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s;
        }
        .day-cell:active { transform: scale(0.98); }
        .day-cell.weekend { background: var(--blue-light); border-color: var(--blue); }
        .day-cell.holiday { background: var(--yellow-light); border-color: var(--yellow); }
        .day-cell.today { border-color: var(--pink); border-width: 3px; box-shadow: 0 0 0 1px var(--pink); }
        
        /* å¯ä¸Šç­æ¨£å¼ */
        .day-cell.available { background: var(--pink); border-color: var(--pink-dark); }
        .day-cell.available .day-number { color: white; }
        .day-cell.available .status-label { color: white; opacity: 0.9; }

        .shift-badges { display: flex; gap: 3px; margin-top: 4px; flex-wrap: wrap; }
        .shift-badge { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600; }
        .day-cell.available .shift-badge { background: rgba(255,255,255,0.3); color: white; }

        .day-header { display: flex; align-items: flex-start; gap: 4px; margin-bottom: 3px; }
        .day-number { font-size: 14px; font-weight: 700; }
        .day-cell.weekend .day-number { color: var(--blue-dark); }
        .day-cell.holiday .day-number { color: var(--yellow-dark); }
        .status-label { font-size: 10px; font-weight: 600; display: block; }
        .holiday-label { color: var(--yellow-dark); }
        .weekend-label { color: var(--blue-dark); }
        .available-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }

        /* Modal */
        .shift-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1500;
            align-items: center; justify-content: center;
        }
        .shift-modal.show { display: flex; }
        .shift-modal-content {
            background: white; border-radius: 16px; padding: 20px;
            max-width: 90%; width: 320px; max-height: 80vh; overflow-y: auto;
        }
        .shift-modal-header { font-size: 16px; font-weight: 700; color: var(--pink-dark); margin-bottom: 8px; }
        .shift-modal-date { font-size: 14px; color: var(--gray); margin-bottom: 16px; }
        .shift-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
        .shift-option {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border: 2px solid #e9ecef; border-radius: 10px; cursor: pointer;
            border-left-width: 5px;
        }
        .shift-option:active { transform: scale(0.98); }
        .shift-option.selected { border-color: var(--pink); background: var(--pink-light); }
        .shift-option-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--gray);
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .shift-option.selected .shift-option-checkbox { background: var(--pink); border-color: var(--pink); }
        .shift-option.selected .shift-option-checkbox::after { content: 'âœ“'; color: white; font-weight: 700; }
        .shift-option-label { flex: 1; }
        .shift-option-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .shift-option-time { font-size: 11px; color: var(--gray); }
        .shift-option-color { width: 20px; height: 20px; border-radius: 4px; flex-shrink: 0; }
        .shift-modal-buttons { display: flex; gap: 8px; }
        .shift-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .shift-modal-btn.cancel { background: #e9ecef; color: #495057; }
        .shift-modal-btn.confirm { background: var(--pink); color: white; }

        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn { 
            flex: 1; padding: 14px; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--pink); color: white; }
        .btn-secondary { background: var(--green-light); color: var(--green-dark); }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: 700; color: var(--pink-dark); margin-bottom: 16px; }
        .date-list { max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px; }
        .date-item { padding: 8px 12px; margin-bottom: 6px; background: white; border-radius: 6px; border-left: 3px solid var(--pink); font-size: 13px; }
        .modal-summary { font-size: 14px; padding: 12px; background: var(--pink-light); border-radius: 8px; margin-bottom: 16px; color: var(--pink-dark); font-weight: 600; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .modal-btn-confirm { background: var(--pink); color: white; }
        .modal-btn-cancel { background: #e9ecef; color: #495057; }

        .toast { 
            position: fixed; bottom: 20px; left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: #2d3748; color: white; padding: 12px 18px; 
            border-radius: 10px; z-index: 2000; transition: transform 0.3s; 
            font-weight: 500; max-width: 90%;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        .api-setup {
            background: var(--yellow-light); border: 2px solid var(--yellow);
            border-radius: 10px; padding: 15px; margin-bottom: 15px;
        }
        .api-setup h3 { font-size: 14px; color: var(--yellow-dark); margin-bottom: 10px; }
        .api-setup input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .api-setup .btn { width: 100%; }

        @media (min-width: 768px) {
            .navbar h1 { font-size: 20px; }
            .month-display { font-size: 24px; min-width: 200px; }
            .day-cell { min-height: 80px; padding: 8px; }
            .modal { max-width: 500px; }
        }
        @media (max-width: 374px) {
            .navbar h1 { font-size: 16px; }
            .month-display { font-size: 18px; min-width: 130px; }
            .day-cell { min-height: 60px; padding: 4px; }
            .day-number { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div style="margin-top: 20px; font-weight: 600; font-size: 14px;">æ­£åœ¨è¼‰å…¥...</div>
    </div>

    <div class="main-content" id="mainContent" style="display:none;">
        <nav class="navbar">
            <h1>ğŸ“‹ è¡¡é»-å€‹äººæ’ç­ç³»çµ±</h1>
            <p id="staffNameDisplay">è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ</p>
        </nav>

        <div class="container">
            <div class="control-panel">
                <div class="month-selector">
                    <button class="month-btn" onclick="previousMonth()">â—€</button>
                    <div class="month-display" id="monthDisplay">2025 å¹´ 1 æœˆ</div>
                    <button class="month-btn" onclick="nextMonth()">â–¶</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card pink">
                        <div class="stat-label">å¯ä¸Šç­</div>
                        <div class="stat-value" id="availableCount">0</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-label">åœ‹å®šå‡æ—¥</div>
                        <div class="stat-value" id="holidayCount">0</div>
                    </div>
                    <div class="stat-card gray">
                        <div class="stat-label">æœªæ¨™è¨˜</div>
                        <div class="stat-value" id="unmarkedCount">0</div>
                    </div>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar">
                    <div class="calendar-header">
                        <div class="calendar-header-cell"></div>
                        <div class="calendar-header-cell weekend">æ—¥</div>
                        <div class="calendar-header-cell">ä¸€</div>
                        <div class="calendar-header-cell">äºŒ</div>
                        <div class="calendar-header-cell">ä¸‰</div>
                        <div class="calendar-header-cell">å››</div>
                        <div class="calendar-header-cell">äº”</div>
                        <div class="calendar-header-cell weekend">å…­</div>
                    </div>
                    <div id="calendarBody"></div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
                <button class="btn btn-primary" onclick="showConfirmModal()">âœ… é€å‡º</button>
            </div>

            <div class="info-card" style="margin-top: 15px;">
                <h3>ğŸ’¡ ä½¿ç”¨èªªæ˜</h3>
                <ul>
                    <li>é»æ“Šæ—¥æœŸé¸æ“‡ã€Œå¯ä»¥ä¸Šç­ã€çš„æ™‚æ®µ</li>
                    <li>å¦‚æœæ•´å¤©éƒ½å¯ä»¥ä¸Šç­ï¼Œé¸æ“‡ã€Œæ•´å¤©å¯ä¸Šç­ã€</li>
                    <li>å®Œæˆå¾Œé»æ“Šã€Œé€å‡ºã€æŒ‰éˆ•</li>
                </ul>
            </div>

            <div class="legend" style="margin-top: 10px;">
                <h4>ğŸ¨ ç‹€æ…‹èªªæ˜</h4>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-box available"></div>
                        <span class="legend-label">å¯ä¸Šç­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box not-selected"></div>
                        <span class="legend-label">æœªæ¨™è¨˜</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box weekend"></div>
                        <span class="legend-label">é€±æœ«</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box holiday"></div>
                        <span class="legend-label">å‡æ—¥</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="shift-modal" id="shiftModal">
        <div class="shift-modal-content">
            <div class="shift-modal-header">âœ… é¸æ“‡å¯ä¸Šç­çš„æ™‚æ®µ</div>
            <div class="shift-modal-date" id="shiftModalDate">2025-01-15 (é€±äº”)</div>
            <div class="shift-options" id="shiftOptionsContainer"></div>
            <div class="shift-modal-buttons">
                <button class="shift-modal-btn cancel" onclick="closeShiftModal()">å–æ¶ˆ</button>
                <button class="shift-modal-btn confirm" onclick="confirmShiftSelection()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">ğŸ“‹ ç¢ºèªé€å‡º</div>
            <div class="modal-content">
                <div class="modal-summary" id="modalSummary">å…± 0 å¤©å¯ä»¥ä¸Šç­</div>
                <div class="date-list" id="dateList"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmSubmit()">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============ è¨­å®šå€ ============
        const API_URL = 'https://script.google.com/macros/s/AKfycbzXyvvSXR5mw4bROb6kWI8S5mz6g2TQ-VvlvEYgvW3fDXaPfB932Y-tTd2IUMHVY_LO/exec';
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let holidays = [];
        let availableDates = {};
        let staffName = '';
        let currentEditingDate = null;
        let shifts = [];

        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            staffName = urlParams.get('name') || urlParams.get('staff') || '';
            
            if (!staffName) {
                document.getElementById('staffNameDisplay').innerHTML = 'âš ï¸ è«‹å¾ç®¡ç†å“¡æä¾›çš„é€£çµé€²å…¥';
            } else {
                document.getElementById('staffNameDisplay').innerHTML = 
                    `<span class="staff-name">${staffName}</span> è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ`;
            }
            
            await loadShifts();
            holidays = await fetchHolidays(currentYear);
            loadLocalData();
            generateCalendar();
            updateStats();
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').style.display = 'block';
        };

        async function loadShifts() {
            if (!API_URL) return;
            try {
                const res = await fetch(API_URL + '?action=getShifts');
                const data = await res.json();
                if (data.success && data.shifts) { shifts = data.shifts; }
            } catch (e) {
                shifts = [
                    { id: 'shift1', name: 'åˆç­', time: '12:00-18:00', color: '#9fcccc' },
                    { id: 'shift2', name: 'æ™šç­', time: '18:00-22:00', color: '#a78bfa' }
                ];
            }
        }

        async function fetchHolidays(year) {
            // é€é Apps Script ä»£ç†å–å¾—å‡æ—¥è³‡æ–™ï¼ˆé¿å… CORSï¼‰
            try {
                const res = await fetch(API_URL + '?action=getHolidays&year=' + year);
                const data = await res.json();
                if (data.success && data.holidays) {
                    console.log('å·²è¼‰å…¥ ' + year + ' å¹´å‡æ—¥ï¼š', data.holidays.length + ' ç­†');
                    return data.holidays;
                }
            } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—', e);
            }
            return [];
        }

        function generateCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            document.getElementById('monthDisplay').textContent = `${currentYear} å¹´ ${currentMonth + 1} æœˆ`;
            
            const firstDayOfWeek = firstDay.getDay();
            const totalCells = Math.ceil((firstDayOfWeek + lastDay.getDate()) / 7) * 7;
            const calendarDays = [];
            let dayCounter = 1 - firstDayOfWeek;
            for (let i = 0; i < totalCells; i++) { calendarDays.push(new Date(currentYear, currentMonth, dayCounter++)); }
            
            const body = document.getElementById('calendarBody');
            body.innerHTML = '';
            
            for (let week = 0; week < calendarDays.length / 7; week++) {
                const row = document.createElement('div');
                row.className = 'week-row';
                row.innerHTML = `<div class="week-label">W${week + 1}</div>`;
                for (let day = 0; day < 7; day++) { row.appendChild(createDayCell(calendarDays[week * 7 + day])); }
                body.appendChild(row);
            }
        }

        function createDayCell(date) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            
            const isCurrentMonth = date.getMonth() === currentMonth;
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const dateStr = formatDate(date);
            const isToday = dateStr === formatDate(new Date());
            const holidayInfo = holidays.find(h => h.date === dateStr);
            const availData = availableDates[dateStr];
            
            if (!isCurrentMonth) cell.style.opacity = '0.5';
            if (holidayInfo) cell.classList.add('holiday');
            else if (isWeekend) cell.classList.add('weekend');
            if (isToday) cell.classList.add('today');
            
            const isAvailable = availData && (availData.allDay || (availData.shifts && availData.shifts.length > 0));
            if (isAvailable) cell.classList.add('available');
            
            let html = `<div class="day-header"><div class="day-number">${date.getDate()}</div></div>`;
            if (holidayInfo) html += `<span class="status-label holiday-label">${holidayInfo.name}</span>`;
            else if (isWeekend) html += `<span class="status-label weekend-label">ä¼‘</span>`;
            
            if (availData) {
                html += '<div class="shift-badges">';
                if (availData.allDay) {
                    html += `<div class="available-icon">âœ“</div>`;
                } else if (availData.shifts && availData.shifts.length > 0) {
                    availData.shifts.forEach(shiftId => {
                        const shift = shifts.find(s => s.id === shiftId);
                        if (shift) html += `<span class="shift-badge" style="background: ${shift.color}; color: white;">${shift.name}</span>`;
                    });
                }
                html += '</div>';
            }
            
            cell.innerHTML = html;
            if (isCurrentMonth) cell.onclick = () => openShiftModal(dateStr);
            return cell;
        }

        function renderShiftOptions() {
            const container = document.getElementById('shiftOptionsContainer');
            let html = `
                <div class="shift-option" id="allDayOption" onclick="toggleShiftOption('allDay')">
                    <div class="shift-option-checkbox"></div>
                    <div class="shift-option-label">
                        <div class="shift-option-title">âœ… æ•´å¤©å¯ä¸Šç­</div>
                        <div class="shift-option-time">å…¨å¤©éƒ½å¯ä»¥æ’ç­</div>
                    </div>
                </div>
            `;
            shifts.forEach(shift => {
                html += `
                    <div class="shift-option" id="shift_${shift.id}_option" onclick="toggleShiftOption('${shift.id}')" style="border-left: 4px solid ${shift.color};">
                        <div class="shift-option-checkbox"></div>
                        <div class="shift-option-label">
                            <div class="shift-option-title">${shift.name}</div>
                            <div class="shift-option-time">${shift.time}</div>
                        </div>
                        <div class="shift-option-color" style="background: ${shift.color}; width: 20px; height: 20px; border-radius: 4px;"></div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function openShiftModal(dateStr) {
            currentEditingDate = dateStr;
            const date = new Date(dateStr);
            const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            document.getElementById('shiftModalDate').textContent = `${dateStr} (é€±${dayOfWeek})`;
            renderShiftOptions();
            
            const data = availableDates[dateStr] || { allDay: false, shifts: [] };
            if (data.allDay) document.getElementById('allDayOption').classList.add('selected');
            if (data.shifts) {
                data.shifts.forEach(shiftId => {
                    const el = document.getElementById(`shift_${shiftId}_option`);
                    if (el) el.classList.add('selected');
                });
            }
            document.getElementById('shiftModal').classList.add('show');
        }

        function closeShiftModal() {
            document.getElementById('shiftModal').classList.remove('show');
            currentEditingDate = null;
        }

        function toggleShiftOption(optionId) {
            if (optionId === 'allDay') {
                const option = document.getElementById('allDayOption');
                if (!option.classList.contains('selected')) {
                    shifts.forEach(shift => {
                        const el = document.getElementById(`shift_${shift.id}_option`);
                        if (el) el.classList.remove('selected');
                    });
                }
                option.classList.toggle('selected');
            } else {
                document.getElementById('allDayOption').classList.remove('selected');
                const option = document.getElementById(`shift_${optionId}_option`);
                if (option) option.classList.toggle('selected');
            }
        }

        function confirmShiftSelection() {
            const allDaySelected = document.getElementById('allDayOption').classList.contains('selected');
            const selectedShifts = [];
            shifts.forEach(shift => {
                const el = document.getElementById(`shift_${shift.id}_option`);
                if (el && el.classList.contains('selected')) selectedShifts.push(shift.id);
            });
            
            if (allDaySelected || selectedShifts.length > 0) {
                availableDates[currentEditingDate] = { allDay: allDaySelected, shifts: selectedShifts };
                let msg = 'âœ… å·²æ¨™è¨˜å¯ä¸Šç­: ';
                if (allDaySelected) msg += 'æ•´å¤©';
                else msg += selectedShifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+');
                showToast(msg);
            } else {
                delete availableDates[currentEditingDate];
                showToast('âœ“ å·²å–æ¶ˆæ¨™è¨˜');
            }
            
            closeShiftModal();
            saveLocalData();
            generateCalendar();
            updateStats();
        }

        function updateStats() {
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            let workDays = 0, holidayCount = 0, availableCount = 0;
            
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const date = new Date(currentYear, currentMonth, d);
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const holidayInfo = holidays.find(h => h.date === dateStr);
                
                if (holidayInfo) holidayCount++;
                else if (!isWeekend) {
                    workDays++;
                    const data = availableDates[dateStr];
                    if (data && (data.allDay || (data.shifts && data.shifts.length > 0))) availableCount++;
                }
            }
            
            document.getElementById('availableCount').textContent = availableCount;
            document.getElementById('holidayCount').textContent = holidayCount;
            document.getElementById('unmarkedCount').textContent = workDays - availableCount;
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; fetchHolidays(currentYear).then(h => { holidays = h; generateCalendar(); updateStats(); }); }
            else { generateCalendar(); updateStats(); }
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; fetchHolidays(currentYear).then(h => { holidays = h; generateCalendar(); updateStats(); }); }
            else { generateCalendar(); updateStats(); }
        }

        function saveLocalData() { localStorage.setItem(`available_${staffName}`, JSON.stringify(availableDates)); }
        function loadLocalData() { const saved = localStorage.getItem(`available_${staffName}`); if (saved) availableDates = JSON.parse(saved); }

        function clearAll() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¨™è¨˜å—ï¼Ÿ')) return;
            availableDates = {};
            saveLocalData();
            generateCalendar();
            updateStats();
            showToast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ¨™è¨˜');
        }

        function showConfirmModal() {
            const availableList = Object.keys(availableDates)
                .filter(dateStr => {
                    const data = availableDates[dateStr];
                    return data && (data.allDay || (data.shifts && data.shifts.length > 0));
                })
                .sort()
                .map(dateStr => {
                    const date = new Date(dateStr);
                    const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
                    const data = availableDates[dateStr];
                    let shiftDisplay = 'æ•´å¤©';
                    if (!data.allDay && data.shifts && data.shifts.length > 0) {
                        shiftDisplay = data.shifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+');
                    }
                    return { date: dateStr, dayOfWeek, shiftDisplay };
                });
            
            document.getElementById('modalSummary').textContent = `å…± ${availableList.length} å¤©å¯ä»¥ä¸Šç­`;
            document.getElementById('dateList').innerHTML = availableList.length === 0 
                ? '<div style="text-align: center; padding: 20px; color: #666;">å°šæœªæ¨™è¨˜ä»»ä½•å¯ä¸Šç­çš„æ—¥æœŸ</div>'
                : availableList.map(item => `<div class="date-item">${item.date} (é€±${item.dayOfWeek}) - ${item.shiftDisplay}</div>`).join('');
            
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeConfirmModal() { document.getElementById('modalOverlay').classList.remove('show'); }

        async function confirmSubmit() {
            closeConfirmModal();
            if (!API_URL) { showToast('âŒ API æœªè¨­å®š'); return; }
            if (!staffName) { showToast('âŒ è«‹å¾æ­£ç¢ºçš„é€£çµé€²å…¥'); return; }
            
            // ç”¨æ›è¡Œåˆ†éš”æ¯å€‹æ—¥æœŸ
            let availabilityArr = [];
            Object.keys(availableDates).sort().forEach(dateStr => {
                const data = availableDates[dateStr];
                if (data && (data.allDay || (data.shifts && data.shifts.length > 0))) {
                    if (data.allDay) {
                        availabilityArr.push(`${dateStr}(æ•´å¤©)`);
                    } else {
                        const shiftNames = data.shifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+');
                        availabilityArr.push(`${dateStr}(${shiftNames})`);
                    }
                }
            });
            const availabilityStr = availabilityArr.join('\n');
            
            showToast('ğŸ“¤ æ­£åœ¨é€å‡º...');
            
            try {
                // ä½¿ç”¨ GET + URL åƒæ•¸æ–¹å¼é¿å… CORS å•é¡Œ
                const payload = encodeURIComponent(JSON.stringify({ staffName, availability: availabilityStr }));
                const res = await fetch(API_URL + '?action=updateAvailability&data=' + payload);
                const data = await res.json();
                showToast(data.success ? 'âœ… å·²é€å‡ºï¼' : 'âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
            } catch (e) {
                console.error('é€å‡ºå¤±æ•—', e);
                showToast('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
