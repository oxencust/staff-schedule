<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡¡é»-å€‹äººæ’ç­ç³»çµ±</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        :root {
            --white: #ffffff;
            --gray: #808080;
            --green: #7ac19a;
            --green-light: #e2ede6;
            --green-dark: #5f846f;
            --pink: #f2ac98;
            --pink-light: #faece8;
            --pink-dark: #c67566;
            --yellow: #ffe08b;
            --yellow-light: #fcf4e3;
            --yellow-dark: #ba9e60;
            --blue: #9fcccc;
            --blue-light: #daedec;
            --blue-dark: #66888e;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: #f8f9fa; 
            color: #2d3748; 
            padding-bottom: 20px;
            overflow-x: hidden;
        }
        
        .loading-screen { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: linear-gradient(135deg, var(--pink-light), var(--blue-light)); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
        }
        .loading-screen.hidden { display: none; }
        .loading-spinner { 
            width: 60px; height: 60px; 
            border: 4px solid var(--pink-light); 
            border-top-color: var(--pink); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .navbar { 
            background: linear-gradient(135deg, var(--pink), var(--pink-dark)); 
            padding: 16px 20px; 
            color: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .navbar h1 { font-size: 18px; margin-bottom: 6px; }
        .navbar p { font-size: 14px; opacity: 0.95; line-height: 1.6; }
        .staff-name {
            font-weight: 700;
            font-size: 16px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        .info-card { 
            background: white;
            border-radius: 10px; 
            padding: 12px 15px; 
            margin-bottom: 15px; 
            border-left: 3px solid var(--pink);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .info-card h3 { font-size: 13px; color: var(--pink-dark); margin-bottom: 6px; }
        .info-card ul { margin-top: 6px; padding-left: 16px; }
        .info-card li { font-size: 11px; line-height: 1.5; color: #2d3748; margin-bottom: 2px; }

        .control-panel { 
            background: white; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        
        .month-selector { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .month-btn { 
            width: 40px; height: 40px; 
            border-radius: 10px; 
            border: none; 
            background: var(--pink); 
            color: white; 
            font-size: 18px; 
            cursor: pointer; 
        }
        .month-btn:active { transform: scale(0.95); background: var(--pink-dark); }
        .month-display { font-size: 20px; font-weight: 700; text-align: center; min-width: 150px; }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .stat-card { 
            background: white; 
            border-radius: 10px; 
            padding: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            border-left: 3px solid;
            text-align: center;
        }
        .stat-card.pink { border-left-color: var(--pink); }
        .stat-card.yellow { border-left-color: var(--yellow); }
        .stat-card.gray { border-left-color: var(--gray); }
        .stat-label { font-size: 11px; color: var(--gray); margin-bottom: 6px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-card.pink .stat-value { color: var(--pink); }
        .stat-card.yellow .stat-value { color: var(--yellow-dark); }
        .stat-card.gray .stat-value { color: var(--gray); }

        .legend { 
            background: white; 
            border-radius: 8px; 
            padding: 12px 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        .legend h4 { font-size: 12px; margin-bottom: 8px; color: var(--pink-dark); }
        .legend-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); 
            gap: 6px; 
        }
        .legend-item { 
            display: flex; align-items: center; gap: 6px; 
            padding: 6px 8px; background: #f8f9fa; border-radius: 5px; 
        }
        .legend-box { width: 14px; height: 14px; border-radius: 3px; flex-shrink: 0; }
        .legend-box.available { background: var(--pink); }
        .legend-box.not-selected { background: white; border: 2px solid #e9ecef; }
        .legend-box.weekend { background: var(--blue-light); border: 2px solid var(--blue); }
        .legend-box.holiday { background: var(--yellow-light); border: 2px solid var(--yellow); }
        .legend-label { font-size: 10px; font-weight: 600; }

        .calendar-container { 
            background: white; 
            border-radius: 12px; 
            padding: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
            overflow-x: auto;
        }
        
        .calendar-header { 
            display: grid; 
            grid-template-columns: 50px repeat(7, 1fr); 
            gap: 2px; 
            margin-bottom: 8px; 
        }
        .calendar-header-cell { 
            text-align: center; 
            padding: 8px 4px; 
            font-weight: 700; 
            font-size: 12px;
            background: var(--pink-light); 
            border-radius: 6px; 
        }
        .calendar-header-cell:first-child { background: transparent; }
        .calendar-header-cell.weekend { background: var(--blue-light); color: var(--blue-dark); }

        .week-row { 
            display: grid; 
            grid-template-columns: 50px repeat(7, 1fr); 
            gap: 2px; 
            margin-bottom: 2px; 
        }
        .week-label { 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 600; font-size: 11px; color: var(--gray); 
            background: #f8f9fa; border-radius: 6px; 
        }

        .day-cell { 
            min-height: 70px; 
            padding: 6px; 
            background: white; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.2s;
        }
        .day-cell:active { transform: scale(0.98); }
        .day-cell.weekend { background: var(--blue-light); border-color: var(--blue); }
        .day-cell.holiday { background: var(--yellow-light); border-color: var(--yellow); }
        .day-cell.today { border-color: var(--pink); border-width: 3px; box-shadow: 0 0 0 1px var(--pink); }
        
        /* å¯ä¸Šç­æ¨£å¼ */
        .day-cell.available { background: var(--pink); border-color: var(--pink-dark); }
        .day-cell.available .day-number { color: white; }
        .day-cell.available .status-label { color: white; opacity: 0.9; }

        .shift-badges { display: flex; gap: 3px; margin-top: 4px; flex-wrap: wrap; }
        .shift-badge { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 600; }
        .day-cell.available .shift-badge { background: rgba(255,255,255,0.3); color: white; }

        .day-header { display: flex; align-items: flex-start; gap: 4px; margin-bottom: 3px; }
        .day-number { font-size: 14px; font-weight: 700; }
        .day-cell.weekend .day-number { color: var(--blue-dark); }
        .day-cell.holiday .day-number { color: var(--yellow-dark); }
        .status-label { font-size: 10px; font-weight: 600; display: block; }
        .holiday-label { color: var(--yellow-dark); }
        .weekend-label { color: var(--blue-dark); }
        .available-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; }

        /* Modal */
        .shift-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1500;
            align-items: center; justify-content: center;
        }
        .shift-modal.show { display: flex; }
        .shift-modal-content {
            background: white; border-radius: 16px; padding: 20px;
            max-width: 90%; width: 320px; max-height: 80vh; overflow-y: auto;
        }
        .shift-modal-header { font-size: 16px; font-weight: 700; color: var(--pink-dark); margin-bottom: 8px; }
        .shift-modal-date { font-size: 14px; color: var(--gray); margin-bottom: 16px; }
        .shift-options { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
        .shift-option {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border: 2px solid #e9ecef; border-radius: 10px; cursor: pointer;
            border-left-width: 5px;
        }
        .shift-option:active { transform: scale(0.98); }
        .shift-option.selected { border-color: var(--pink); background: var(--pink-light); }
        .shift-option-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--gray);
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .shift-option.selected .shift-option-checkbox { background: var(--pink); border-color: var(--pink); }
        .shift-option.selected .shift-option-checkbox::after { content: 'âœ“'; color: white; font-weight: 700; }
        .shift-option-label { flex: 1; }
        .shift-option-title { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .shift-option-time { font-size: 11px; color: var(--gray); }
        .shift-option-color { width: 20px; height: 20px; border-radius: 4px; flex-shrink: 0; }
        
        /* å…¶ä»–ç­åˆ¥è‡ªè¨‚æ™‚é–“ */
        .custom-shift-inputs { display: none; margin-top: 10px; padding: 12px; background: #f8f9fa; border-radius: 8px; }
        .custom-shift-inputs.show { display: block; }
        .custom-time-row { display: flex; align-items: center; gap: 8px; }
        .custom-time-input { flex: 1; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; text-align: center; font-family: monospace; }
        .custom-time-input:focus { outline: none; border-color: var(--pink); }
        .custom-time-separator { font-weight: 600; color: #666; }
        .shift-modal-buttons { display: flex; gap: 8px; }
        .shift-modal-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .shift-modal-btn.cancel { background: #e9ecef; color: #495057; }
        .shift-modal-btn.confirm { background: var(--pink); color: white; }

        .submit-section { display: flex; gap: 10px; margin-top: 15px; }
        .btn { 
            flex: 1; padding: 14px; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--pink); color: white; }
        .btn-secondary { background: var(--green-light); color: var(--green-dark); }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); z-index: 1000;
            align-items: center; justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 24px; max-width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: 700; color: var(--pink-dark); margin-bottom: 16px; }
        .date-list { max-height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 12px; }
        .date-item { padding: 8px 12px; margin-bottom: 6px; background: white; border-radius: 6px; border-left: 3px solid var(--pink); font-size: 13px; }
        .modal-summary { font-size: 14px; padding: 12px; background: var(--pink-light); border-radius: 8px; margin-bottom: 16px; color: var(--pink-dark); font-weight: 600; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; font-family: inherit; }
        .modal-btn-confirm { background: var(--pink); color: white; }
        .modal-btn-cancel { background: #e9ecef; color: #495057; }

        .toast { 
            position: fixed; bottom: 20px; left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: #2d3748; color: white; padding: 12px 18px; 
            border-radius: 10px; z-index: 2000; transition: transform 0.3s; 
            font-weight: 500; max-width: 90%;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        .api-setup {
            background: var(--yellow-light); border: 2px solid var(--yellow);
            border-radius: 10px; padding: 15px; margin-bottom: 15px;
        }
        .api-setup h3 { font-size: 14px; color: var(--yellow-dark); margin-bottom: 10px; }
        .api-setup input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .api-setup .btn { width: 100%; }

        /* ========== æ‰‹æ©Ÿç‰ˆå„ªåŒ– ========== */
        @media (min-width: 768px) {
            .navbar h1 { font-size: 20px; }
            .month-display { font-size: 24px; min-width: 200px; }
            .day-cell { min-height: 80px; padding: 8px; }
            .modal { max-width: 500px; }
            .container { padding-bottom: 20px; }
        }

        @media (max-width: 767px) {
            .navbar { padding: 12px 15px; }
            .navbar h1 { font-size: 17px; }
            
            .container { padding: 10px; }
            
            /* æ§åˆ¶é¢æ¿ */
            .control-panel { padding: 12px; border-radius: 10px; margin-bottom: 10px; }
            .staff-name-display { font-size: 14px; }
            .staff-name { font-size: 16px; }
            
            /* æœˆä»½é¸æ“‡å™¨ */
            .month-selector { margin-bottom: 10px; }
            .month-btn { padding: 10px 14px; font-size: 16px; min-width: 44px; }
            .month-display { font-size: 18px; min-width: 140px; }
            
            /* çµ±è¨ˆå€ */
            .stats-bar { padding: 10px; gap: 8px; margin-bottom: 10px; }
            .stat-item { padding: 8px 12px; }
            .stat-value { font-size: 18px; }
            .stat-label { font-size: 10px; }
            
            /* æ—¥æ›† */
            .calendar-wrapper { padding: 8px; border-radius: 10px; }
            .calendar { gap: 3px; }
            .calendar-header { padding: 8px 2px; font-size: 13px; font-weight: 600; }
            .day-cell { 
                min-height: 55px; 
                padding: 4px; 
                border-radius: 6px;
                -webkit-tap-highlight-color: transparent;
            }
            .day-cell:active { transform: scale(0.95); }
            .day-number { font-size: 13px; font-weight: 700; }
            .holiday-name { font-size: 8px; margin-top: 1px; }
            .shift-badges { gap: 2px; margin-top: 2px; }
            .shift-badge { font-size: 8px; padding: 1px 4px; }
            
            /* åº•éƒ¨æŒ‰éˆ• */
            .submit-section {
                background: white;
                padding: 12px 15px;
                margin-top: 15px;
            }
            .btn-submit { 
                padding: 14px 20px; 
                font-size: 16px; 
                border-radius: 12px;
                width: 100%;
            }
            
            /* Modal å„ªåŒ– */
            .modal-overlay { align-items: flex-end; }
            .modal { 
                max-width: 100%; 
                width: 100%; 
                border-radius: 20px 20px 0 0; 
                max-height: 80vh; 
                padding: 20px 15px 30px;
            }
            .modal h3 { font-size: 18px; text-align: center; }
            .modal-date { font-size: 14px; }
            
            /* ç­åˆ¥é¸é … */
            .shift-options-container { gap: 8px; }
            .shift-option { 
                padding: 14px 12px; 
                border-radius: 10px;
                -webkit-tap-highlight-color: transparent;
            }
            .shift-option:active { transform: scale(0.98); }
            .shift-option-checkbox { width: 22px; height: 22px; }
            .shift-option-title { font-size: 15px; }
            .shift-option-time { font-size: 12px; }
            
            .modal-buttons { gap: 10px; margin-top: 15px; }
            .modal-buttons .btn { 
                padding: 14px 20px; 
                font-size: 15px; 
                border-radius: 10px;
                min-height: 48px;
            }
            
            /* ç¢ºèª Modal */
            .confirm-content { padding: 15px; }
            .confirm-content p { font-size: 14px; line-height: 1.6; }
        }

        @media (max-width: 374px) {
            .navbar h1 { font-size: 15px; }
            .month-display { font-size: 16px; min-width: 120px; }
            .month-btn { padding: 8px 12px; font-size: 14px; }
            .day-cell { min-height: 50px; padding: 3px; }
            .day-number { font-size: 12px; }
            .holiday-name { font-size: 7px; }
            .shift-badge { font-size: 7px; padding: 1px 3px; }
            .stat-value { font-size: 16px; }
            .stat-label { font-size: 9px; }
            .shift-option { padding: 12px 10px; }
            .shift-option-title { font-size: 14px; }
        }

        /* è§¸æ§å„ªåŒ– */
        @media (hover: none) and (pointer: coarse) {
            .day-cell:hover { border-color: inherit; box-shadow: none; }
            .day-cell.available:hover { border-color: var(--pink); }
            .month-btn:hover { background: var(--pink); }
            .btn:hover { filter: none; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div style="margin-top: 20px; font-weight: 600; font-size: 14px;">æ­£åœ¨è¼‰å…¥...</div>
    </div>

    <div class="main-content" id="mainContent" style="display:none;">
        <nav class="navbar">
            <h1>ğŸ“‹ è¡¡é»-å€‹äººæ’ç­ç³»çµ±</h1>
            <p id="staffNameDisplay">è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ</p>
        </nav>

        <div class="container">
            <!-- å›å¡«æ¨¡å¼æç¤ºæ¢ -->
            <div id="overtimeModeBar" style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                <div style="font-weight: 600; margin-bottom: 5px;">ğŸ“‹ åŠ ç­å›å¡«æ¨¡å¼</div>
                <div style="font-size: 12px; opacity: 0.9;">é»é¸æ—¥æ›†ä¸Šçš„æ—¥æœŸå›å¡«åŠ ç­æ™‚é–“</div>
            </div>
            
            <div class="control-panel">
                <div class="month-selector">
                    <button class="month-btn" onclick="previousMonth()">â—€</button>
                    <div class="month-display" id="monthDisplay">2025 å¹´ 1 æœˆ</div>
                    <button class="month-btn" onclick="nextMonth()">â–¶</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card pink">
                        <div class="stat-label">å¯ä¸Šç­</div>
                        <div class="stat-value" id="availableCount">0</div>
                    </div>
                    <div class="stat-card yellow">
                        <div class="stat-label">åœ‹å®šå‡æ—¥</div>
                        <div class="stat-value" id="holidayCount">0</div>
                    </div>
                    <div class="stat-card gray">
                        <div class="stat-label">æœªæ¨™è¨˜</div>
                        <div class="stat-value" id="unmarkedCount">0</div>
                    </div>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar">
                    <div class="calendar-header">
                        <div class="calendar-header-cell"></div>
                        <div class="calendar-header-cell weekend">æ—¥</div>
                        <div class="calendar-header-cell">ä¸€</div>
                        <div class="calendar-header-cell">äºŒ</div>
                        <div class="calendar-header-cell">ä¸‰</div>
                        <div class="calendar-header-cell">å››</div>
                        <div class="calendar-header-cell">äº”</div>
                        <div class="calendar-header-cell weekend">å…­</div>
                    </div>
                    <div id="calendarBody"></div>
                </div>
            </div>

            <div class="submit-section">
                <!-- å›å¡«åŠ ç­æŒ‰éˆ•ï¼ˆ1-5è™Ÿé¡¯ç¤ºï¼Œéå›å¡«æ¨¡å¼æ™‚ï¼‰ -->
                <div id="overtimeEntryBtn" style="display: none; margin-bottom: 10px;">
                    <button class="btn" onclick="enterOvertimeMode()" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px; font-weight: 600;">
                        ğŸ“‹ å›å¡«ä¸ŠæœˆåŠ ç­æ™‚é–“
                    </button>
                </div>
                <!-- å®Œæˆå›å¡«æŒ‰éˆ•ï¼ˆå›å¡«æ¨¡å¼æ™‚é¡¯ç¤ºï¼‰ -->
                <div id="overtimeExitBtn" style="display: none;">
                    <button class="btn" onclick="exitOvertimeMode()" style="width: 100%; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px; font-weight: 600;">
                        âœ“ å®Œæˆå›å¡«ï¼Œè¿”å›æ’ç­
                    </button>
                </div>
                <!-- æ­£å¸¸æ¨¡å¼æŒ‰éˆ• -->
                <div id="normalModeButtons" style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="clearAll()" style="flex: 1;">ğŸ—‘ï¸ æ¸…é™¤</button>
                    <button class="btn btn-primary btn-submit" onclick="showConfirmModal()" style="flex: 2;">âœ… é€å‡º</button>
                </div>
            </div>

            <div class="info-card" style="margin-top: 15px;">
                <h3>ğŸ’¡ ä½¿ç”¨èªªæ˜</h3>
                <ul>
                    <li>é»æ“Šæ—¥æœŸé¸æ“‡ã€Œå¯ä»¥ä¸Šç­ã€çš„æ™‚æ®µ</li>
                    <li>å¦‚æœæ•´å¤©éƒ½å¯ä»¥ä¸Šç­ï¼Œé¸æ“‡ã€Œæ•´å¤©å¯ä¸Šç­ã€</li>
                    <li>å®Œæˆå¾Œé»æ“Šã€Œé€å‡ºã€æŒ‰éˆ•</li>
                </ul>
            </div>

            <div class="legend" style="margin-top: 10px;">
                <h4>ğŸ¨ ç‹€æ…‹èªªæ˜</h4>
                <div class="legend-grid">
                    <div class="legend-item">
                        <div class="legend-box available"></div>
                        <span class="legend-label">å¯ä¸Šç­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box not-selected"></div>
                        <span class="legend-label">æœªæ¨™è¨˜</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box weekend"></div>
                        <span class="legend-label">é€±æœ«</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box holiday"></div>
                        <span class="legend-label">å‡æ—¥</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="shift-modal" id="shiftModal">
        <div class="shift-modal-content">
            <div class="shift-modal-header">âœ… é¸æ“‡å¯ä¸Šç­çš„æ™‚æ®µ</div>
            <div class="shift-modal-date" id="shiftModalDate">2025-01-15 (é€±äº”)</div>
            <div class="shift-options" id="shiftOptionsContainer"></div>
            <div class="shift-modal-buttons">
                <button class="shift-modal-btn cancel" onclick="closeShiftModal()">å–æ¶ˆ</button>
                <button class="shift-modal-btn confirm" onclick="confirmShiftSelection()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">ğŸ“‹ ç¢ºèªé€å‡º</div>
            <div class="modal-content">
                <div class="modal-summary" id="modalSummary">å…± 0 å¤©å¯ä»¥ä¸Šç­</div>
                <div class="date-list" id="dateList"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmSubmit()">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <!-- åŠ ç­å›å¡«æé†’ Modal -->
    <div class="modal-overlay" id="overtimeReminderModal">
        <div class="modal" style="max-width: 380px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                âš ï¸ åŠ ç­å›å¡«æé†’
            </div>
            <div class="modal-content" style="padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“‹</div>
                <div style="font-size: 15px; margin-bottom: 15px; line-height: 1.6;">
                    è«‹æ–¼ <strong style="color: #dc2626;">5 è™Ÿå‰</strong>å›å¡«ä¸ŠæœˆåŠ ç­æ™‚é–“<br>
                    <span style="color: #dc2626; font-weight: 600;">é€¾æ™‚ä¸å€™ï¼</span>
                </div>
                <div style="font-size: 13px; color: #666; background: #f3f4f6; padding: 12px; border-radius: 8px;">
                    è«‹åœ¨æ—¥æ›†ä¸Šé»é¸æœ‰åŠ ç­çš„æ—¥æœŸé€²è¡Œå›å¡«<br>
                    ï¼ˆåŒ…å«è‡¨æ™‚ä¸Šç­ï¼‰
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-confirm" onclick="confirmOvertimeReminder()" style="width: 100%;">æˆ‘çŸ¥é“äº†ï¼Œé–‹å§‹å›å¡«</button>
            </div>
        </div>
    </div>

    <!-- å–®ç­†åŠ ç­å›å¡« Modal -->
    <div class="modal-overlay" id="overtimeFillModal">
        <div class="modal" style="max-width: 350px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                â° å›å¡«åŠ ç­æ™‚é–“
            </div>
            <div class="modal-content" style="padding: 15px;">
                <div id="overtimeFillDate" style="font-size: 16px; font-weight: 600; margin-bottom: 15px; text-align: center;"></div>
                <div id="overtimeFillShift" style="font-size: 13px; color: #666; margin-bottom: 15px; text-align: center; padding: 10px; background: #f3f4f6; border-radius: 8px;"></div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 8px;">åŠ ç­æ™‚é–“</label>
                    <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
                        <select id="overtimeFillStart" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100px;"></select>
                        <span style="color: #666;">è‡³</span>
                        <select id="overtimeFillEnd" style="padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100px;"></select>
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 13px; color: #666; display: block; margin-bottom: 8px;">å‚™è¨»</label>
                    <input type="text" id="overtimeFillNote" placeholder="é¸å¡«ï¼Œå¯å¡«åŠ ç­åŸå› " style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeOvertimeFillModal()">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-confirm" onclick="submitSingleOvertime()">é€å‡ºç”³è«‹</button>
            </div>
        </div>
    </div>

    <!-- èˆŠçš„åŠ ç­å›å¡« Modal ä¿ç•™ä½†éš±è— -->
    <div class="modal-overlay" id="overtimeModal" style="display:none;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                â° å›å¡«ä¸ŠæœˆåŠ ç­æ™‚é–“
            </div>
            <div class="modal-content" style="padding: 15px;">
                <div style="background: #fef3c7; border-radius: 8px; padding: 12px; margin-bottom: 15px; font-size: 13px; color: #92400e;">
                    âš ï¸ è«‹æ–¼ <strong>5 è™Ÿå‰</strong>å®Œæˆå›å¡«ï¼Œé€¾æ™‚ä¸å€™ï¼
                </div>
                <div id="overtimeList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeOvertimeModal()">ç¨å¾Œå¡«å¯«</button>
                <button class="modal-btn modal-btn-confirm" onclick="submitOvertime()">ç¢ºèªé€å‡º</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============ è¨­å®šå€ ============
        const API_URL = 'https://script.google.com/macros/s/AKfycbya-cC6YfCCoySIBRc94JhDX17Nf8uq7j3KhI_B0WXlonanIJwemZycUOK8uHY-IipwgA/exec';
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();
        let holidays = [];
        let availableDates = {};
        let staffName = '';
        let currentEditingDate = null;
        let shifts = [];
        
        // åŠ ç­å›å¡«ç›¸é—œ
        let isOvertimeMode = false;  // æ˜¯å¦åœ¨å›å¡«æ¨¡å¼
        let lastMonthSchedules = {};  // ä¸Šæœˆæ’ç­è³‡æ–™
        let currentOvertimeDate = null;  // ç•¶å‰å›å¡«çš„æ—¥æœŸ

        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            staffName = urlParams.get('name') || urlParams.get('staff') || '';
            
            if (!staffName) {
                document.getElementById('staffNameDisplay').innerHTML = 'âš ï¸ è«‹å¾ç®¡ç†å“¡æä¾›çš„é€£çµé€²å…¥';
            } else {
                document.getElementById('staffNameDisplay').innerHTML = 
                    `<span class="staff-name">${staffName}</span> è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ`;
            }
            
            await loadShifts();
            holidays = await fetchHolidays(currentYear);
            
            // å„ªå…ˆå¾ API è¼‰å…¥å·²é€å‡ºçš„è³‡æ–™ï¼Œå¦å‰‡å¾ localStorage è¼‰å…¥è‰ç¨¿
            const loaded = await loadSavedAvailability();
            if (!loaded) {
                loadLocalData();
            }
            
            generateCalendar();
            updateStats();
            
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('mainContent').style.display = 'block';
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦å›å¡«åŠ ç­ï¼ˆ1-4è™ŸæœŸé–“ï¼‰
            if (staffName) {
                checkOvertimeReminder();
            }
        };
        
        // ============ åŠ ç­å›å¡«åŠŸèƒ½ ============
        
        async function checkOvertimeReminder() {
            const today = new Date();
            const dayOfMonth = today.getDate();
            
            // åªåœ¨ 1-5 è™Ÿé¡¯ç¤ºå›å¡«åŠŸèƒ½
            if (dayOfMonth > 5) return;
            
            // é¡¯ç¤ºå›å¡«æŒ‰éˆ•ï¼ˆéš¨æ™‚å¯ä»¥é»ï¼‰
            document.getElementById('overtimeEntryBtn').style.display = 'block';
            
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç¢ºèªéï¼ˆæœ¬æ¬¡ sessionï¼‰ï¼Œæ²’ç¢ºèªéæ‰å½ˆæé†’
            const confirmed = sessionStorage.getItem('overtimeReminderConfirmed');
            if (confirmed) return;
            
            // é¡¯ç¤ºæé†’ Modal
            document.getElementById('overtimeReminderModal').classList.add('show');
        }
        
        async function confirmOvertimeReminder() {
            document.getElementById('overtimeReminderModal').classList.remove('show');
            sessionStorage.setItem('overtimeReminderConfirmed', 'true');
            
            // é€²å…¥å›å¡«æ¨¡å¼
            await enterOvertimeMode();
        }
        
        async function enterOvertimeMode() {
            isOvertimeMode = true;
            
            // è¨ˆç®—ä¸Šå€‹æœˆ
            const today = new Date();
            let lastMonth = today.getMonth() - 1;
            let lastYear = today.getFullYear();
            if (lastMonth < 0) {
                lastMonth = 11;
                lastYear--;
            }
            
            // åˆ‡æ›åˆ°ä¸Šæœˆ
            currentYear = lastYear;
            currentMonth = lastMonth;
            
            // è¼‰å…¥ä¸Šæœˆæ’ç­è³‡æ–™
            await loadLastMonthSchedules();
            
            // é¡¯ç¤ºå›å¡«æ¨¡å¼æç¤ºæ¢å’Œè¿”å›æŒ‰éˆ•ï¼Œéš±è—æ­£å¸¸æ¨¡å¼æŒ‰éˆ•
            document.getElementById('overtimeModeBar').style.display = 'block';
            document.getElementById('overtimeEntryBtn').style.display = 'none';
            document.getElementById('overtimeExitBtn').style.display = 'block';
            document.getElementById('normalModeButtons').style.display = 'none';
            document.getElementById('staffNameDisplay').innerHTML = 
                `<span class="staff-name">${staffName}</span> é»é¸æ—¥æœŸå›å¡«<strong style="color:#f59e0b;">åŠ ç­æ™‚é–“</strong>`;
            
            // é‡æ–°ç”Ÿæˆæ—¥æ›†
            holidays = await fetchHolidays(currentYear);
            generateCalendar();
            updateStats();
        }
        
        function exitOvertimeMode() {
            isOvertimeMode = false;
            
            // åˆ‡æ›å›ç•¶æœˆ
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth();
            
            // éš±è—å›å¡«æ¨¡å¼æç¤ºæ¢å’Œè¿”å›æŒ‰éˆ•ï¼Œé¡¯ç¤ºæ­£å¸¸æ¨¡å¼æŒ‰éˆ•
            document.getElementById('overtimeModeBar').style.display = 'none';
            document.getElementById('overtimeExitBtn').style.display = 'none';
            document.getElementById('overtimeEntryBtn').style.display = 'block';
            document.getElementById('normalModeButtons').style.display = 'flex';
            document.getElementById('staffNameDisplay').innerHTML = 
                `<span class="staff-name">${staffName}</span> è«‹é»é¸<strong>å¯ä»¥ä¸Šç­</strong>çš„æ—¥æœŸ`;
            
            // é‡æ–°ç”Ÿæˆæ—¥æ›†
            fetchHolidays(currentYear).then(h => {
                holidays = h;
                generateCalendar();
                updateStats();
            });
        }
        
        async function loadLastMonthSchedules() {
            if (!API_URL) return;
            
            try {
                const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const res = await fetch(API_URL + '?action=getSchedules&month=' + monthStr);
                const data = await res.json();
                
                if (data.success && data.schedules) {
                    // éæ¿¾å‡ºè‡ªå·±çš„æ’ç­
                    lastMonthSchedules = {};
                    for (const dateStr in data.schedules) {
                        const mySchedule = data.schedules[dateStr].find(s => s.staffName === staffName);
                        if (mySchedule) {
                            lastMonthSchedules[dateStr] = mySchedule;
                        }
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥ä¸Šæœˆæ’ç­å¤±æ•—', e);
            }
        }
        
        function openOvertimeFillModal(dateStr) {
            currentOvertimeDate = dateStr;
            const date = new Date(dateStr);
            const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            
            document.getElementById('overtimeFillDate').textContent = `${dateStr} (é€±${dayOfWeek})`;
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ’ç­
            const schedule = lastMonthSchedules[dateStr];
            if (schedule) {
                const shift = shifts.find(s => s.id === schedule.shiftId);
                const shiftInfo = shift ? `${shift.name} (${shift.time})` : schedule.shiftId;
                document.getElementById('overtimeFillShift').innerHTML = `åŸç­åˆ¥ï¼š<strong>${shiftInfo}</strong>`;
            } else {
                document.getElementById('overtimeFillShift').innerHTML = `<strong style="color:#f59e0b;">è‡¨æ™‚ä¸Šç­</strong>ï¼ˆåŸæœ¬ç„¡æ’ç­ï¼‰`;
            }
            
            // ç”Ÿæˆæ™‚é–“é¸é …
            const startSelect = document.getElementById('overtimeFillStart');
            const endSelect = document.getElementById('overtimeFillEnd');
            
            let options = '<option value="">è«‹é¸æ“‡</option>';
            for (let h = 6; h <= 23; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const time = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    options += `<option value="${time}">${time}</option>`;
                }
            }
            
            startSelect.innerHTML = options;
            endSelect.innerHTML = options;
            
            document.getElementById('overtimeFillModal').classList.add('show');
        }
        
        function closeOvertimeFillModal() {
            document.getElementById('overtimeFillModal').classList.remove('show');
            document.getElementById('overtimeFillNote').value = '';
            currentOvertimeDate = null;
        }
        
        async function submitSingleOvertime() {
            const startTime = document.getElementById('overtimeFillStart').value;
            const endTime = document.getElementById('overtimeFillEnd').value;
            const note = document.getElementById('overtimeFillNote').value.trim();
            
            if (!startTime || !endTime) {
                showToast('è«‹é¸æ“‡åŠ ç­æ™‚é–“');
                return;
            }
            
            if (startTime >= endTime) {
                showToast('çµæŸæ™‚é–“å¿…é ˆå¤§æ–¼é–‹å§‹æ™‚é–“');
                return;
            }
            
            // å–å¾—åŸç­åˆ¥è³‡è¨Š
            const schedule = lastMonthSchedules[currentOvertimeDate];
            let shiftName = 'è‡¨æ™‚ä¸Šç­';
            if (schedule) {
                const shift = shifts.find(s => s.id === schedule.shiftId);
                shiftName = shift ? shift.name : schedule.shiftId;
            }
            
            showToast('ğŸ“¤ æ­£åœ¨é€å‡º...');
            
            try {
                const payload = {
                    staff: staffName,
                    submissions: [{
                        date: currentOvertimeDate,
                        shiftName: shiftName,
                        startTime: startTime,
                        endTime: endTime,
                        note: note
                    }]
                };
                
                const res = await fetch(API_URL + '?action=submitOvertime&data=' + encodeURIComponent(JSON.stringify(payload)));
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… åŠ ç­ç”³è«‹å·²é€å‡ºï¼');
                    closeOvertimeFillModal();
                } else {
                    showToast('âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
                }
            } catch (e) {
                console.error('é€å‡ºå¤±æ•—', e);
                showToast('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        }
        
        // ä¿ç•™èˆŠçš„å‡½æ•¸ï¼ˆå‘å¾Œç›¸å®¹ï¼‰
        let pendingOvertimes = [];
        
        function showOvertimeModal(year, month) {
            const container = document.getElementById('overtimeList');
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            
            let html = `<p style="font-size: 13px; color: #666; margin-bottom: 12px;">æ‚¨åœ¨ ${year}/${month} æœˆæœ‰ <strong>${pendingOvertimes.length}</strong> å¤©åŠ ç­å°šæœªå¡«å¯«æ™‚é–“ï¼š</p>`;
            
            pendingOvertimes.forEach((record, index) => {
                const date = new Date(record.date);
                const dayOfWeek = dayNames[date.getDay()];
                
                html += `<div class="overtime-item" style="background:#f9fafb;border-radius:8px;padding:12px;margin-bottom:10px;border-left:3px solid #f59e0b;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:8px;">
                        ${record.date} (${dayOfWeek}) - ${record.shiftName}
                    </div>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <span style="font-size:12px;color:#666;">åŠ ç­æ™‚é–“ï¼š</span>
                        <input type="time" class="overtime-start" data-index="${index}" 
                            value="${record.suggestedStart || ''}" 
                            style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                        <span>åˆ°</span>
                        <input type="time" class="overtime-end" data-index="${index}" 
                            value="${record.suggestedEnd || ''}" 
                            style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                    </div>
                    <div style="margin-top:8px;">
                        <label style="font-size:12px;color:#666;display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" class="no-overtime" data-index="${index}" 
                                onchange="toggleOvertimeInputs(this, ${index})">
                            ç•¶å¤©ç„¡åŠ ç­
                        </label>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            document.getElementById('overtimeModal').classList.add('show');
        }
        
        function toggleOvertimeInputs(checkbox, index) {
            const startInput = document.querySelector(`.overtime-start[data-index="${index}"]`);
            const endInput = document.querySelector(`.overtime-end[data-index="${index}"]`);
            if (startInput && endInput) {
                startInput.disabled = checkbox.checked;
                endInput.disabled = checkbox.checked;
                if (checkbox.checked) {
                    startInput.value = '';
                    endInput.value = '';
                }
            }
        }
        
        function closeOvertimeModal() {
            document.getElementById('overtimeModal').classList.remove('show');
        }
        
        async function submitOvertime() {
            const submissions = [];
            let hasError = false;
            
            pendingOvertimes.forEach((record, index) => {
                const noOvertime = document.querySelector(`.no-overtime[data-index="${index}"]`)?.checked;
                const startTime = document.querySelector(`.overtime-start[data-index="${index}"]`)?.value;
                const endTime = document.querySelector(`.overtime-end[data-index="${index}"]`)?.value;
                
                if (noOvertime) {
                    submissions.push({
                        date: record.date,
                        noOvertime: true
                    });
                } else if (startTime && endTime) {
                    submissions.push({
                        date: record.date,
                        startTime,
                        endTime,
                        noOvertime: false
                    });
                } else {
                    hasError = true;
                }
            });
            
            if (hasError) {
                showToast('è«‹å¡«å¯«æ‰€æœ‰åŠ ç­æ™‚é–“æˆ–å‹¾é¸ã€Œç„¡åŠ ç­ã€');
                return;
            }
            
            // é€å‡ºåˆ° API
            try {
                const payload = {
                    staff: staffName,
                    submissions
                };
                const res = await fetch(API_URL + '?action=submitOvertime&data=' + encodeURIComponent(JSON.stringify(payload)));
                const data = await res.json();
                
                if (data.success) {
                    showToast('âœ… åŠ ç­æ™‚é–“å·²é€å‡ºï¼Œç­‰å¾…å¯©æ ¸');
                    pendingOvertimes = [];
                    localStorage.removeItem('pendingOvertimes_' + staffName);
                    closeOvertimeModal();
                } else {
                    showToast('âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
                }
            } catch (e) {
                // å„²å­˜åˆ° localStorage ä½œç‚ºå‚™ä»½
                localStorage.setItem('overtimeSubmissions_' + staffName, JSON.stringify(submissions));
                showToast('âš ï¸ ç¶²è·¯ç•°å¸¸ï¼Œå·²æš«å­˜æœ¬åœ°ï¼Œè«‹ç¨å¾Œé‡è©¦');
                closeOvertimeModal();
            }
        }

        async function loadShifts() {
            if (!API_URL) return;
            try {
                const res = await fetch(API_URL + '?action=getShifts');
                const data = await res.json();
                if (data.success && data.shifts) { shifts = data.shifts; }
            } catch (e) {
                shifts = [
                    { id: 'shift1', name: 'åˆç­', time: '12:00-18:00', color: '#9fcccc' },
                    { id: 'shift2', name: 'æ™šç­', time: '18:00-22:00', color: '#a78bfa' }
                ];
            }
        }

        async function fetchHolidays(year) {
            // ç›´æ¥ä½¿ç”¨ ruyut çš„ Taiwan Calendar APIï¼ˆå… CORSã€å¿«é€Ÿç©©å®šï¼‰
            try {
                const res = await fetch('https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/' + year + '.json');
                const data = await res.json();
                if (data && Array.isArray(data)) {
                    const holidays = [];
                    data.forEach(record => {
                        // åªå–æœ‰ç¯€æ—¥åç¨±çš„å‡æ—¥ï¼ˆæ’é™¤ä¸€èˆ¬é€±æœ«ï¼‰
                        if (record.isHoliday && record.description && record.description.trim() !== '') {
                            // è½‰æ›æ—¥æœŸæ ¼å¼ 20260101 â†’ 2026-01-01
                            const d = record.date;
                            const formattedDate = d.substring(0, 4) + '-' + d.substring(4, 6) + '-' + d.substring(6, 8);
                            holidays.push({ date: formattedDate, name: record.description });
                        }
                    });
                    console.log('å·²è¼‰å…¥ ' + year + ' å¹´å‡æ—¥ï¼š', holidays.length + ' ç­†');
                    return holidays;
                }
            } catch (e) {
                console.error('è¼‰å…¥å‡æ—¥å¤±æ•—', e);
            }
            return [];
        }

        function generateCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            document.getElementById('monthDisplay').textContent = `${currentYear} å¹´ ${currentMonth + 1} æœˆ`;
            
            const firstDayOfWeek = firstDay.getDay();
            const totalCells = Math.ceil((firstDayOfWeek + lastDay.getDate()) / 7) * 7;
            const calendarDays = [];
            let dayCounter = 1 - firstDayOfWeek;
            for (let i = 0; i < totalCells; i++) { calendarDays.push(new Date(currentYear, currentMonth, dayCounter++)); }
            
            const body = document.getElementById('calendarBody');
            body.innerHTML = '';
            
            for (let week = 0; week < calendarDays.length / 7; week++) {
                const row = document.createElement('div');
                row.className = 'week-row';
                row.innerHTML = `<div class="week-label">W${week + 1}</div>`;
                for (let day = 0; day < 7; day++) { row.appendChild(createDayCell(calendarDays[week * 7 + day])); }
                body.appendChild(row);
            }
        }

        function createDayCell(date) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            
            const isCurrentMonth = date.getMonth() === currentMonth;
            const dayOfWeek = date.getDay();
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            const dateStr = formatDate(date);
            const isToday = dateStr === formatDate(new Date());
            const holidayInfo = holidays.find(h => h.date === dateStr);
            
            if (!isCurrentMonth) cell.style.opacity = '0.5';
            if (holidayInfo) cell.classList.add('holiday');
            else if (isWeekend) cell.classList.add('weekend');
            if (isToday) cell.classList.add('today');
            
            // å›å¡«æ¨¡å¼ä¸‹çš„é¡¯ç¤º
            if (isOvertimeMode) {
                const mySchedule = lastMonthSchedules[dateStr];
                let html = `<div class="day-header"><div class="day-number">${date.getDate()}</div></div>`;
                
                if (holidayInfo) {
                    html += `<span class="status-label holiday-label">${holidayInfo.name}</span>`;
                } else if (isWeekend && !mySchedule) {
                    html += `<span class="status-label weekend-label">ä¼‘</span>`;
                }
                
                if (mySchedule) {
                    // æœ‰æ’ç­ï¼šé¡¯ç¤ºç­åˆ¥
                    const shift = shifts.find(s => s.id === mySchedule.shiftId);
                    const shiftName = shift ? shift.name : mySchedule.shiftId;
                    cell.style.background = '#fef3c7';
                    cell.style.cursor = 'pointer';
                    html += `<div style="font-size:11px;font-weight:500;color:#92400e;margin-top:2px;">${shiftName}</div>`;
                    html += `<div style="font-size:10px;color:#666;">é»æ“Šå›å¡«åŠ ç­</div>`;
                } else if (isCurrentMonth && !holidayInfo) {
                    // ç„¡æ’ç­ï¼šä¹Ÿå¯ä»¥é»æ“Šå¡«è‡¨æ™‚ä¸Šç­
                    cell.style.cursor = 'pointer';
                    html += `<div style="font-size:10px;color:#999;margin-top:4px;">é»æ“Šå¡«è‡¨æ™‚åŠ ç­</div>`;
                }
                
                cell.innerHTML = html;
                if (isCurrentMonth) {
                    cell.onclick = () => openOvertimeFillModal(dateStr);
                }
                return cell;
            }
            
            // æ­£å¸¸æ¨¡å¼ä¸‹çš„é¡¯ç¤º
            const availData = availableDates[dateStr];
            const isAvailable = availData && (availData.allDay || (availData.shifts && availData.shifts.length > 0) || availData.customTime);
            if (isAvailable) cell.classList.add('available');
            
            let html = `<div class="day-header"><div class="day-number">${date.getDate()}</div></div>`;
            if (holidayInfo) html += `<span class="status-label holiday-label">${holidayInfo.name}</span>`;
            else if (isWeekend) html += `<span class="status-label weekend-label">ä¼‘</span>`;
            
            if (availData) {
                html += '<div class="shift-badges">';
                if (availData.allDay) {
                    html += `<div class="available-icon">âœ“</div>`;
                } else {
                    if (availData.shifts && availData.shifts.length > 0) {
                        availData.shifts.forEach(shiftId => {
                            const shift = shifts.find(s => s.id === shiftId);
                            if (shift) html += `<span class="shift-badge" style="background: ${shift.color}; color: white;">${shift.name}</span>`;
                        });
                    }
                    if (availData.customTime) {
                        html += `<span class="shift-badge" style="background: #999; color: white;">${availData.customTime}</span>`;
                    }
                }
                html += '</div>';
            }
            
            cell.innerHTML = html;
            if (isCurrentMonth) cell.onclick = () => openShiftModal(dateStr);
            return cell;
        }

        function renderShiftOptions() {
            const container = document.getElementById('shiftOptionsContainer');
            let html = `
                <div class="shift-option" id="allDayOption" onclick="toggleShiftOption('allDay')">
                    <div class="shift-option-checkbox"></div>
                    <div class="shift-option-label">
                        <div class="shift-option-title">âœ… æ•´å¤©å¯ä¸Šç­</div>
                        <div class="shift-option-time">å…¨å¤©éƒ½å¯ä»¥æ’ç­</div>
                    </div>
                </div>
            `;
            shifts.forEach(shift => {
                html += `
                    <div class="shift-option" id="shift_${shift.id}_option" onclick="toggleShiftOption('${shift.id}')" style="border-left: 4px solid ${shift.color};">
                        <div class="shift-option-checkbox"></div>
                        <div class="shift-option-label">
                            <div class="shift-option-title">${shift.name}</div>
                            <div class="shift-option-time">${shift.time}</div>
                        </div>
                        <div class="shift-option-color" style="background: ${shift.color}; width: 20px; height: 20px; border-radius: 4px;"></div>
                    </div>
                `;
            });
            // å…¶ä»–ç­åˆ¥ï¼ˆè‡ªè¨‚æ™‚é–“ï¼‰
            html += `
                <div class="shift-option" id="customShiftOption" onclick="toggleShiftOption('custom')" style="border-left: 4px solid #999;">
                    <div class="shift-option-checkbox"></div>
                    <div class="shift-option-label">
                        <div class="shift-option-title">ğŸ• å…¶ä»–ç­åˆ¥</div>
                        <div class="shift-option-time">è‡ªè¨‚å¯ä¸Šç­æ™‚é–“</div>
                    </div>
                </div>
                <div class="custom-shift-inputs" id="customShiftInputs">
                    <div class="custom-time-row">
                        <input type="time" class="custom-time-input" id="customStartTime" value="12:00">
                        <span class="custom-time-separator">ï½</span>
                        <input type="time" class="custom-time-input" id="customEndTime" value="18:00">
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function openShiftModal(dateStr) {
            currentEditingDate = dateStr;
            const date = new Date(dateStr);
            const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
            document.getElementById('shiftModalDate').textContent = `${dateStr} (é€±${dayOfWeek})`;
            renderShiftOptions();
            
            const data = availableDates[dateStr] || { allDay: false, shifts: [], customTime: '' };
            if (data.allDay) document.getElementById('allDayOption').classList.add('selected');
            if (data.shifts) {
                data.shifts.forEach(shiftId => {
                    const el = document.getElementById(`shift_${shiftId}_option`);
                    if (el) el.classList.add('selected');
                });
            }
            // æ¢å¾©è‡ªè¨‚æ™‚é–“
            if (data.customTime) {
                document.getElementById('customShiftOption').classList.add('selected');
                document.getElementById('customShiftInputs').classList.add('show');
                const [start, end] = data.customTime.split('-');
                if (start) document.getElementById('customStartTime').value = start;
                if (end) document.getElementById('customEndTime').value = end;
            }
            document.getElementById('shiftModal').classList.add('show');
        }

        function closeShiftModal() {
            document.getElementById('shiftModal').classList.remove('show');
            currentEditingDate = null;
        }

        function toggleShiftOption(optionId) {
            if (optionId === 'allDay') {
                const option = document.getElementById('allDayOption');
                if (!option.classList.contains('selected')) {
                    // å–æ¶ˆå…¶ä»–é¸é …
                    shifts.forEach(shift => {
                        const el = document.getElementById(`shift_${shift.id}_option`);
                        if (el) el.classList.remove('selected');
                    });
                    document.getElementById('customShiftOption').classList.remove('selected');
                    document.getElementById('customShiftInputs').classList.remove('show');
                }
                option.classList.toggle('selected');
            } else if (optionId === 'custom') {
                // è‡ªè¨‚ç­åˆ¥
                document.getElementById('allDayOption').classList.remove('selected');
                const option = document.getElementById('customShiftOption');
                const inputs = document.getElementById('customShiftInputs');
                option.classList.toggle('selected');
                if (option.classList.contains('selected')) {
                    inputs.classList.add('show');
                } else {
                    inputs.classList.remove('show');
                }
            } else {
                document.getElementById('allDayOption').classList.remove('selected');
                const option = document.getElementById(`shift_${optionId}_option`);
                if (option) option.classList.toggle('selected');
            }
        }

        function confirmShiftSelection() {
            const allDaySelected = document.getElementById('allDayOption').classList.contains('selected');
            const customSelected = document.getElementById('customShiftOption').classList.contains('selected');
            const selectedShifts = [];
            shifts.forEach(shift => {
                const el = document.getElementById(`shift_${shift.id}_option`);
                if (el && el.classList.contains('selected')) selectedShifts.push(shift.id);
            });
            
            // å–å¾—è‡ªè¨‚æ™‚é–“
            let customTime = '';
            if (customSelected) {
                const startTime = document.getElementById('customStartTime').value;
                const endTime = document.getElementById('customEndTime').value;
                if (startTime && endTime) {
                    customTime = `${startTime}-${endTime}`;
                }
            }
            
            if (allDaySelected || selectedShifts.length > 0 || customTime) {
                availableDates[currentEditingDate] = { 
                    allDay: allDaySelected, 
                    shifts: selectedShifts,
                    customTime: customTime
                };
                let msg = 'âœ… å·²æ¨™è¨˜å¯ä¸Šç­: ';
                if (allDaySelected) msg += 'æ•´å¤©';
                else {
                    const parts = [];
                    if (selectedShifts.length > 0) {
                        parts.push(selectedShifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+'));
                    }
                    if (customTime) parts.push(customTime);
                    msg += parts.join(', ');
                }
                showToast(msg);
            } else {
                delete availableDates[currentEditingDate];
                showToast('âœ“ å·²å–æ¶ˆæ¨™è¨˜');
            }
            
            closeShiftModal();
            saveLocalData();
            generateCalendar();
            updateStats();
        }

        function updateStats() {
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            let workDays = 0, holidayCount = 0, availableCount = 0;
            
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const date = new Date(currentYear, currentMonth, d);
                const dateStr = formatDate(date);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const holidayInfo = holidays.find(h => h.date === dateStr);
                
                if (holidayInfo) holidayCount++;
                else if (!isWeekend) {
                    workDays++;
                    const data = availableDates[dateStr];
                    if (data && (data.allDay || (data.shifts && data.shifts.length > 0) || data.customTime)) availableCount++;
                }
            }
            
            document.getElementById('availableCount').textContent = availableCount;
            document.getElementById('holidayCount').textContent = holidayCount;
            document.getElementById('unmarkedCount').textContent = workDays - availableCount;
        }

        async function previousMonth() {
            // å›å¡«æ¨¡å¼åªèƒ½çœ‹ä¸Šæœˆ
            if (isOvertimeMode) {
                showToast('âš ï¸ å›å¡«æ¨¡å¼åªèƒ½æ“ä½œä¸Šæœˆ');
                return;
            }
            showToast('â³ è¼‰å…¥ä¸­...');
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; holidays = await fetchHolidays(currentYear); }
            generateCalendar(); 
            updateStats();
        }

        async function nextMonth() {
            // å›å¡«æ¨¡å¼åªèƒ½çœ‹ä¸Šæœˆ
            if (isOvertimeMode) {
                showToast('âš ï¸ å›å¡«æ¨¡å¼åªèƒ½æ“ä½œä¸Šæœˆ');
                return;
            }
            showToast('â³ è¼‰å…¥ä¸­...');
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; holidays = await fetchHolidays(currentYear); }
            generateCalendar(); 
            updateStats();
        }

        function saveLocalData() { localStorage.setItem(`available_${staffName}`, JSON.stringify(availableDates)); }
        function loadLocalData() { const saved = localStorage.getItem(`available_${staffName}`); if (saved) availableDates = JSON.parse(saved); }
        
        // å¾ API è¼‰å…¥å·²é€å‡ºçš„å¯æ’ç­æ™‚é–“
        async function loadSavedAvailability() {
            if (!API_URL || !staffName) return false;
            
            try {
                const res = await fetch(API_URL + '?action=getStaff');
                const data = await res.json();
                
                if (!data.success || !data.staff) return false;
                
                // æ‰¾åˆ°è‡ªå·±çš„è³‡æ–™
                const myData = data.staff.find(s => s.name === staffName);
                if (!myData || !myData.availability) return false;
                
                // è§£æ availability æ–‡å­—æ ¼å¼
                // æ ¼å¼: "2026-02-01(æ•´å¤©)\n2026-02-02(6åˆç­+8æ•´å¤©ç­)\n2026-02-03(6åˆç­, æ—©ä¸Š10é»)"
                const lines = myData.availability.split('\n').filter(line => line.trim());
                if (lines.length === 0) return false;
                
                // å–å¾—æ‰€æœ‰ç­åˆ¥åç¨±ï¼ˆç”¨æ–¼åˆ¤æ–·æ˜¯ç­åˆ¥é‚„æ˜¯è‡ªå®šç¾©æ™‚é–“ï¼‰
                const shiftNames = shifts.map(s => s.name);
                
                availableDates = {};
                
                lines.forEach(line => {
                    // è§£ææ ¼å¼: "2026-02-01(æ•´å¤©)" æˆ– "2026-02-01(6åˆç­+8æ•´å¤©ç­, æ—©ä¸Š10é»)"
                    const match = line.match(/^(\d{4}-\d{2}-\d{2})\((.+)\)$/);
                    if (!match) return;
                    
                    const dateStr = match[1];
                    const content = match[2];
                    
                    if (content === 'æ•´å¤©') {
                        availableDates[dateStr] = { allDay: true, shifts: [], customTime: '' };
                    } else {
                        // è§£æç­åˆ¥å’Œè‡ªå®šç¾©æ™‚é–“
                        // æ ¼å¼å¯èƒ½æ˜¯: "6åˆç­+8æ•´å¤©ç­, æ—©ä¸Š10é»" æˆ– "6åˆç­+8æ•´å¤©ç­" æˆ– "æ—©ä¸Š10é»"
                        const parts = content.split(', ');
                        
                        let shiftIds = [];
                        let customTime = '';
                        
                        parts.forEach(part => {
                            // æª¢æŸ¥æ˜¯å¦åŒ…å«ç­åˆ¥ï¼ˆç”¨+åˆ†å‰²å¾Œçœ‹æ˜¯å¦æœ‰å·²çŸ¥ç­åˆ¥ï¼‰
                            const possibleShifts = part.split('+');
                            const isShiftPart = possibleShifts.some(name => 
                                shiftNames.includes(name.trim())
                            );
                            
                            if (isShiftPart) {
                                // é€™æ˜¯ç­åˆ¥éƒ¨åˆ†
                                possibleShifts.forEach(name => {
                                    const shift = shifts.find(s => s.name === name.trim());
                                    if (shift) shiftIds.push(shift.id);
                                });
                            } else {
                                // é€™æ˜¯è‡ªå®šç¾©æ™‚é–“
                                customTime = part.trim();
                            }
                        });
                        
                        availableDates[dateStr] = { 
                            allDay: false, 
                            shifts: shiftIds, 
                            customTime: customTime 
                        };
                    }
                });
                
                // é¡¯ç¤ºå·²è¼‰å…¥æç¤º
                if (Object.keys(availableDates).length > 0) {
                    showToast(`âœ… å·²è¼‰å…¥å…ˆå‰é€å‡ºçš„è³‡æ–™ï¼ˆ${Object.keys(availableDates).length} å¤©ï¼‰`);
                }
                
                return Object.keys(availableDates).length > 0;
            } catch (e) {
                console.error('è¼‰å…¥å·²å­˜è³‡æ–™å¤±æ•—', e);
                return false;
            }
        }

        function clearAll() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ¨™è¨˜å—ï¼Ÿ')) return;
            availableDates = {};
            saveLocalData();
            generateCalendar();
            updateStats();
            showToast('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ¨™è¨˜');
        }

        function showConfirmModal() {
            // åªé¡¯ç¤ºç•¶å‰æœˆä»½çš„è³‡æ–™
            const currentMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            const availableList = Object.keys(availableDates)
                .filter(dateStr => {
                    // éæ¿¾ç•¶æœˆè³‡æ–™
                    if (!dateStr.startsWith(currentMonthPrefix)) return false;
                    const data = availableDates[dateStr];
                    return data && (data.allDay || (data.shifts && data.shifts.length > 0) || data.customTime);
                })
                .sort()
                .map(dateStr => {
                    const date = new Date(dateStr);
                    const dayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
                    const data = availableDates[dateStr];
                    let shiftDisplay = 'æ•´å¤©';
                    if (!data.allDay) {
                        const parts = [];
                        if (data.shifts && data.shifts.length > 0) {
                            parts.push(data.shifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+'));
                        }
                        if (data.customTime) {
                            parts.push(data.customTime);
                        }
                        if (parts.length > 0) shiftDisplay = parts.join(', ');
                    }
                    return { date: dateStr, dayOfWeek, shiftDisplay };
                });
            
            document.getElementById('modalSummary').textContent = `${currentYear}å¹´${currentMonth + 1}æœˆ å…± ${availableList.length} å¤©å¯ä»¥ä¸Šç­`;
            document.getElementById('dateList').innerHTML = availableList.length === 0 
                ? '<div style="text-align: center; padding: 20px; color: #666;">å°šæœªæ¨™è¨˜ä»»ä½•å¯ä¸Šç­çš„æ—¥æœŸ</div>'
                : availableList.map(item => `<div class="date-item">${item.date} (é€±${item.dayOfWeek}) - ${item.shiftDisplay}</div>`).join('');
            
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeConfirmModal() { document.getElementById('modalOverlay').classList.remove('show'); }

        async function confirmSubmit() {
            closeConfirmModal();
            if (!API_URL) { showToast('âŒ API æœªè¨­å®š'); return; }
            if (!staffName) { showToast('âŒ è«‹å¾æ­£ç¢ºçš„é€£çµé€²å…¥'); return; }
            
            // åªé€å‡ºç•¶å‰æœˆä»½çš„è³‡æ–™
            const currentMonthPrefix = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            
            // ç”¨æ›è¡Œåˆ†éš”æ¯å€‹æ—¥æœŸ
            let availabilityArr = [];
            Object.keys(availableDates).sort().forEach(dateStr => {
                // éæ¿¾ç•¶æœˆè³‡æ–™
                if (!dateStr.startsWith(currentMonthPrefix)) return;
                
                const data = availableDates[dateStr];
                if (data && (data.allDay || (data.shifts && data.shifts.length > 0) || data.customTime)) {
                    if (data.allDay) {
                        availabilityArr.push(`${dateStr}(æ•´å¤©)`);
                    } else {
                        const parts = [];
                        if (data.shifts && data.shifts.length > 0) {
                            parts.push(data.shifts.map(id => shifts.find(s => s.id === id)?.name || id).join('+'));
                        }
                        if (data.customTime) {
                            parts.push(data.customTime);
                        }
                        availabilityArr.push(`${dateStr}(${parts.join(', ')})`);
                    }
                }
            });
            const availabilityStr = availabilityArr.join('\n');
            
            showToast('ğŸ“¤ æ­£åœ¨é€å‡º...');
            
            try {
                // ä½¿ç”¨ GET + URL åƒæ•¸æ–¹å¼é¿å… CORS å•é¡Œ
                const totalDays = availabilityArr.length;
                const payload = encodeURIComponent(JSON.stringify({ 
                    name: staffName, 
                    availability: availabilityStr,
                    totalDays: totalDays
                }));
                const res = await fetch(API_URL + '?action=updateAvailability&data=' + payload);
                const data = await res.json();
                showToast(data.success ? 'âœ… å·²é€å‡ºï¼' : 'âŒ é€å‡ºå¤±æ•—ï¼š' + (data.error || ''));
            } catch (e) {
                console.error('é€å‡ºå¤±æ•—', e);
                showToast('âŒ é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
            }
        }

        function formatDate(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
